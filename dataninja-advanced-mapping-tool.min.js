/*! dataninja-advanced-mapping-tool 22-11-2014 */
mapConfig&&(mapConfig.viewTypes={table:function(a,b,c,d){if(!a)return"";var e,f={include:[],exclude:[],bold:function(){return!1},filter:function(){return!0},groups:d||{}},b=b||{},c=c||function(a,b){return _.isNumber(b)?d3.format(",d")(b)||d3.format(",.2f")(b):b},g="",h="";_.defaults(b,f);for(e in a)if(_.has(a,e)&&!(b.include.length&&!_.contains(b.include,e)||b.exclude.length&&_.contains(b.exclude,e)||!b.filter(e,a[e]))){var i=c(e,a[e]),j=b.bold(e,a[e]),k=_.has(b.groups,e);k&&b.groups[e]!=g&&(g=b.groups[e],h+='<tr class="first-level group"><td colspan="2">'+g+"</td></tr>"),h+='<tr class="'+(k?"second-level":"first-level")+'"><td class="table-key">'+(j?"<b>"+e+"</b>":e)+'</td><td class="table-value">'+(j?"<b>"+i+"</b>":i)+"</td></tr>"}return h}}),function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){for(var d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){var c=b.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=s[c].filter(function(a){return a.active})[0],f=d.style.default;return f.fillColor=a(b.properties.data[e.name][e.column],e.bins,e.palette),f}function c(a){var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=s[d].filter(function(a){return a.active})[0],g=e.style.highlight,h=c.data[f.name][f.column];b.selected||b.setStyle(g),_.has(m,"label")&&m.label.active&&($.setContent(c[q[d].label]+"<br>"+f.label+": "+f.formatter(f.column,h)),$.setLatLng(b.getBounds().getCenter()),x.showLabel($))}function d(a){{var b=a.target,c=b.feature.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||Z.eachLayer(function(a){a.selected||Z.resetStyle(a)}),_.has(m,"label")&&m.label.active&&$.close()}function e(a,b){m.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;Z.eachLayer(function(a){a.selected=!1,Z.resetStyle(a)}),b.selected=!0,b.setStyle(e),v.i=b.feature.properties[q[v.dl].id],N&&N.isAdded&&N.removeFrom(x),H.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){b.on({mouseover:c,mouseout:d,click:e})}function g(a){m.debug&&console.log("joinDataFunction",arguments);for(var b,c,d=0;d<q[a].resource.length;d++){b=q[a].resource[d].properties[q[a].id],q[a].resource[d].properties.data={};for(var e=0;e<s[a].length;e++){s[a][e].active=!e;for(var f=0;f<s[a][e].resource.length;f++){var c=s[a][e].resource[f][s[a][e].id];if(c==b){q[a].resource[d].properties.data[s[a][e].name]=s[a][e].resource[f];for(var g in q[a].resource[d].properties.data[s[a][e].name])_.has(q[a].resource[d].properties.data[s[a][e].name],g)&&(q[a].resource[d].properties.data[s[a][e].name][g]=s[a][e].parse(g,q[a].resource[d].properties.data[s[a][e].name][g]));q[a].resource[d].properties._layer=a}}}d3.keys(q[a].resource[d].properties.data).length||(q[a].resource.splice(d,1),d--)}}function h(a){m.debug&&console.log("binDataFunction",arguments);var b=s[a].filter(function(a){return a.active})[0],c=(m.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],b.resource.map(function(a){return a[b.column]})),d=new geostats(c);c.length>3?b.binsNum>c.length&&(b.binsNum=c.length-1):b.binsNum=3,bins=d.getJenks(b.binsNum);var e=_.uniq(bins);b.binsNum>3&&e.length<bins.length&&(b.binsNum=e.length-1,bins=d.getJenks(b.binsNum)),b.bins=bins.map(function(a){return parseFloat(a)||a}),b.ranges=d.ranges,X.update(a)}function i(a,b){m.debug&&console.log("loadDataFunction",arguments);var c,d,f,i=m.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],k=m.dataSets.filter(function(b){return b.schema.layer===a});if(d3.selectAll("nav#geomenu-ui a").classed("active",!1),d3.select("nav#geomenu-ui a#"+a).classed("active",!0),d3.selectAll("nav#datamenu-ui a").classed("active",!1),d3.select("nav#datamenu-ui a#"+(b||k[0].schema.name)).classed("active",!0),d3.select("nav#datamenu-ui select").attr("disabled",null),v.dl=a,Z.clearLayers(),m.debug&&console.log("geoLayer",i),m.debug&&console.log("dataSets",k),q[a].resource)h(a),Z.addData(q[a].resource),delete v.i,N&&N.isAdded&&N.removeFrom(x),X.update(a),H.update();else{x.spin(!0),f=queue(),c=i.url.call(i,a,v.t?v.tl:void 0,v.t||void 0),f.defer(d3[i.format],c),m.debug&&console.log("geoPath",c);for(var l=0;l<k.length;l++)d=k[l].url.call(k[l],a,v.t?r[v.tl].id:void 0,v.t||void 0),f.defer(d3[k[l].format],d),m.debug&&console.log("dataPath",l,d);f.await(function(b,c){m.debug&&console.log("await",arguments),q[a].resource=i.transform(c);for(var d=2;d<arguments.length;d++)s[a][d-2].resource=k[d-2].transform(arguments[d]);x.spin(!1),g(a),h(a),Z.addData(q[a].resource),j||(j=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),v.t&&x.fitBounds(Z.getBounds()),v.i&&Z.eachLayer(function(b){b.feature.properties[q[a].id]==v.i&&e(null,b)})})}}var j,k,l,m=mapConfig;if(_.has(m,"language")){var n;switch(m.language){case"it":n=d3.locale({decimal:",",thousands:".",grouping:[3],currency:["€ ",""],dateTime:"%a %b %e %X %Y",date:"%d/%m/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"],shortDays:["Dom","Lun","Mar","Mer","Gio","Ven","Sab"],months:["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],shortMonths:["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"]});break;default:n=d3.locale()}d3.format=n.numberFormat,d3.time.format=n.timeFormat}for(_.has(m,"analytics")&&m.analytics.active&&(!function(a,b,c,d,e,f,g){a.GoogleAnalyticsObject=e,a[e]=a[e]||function(){(a[e].q=a[e].q||[]).push(arguments)},a[e].l=1*new Date,f=b.createElement(c),g=b.getElementsByTagName(c)[0],f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create",m.analytics.ua||"","auto"),ga("send","pageview")),k=0;k<m.geoLayers.length;k++)_.has(m.geoTypes[m.geoLayers[k].type],"options")&&(m.geoLayers[k].options=m.geoLayers[k].options||{},_.defaults(m.geoLayers[k].options,m.geoTypes[m.geoLayers[k].type].options)),_.has(m.geoTypes[m.geoLayers[k].type],"style")&&(m.geoLayers[k].style=m.geoLayers[k].style||{"default":{},highlight:{},selected:{}},_.defaults(m.geoLayers[k].style.default,m.geoTypes[m.geoLayers[k].type].style.default),_.defaults(m.geoLayers[k].style.highlight,m.geoTypes[m.geoLayers[k].type].style.highlight),_.defaults(m.geoLayers[k].style.selected,m.geoTypes[m.geoLayers[k].type].style.selected)),_.defaults(m.geoLayers[k],m.geoTypes[m.geoLayers[k].type]),_.defaults(m.geoLayers[k],m.geoSources[m.geoLayers[k].source]);for(m.geoLayers=_.where(m.geoLayers,{active:!0}),k=0;k<m.dataSets.length;k++)_.defaults(m.dataSets[k],m.dataTypes[m.dataSets[k].type]),_.defaults(m.dataSets[k],m.dataSources[m.dataSets[k].source]);if(m.dataSets=_.filter(m.dataSets,function(a){return _.has(a,"schema")&&_.has(a.schema,"layer")&&_.contains(_.map(m.geoLayers,function(a){return _.has(a,"schema")?a.schema.name:void 0}),a.schema.layer)}),_.has(m,"infowindow")&&m.infowindow.active&&_.has(m.infowindow,"downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)m.infowindow.downloads.files[k].active&&_.defaults(m.infowindow.downloads.files[k],m.dataSources[m.infowindow.downloads.files[k].source]);_.has(m,"pointsSet")&&m.pointsSet.active&&_.defaults(m.pointsSet,m.dataSources[m.pointsSet.source]),m.debug&&console.log("$",m);var o;_.has(m,"urlShortener")&&m.urlShortener.active&&(o=yourls.connect(m.urlShortener.url.call(m.urlShortener),{signature:m.urlShortener.signature})),m.debug&&console.log("dtnj",o);var p={},q={};for(k=0;k<m.geoLayers.length;k++)"vector"===m.geoLayers[k].type&&(p[m.geoLayers[k].schema.name]={id:m.geoLayers[k].schema.id,label:m.geoLayers[k].schema.label||m.geoLayers[k].schema.id,resource:null,list:[]});m.debug&&console.log("defaultGeo",p);var r={},s={};for(k=0;k<m.dataSets.length;k++){var t=m.dataSets[k];if(r[t.schema.name]={name:t.schema.name||_.uniqueId("dataset-"),layer:t.schema.layer,id:t.schema.id,groups:{},columns:_.has(t.schema,"menu")&&t.schema.menu.length?t.schema.menu.map(function(a){return a.column}):null,labels:_.has(t.schema,"menu")&&t.schema.menu.length?t.schema.menu.map(function(a){return a.label||a.column}):null,descriptions:_.has(t.schema,"menu")&&t.schema.menu.length?t.schema.menu.map(function(a){return a.description||t.schema.description||(a.label?a.label+">"+a.column:a.column)}):null,resourceId:t.resourceId,palette:t.palette||"Reds",transform:t.transform||function(a,b){return b},resource:null,binsNums:_.has(t.schema,"menu")&&t.schema.menu.length?t.schema.menu.map(function(a){return a.bins||t.bins}):null,bins:[],ranges:[],active:!1},r[t.schema.name].menuLabel=t.schema.label||r[t.schema.name].name,r[t.schema.name].column=r[t.schema.name].columns[0],r[t.schema.name].label=r[t.schema.name].labels[0],r[t.schema.name].description=r[t.schema.name].descriptions[0],r[t.schema.name].binsNum=r[t.schema.name].binsNums[0],_.has(t,"groups")&&!_.isEmpty(t.groups))for(l in t.groups)_.has(t.groups,l)&&!_.isEmpty(t.groups[l])&&_.each(t.groups[l],function(a){r[t.schema.name].groups[a]=l});if(_.isString(t.parse)){var u=window[t.parse];r[t.schema.name].parse=function(a,b){return u(b)||b}}else r[t.schema.name].parse=_.isFunction(t.parse)?t.parse:function(a,b){return parseInt(b)||parseFloat(b)||b};_.isString(t.formatter)&&!_.isEmpty(t.formatter)?r[t.schema.name].formatter=function(a,b){return d3.format(t.formatter)(b)}:_.isFunction(t.formatter)?!function(a){var b=m.dataSets[a];r[b.schema.name].formatter=function(a,c){var d=b.formatter(a,c);return d?d3.format(d)(c):_.isNumber(c)?d3.format(",d")(c)||d3.format(",.2f")(c):c}}(k):r[t.schema.name].formatter=function(a,b){return _.isNumber(b)?d3.format(",d")(b)||d3.format(",.2f")(b):b}}m.debug&&console.log("defaultData",r);var v=Arg.query();for(v.ls=v.ls||d3.keys(p),v.ml=v.ls[0],v.dl=v.dl||v.ml,v.md=v.md||(head.mobile?"mobile":""),d3.select("body").classed(v.md,!0),v.t&&(v.tl=v.tl||v.ml,v.ml=v.ls[_.indexOf(v.ls,v.tl)+1],_.indexOf(v.ls,v.dl)<_.indexOf(v.ls,v.tl)+1&&(v.dl=v.ml)),_.has(m,"pointsSet")&&m.pointsSet.active&&v.mr&&_.has(v.mr,"rid")&&(m.pointsSet.resourceId=v.mr.rid,v.mr.lat=v.mr.lat||"lat",v.mr.lng=v.mr.lng||"lng"),m.debug&&console.log("parameters",v),k=_.indexOf(v.ls,v.ml);k<v.ls.length;k++)if(_.has(p,v.ls[k])){var w=[];for(l in r)_.has(r,l)&&r[l].layer===v.ls[k]&&w.push(r[l]);w.length&&(q[v.ls[k]]=p[v.ls[k]],s[v.ls[k]]=w)}m.debug&&console.log("geo",q),m.debug&&console.log("data",s);var x,y,z,A,B,C,D;_.has(m.map,"bounds")&&(_.has(m.map.bounds,"init")&&(y=L.latLng(m.map.bounds.init.southWest),z=L.latLng(m.map.bounds.init.northEast),A=L.latLngBounds(y,z)),_.has(m.map.bounds,"max")&&(B=L.latLng(m.map.bounds.max.southWest),C=L.latLng(m.map.bounds.max.northEast),D=L.latLngBounds(B,C))),x=L.map("map",{maxZoom:m.map.zoom.max||null,minZoom:m.map.zoom.min||null,zoom:m.map.zoom.init||null,center:m.map.center||(A?A.getCenter():null),scrollWheelZoom:m.map.zoom.scrollWheel||!0,attributionControl:!m.map.attribution.length,maxBounds:D||null}),!m.map.zoom.init&&A&&x.fitBounds(A),m.debug&&console.log("map",x);var E=m.geoLayers.filter(function(a){return"tile"===a.type});for(m.debug&&console.log("tileLayers",E),k=0;k<E.length;k++)L.tileLayer(E[k].url.call(E[k]),E[k].options).addTo(x);x.spin(!0);var F=L.control.attribution();for(k=0;k<m.map.attribution.length;k++)F.addAttribution(m.map.attribution[k]);m.debug&&console.log("attrib",F),F.addTo(x);var G;_.has(m,"description")&&m.description.active&&"widget"!=v.md&&(m.description.position=m.description.position||"right",d3.select("body").classed("description "+m.description.position,!0),G="top"===m.description.position||"left"===m.description.position?d3.select("body").insert("div","#map"):d3.select("body").append("div"),G.attr("id","map-description").attr("class","description "+m.description.position).append("div").html(m.description.content||""));var H;_.has(m,"infowindow")&&m.infowindow.active&&("widget"===v.md?(H={},H._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info bottom").node()):_.has(m.infowindow,"position")&&"inside"!=m.infowindow.position?(H={},d3.select("body").classed("description "+m.infowindow.position,!0),"top"===m.infowindow.position||"left"===m.infowindow.position?H._div=d3.select("body").insert("div","#map").attr("id","infowindow").attr("class","info external "+m.infowindow.position).node():("right"===m.infowindow.position||"bottom"===m.infowindow.position)&&(H._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info external "+m.infowindow.position).node())):(H=L.control({position:"bottomright"}),H.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+v.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),H.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===v.md&&x.dragging.disable();var b,c,d,e=agnes.rowDelimiter(),f=new Date,g=d3.time.format("%Y%m%d")(f),h=a._layer,i=s[h].filter(function(a){return a.active})[0],j=i.id,l=a[q[h].id],n=[],p=[];if(_.has(m.infowindow,"shareButtons")&&m.infowindow.shareButtons.active&&(b=m.infowindow.shareButtons.title+("regioni"==h?" in ":" a ")+a[q[h].label],c="http://"+location.hostname+Arg.url(v).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(v).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[q[h].label],m.infowindow.shareButtons.url&&(c=btnEncUrl=m.infowindow.shareButtons.url),_.has(m.infowindow.shareButtons,"twitter")&&m.infowindow.shareButtons.twitter.active&&n.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+m.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent((_.isFunction(m.infowindow.shareButtons.twitter.text)?m.infowindow.shareButtons.twitter.text(a.data[i.name]):d+" - "+m.infowindow.shareButtons.twitter.text)+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="icons/twitter.png" id="ssb-twitter"></a>'),_.has(m.infowindow.shareButtons,"facebook")&&m.infowindow.shareButtons.facebook.active&&n.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="icons/facebook.png" id="ssb-facebook"></a>'),_.has(m.infowindow.shareButtons,"gplus")&&m.infowindow.shareButtons.gplus.active&&n.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="icons/gplus.png" id="ssb-gplus"></a>'),_.has(m.infowindow.shareButtons,"linkedin")&&m.infowindow.shareButtons.linkedin.active&&n.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="icons/linkedin.png" id="ssb-linkedin"></a>'),_.has(m.infowindow.shareButtons,"email")&&m.infowindow.shareButtons.email.active&&n.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(m.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="icons/email.png" id="ssb-email"></a>'),_.has(m.infowindow.shareButtons,"permalink")&&m.infowindow.shareButtons.permalink.active&&n.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="icons/link.png" id="ssb-link"></a>')),m.debug&&console.log("shareButtons",n),_.has(m.infowindow,"downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)m.infowindow.downloads.files[k].active&&(m.infowindow.downloads.files[k].datasets&&m.infowindow.downloads.files[k].datasets.length&&!_.contains(m.infowindow.downloads.files[k].datasets,i.name)||p.push('<a id="a-'+m.infowindow.downloads.files[k].name+'" class="dnl" href="'+(m.infowindow.downloads.files[k].filename?m.infowindow.downloads.files[k].url():"#")+'" title="'+m.infowindow.downloads.files[k].title+'"><img src="'+m.infowindow.downloads.files[k].image+'" /></a>'));m.debug&&console.log("downloadButtons",p);var r='<thead><tr><th colspan="2">'+(p.length?'<span id="sdnlBtn">'+p.join("&nbsp;")+"</span>&nbsp;&nbsp;":"")+(n.length?'<span id="sshrBtn">'+n.join("&nbsp;")+"</span>":"")+'<a id="close-cross" href="#" title="Chiudi"><img src="icons/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[q[h].label]+"</th></tr></thead>";m.debug&&console.log("Table header",r);var t;t=_.has(m.infowindow,"downloads")&&m.infowindow.downloads.active?'<tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">'+(m.infowindow.downloads.license||"")+"</td></tr></tfoot>":"<tfoot></tfoot>",m.debug&&console.log("Table footer",t);var u;if(_.has(m.infowindow,"view")&&m.infowindow.view.active&&_.has(m.viewTypes,m.infowindow.view.type)?(u=m.viewTypes[m.infowindow.view.type](a.data[i.name],m.infowindow.view.options,i.formatter,i.groups),u.search("<tbody>")>-1||(u="<tbody>"+u+"</tbody>")):u="<tbody></tbody>",m.debug&&console.log("Table body",u),this._div.innerHTML+='<table class="zebra">'+r+u+t+"</table>",m.debug&&console.log("Table",this._div.innerHTML),_.has(m.infowindow,"shareButtons")&&m.infowindow.shareButtons.active&&_.has(m,"urlShortener")&&m.urlShortener.active&&o.shorten(btnEncUrl,m.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];_.has(m.infowindow.shareButtons,"twitter")&&m.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+m.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="icons/twitter.png" id="ssb-twitter"></a>'),_.has(m.infowindow.shareButtons,"facebook")&&m.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="icons/facebook.png" id="ssb-facebook"></a>'),_.has(m.infowindow.shareButtons,"gplus")&&m.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="icons/gplus.png" id="ssb-gplus"></a>'),_.has(m.infowindow.shareButtons,"linkedin")&&m.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="icons/linkedin.png" id="ssb-linkedin"></a>'),_.has(m.infowindow.shareButtons,"email")&&m.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(m.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="icons/email.png" id="ssb-email"></a>'),_.has(m.infowindow.shareButtons,"permalink")&&m.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="icons/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),_.has(m.infowindow,"downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)m.infowindow.downloads.files[k].active&&!m.infowindow.downloads.files[k].filename&&!function(a){var b=m.infowindow.downloads.files[a].url.call(m.infowindow.downloads.files[a],h,j,l),c=g+"_"+m.infowindow.downloads.files[a].filebase+"-"+m.infowindow.downloads.files[a].name+(j&&l?"_"+j+"-"+l:"")+".csv";d3.select("a#a-"+m.infowindow.downloads.files[a].name).on("click",function(){m.debug&&console.log(this,a,m.infowindow.downloads.files[a].name,b,c),d3[m.infowindow.downloads.files[a].format](b,function(b,d){var f=m.infowindow.downloads.files[a].transform(d);if(f.length>0){var g=agnes.jsonToCsv(f,e),h=new Blob([g],{type:"text/csv;charset=utf-8"});saveAs(h,c)}else alert("No data!")})})}(k);d3.select(this._div).select("a#close-cross").on("click",function(){return m.debug&&console.log("clickCloseCross",arguments),Z.eachLayer(function(a){a.selected=!1,Z.resetStyle(a)}),delete v.i,N&&N.isAdded&&N.removeFrom(x),H.update(),x.scrollWheelZoom.enable(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===v.md?(x.dragging.enable(),this._div.innerHTML+=m.infowindow.content.mobile):this._div.innerHTML+=m.infowindow.content.default},"widget"===v.md||_.has(m.infowindow,"position")&&"inside"!=m.infowindow.position?H.update():H.addTo(x)),m.debug&&console.log("info",H);var I;_.has(m.controls,"fullscreen")&&m.controls.fullscreen.active&&"widget"!=v.md&&"embed"!=v.md&&(I=L.control.fullscreen({title:m.controls.fullscreen.title}).addTo(x)),m.debug&&console.log("fullscreen",I);var J;_.has(m.controls,"logo")&&m.controls.logo.active&&("widget"===v.md?J=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+v.md,!0).attr("href",m.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",m.controls.logo.image):(J=L.control({position:"topleft"}),J.onAdd=function(){var a=L.DomUtil.create("a","logo "+v.md),b=L.DomUtil.create("img","logo"+(m.controls.logo.border?" border":""),a);return a.setAttribute("href",m.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",m.controls.logo.image),a},J.addTo(x))),m.debug&&console.log("logo",J);var K;_.has(m.controls,"reset")&&m.controls.reset.active&&(K=L.control({position:"mobile"===v.md?"bottomleft":"topright"}),K.onAdd=function(a){var b=L.DomUtil.create("img","reset "+v.md);return b.setAttribute("src",m.controls.reset.image),b.setAttribute("title",m.controls.reset.title),d3.select(b).on("click",function(){i(v.ml),a.fitBounds(A)}),b},K.addTo(x)),m.debug&&console.log("reset",K);var M,N;_.has(m.controls,"embed")&&m.controls.embed.active&&(N=L.control({position:"mobile"===v.md?"bottomleft":"topright"}),N.isAdded=!1,N.onRemove=function(){this.isAdded=!1},N.onAdd=function(){this.isAdded=!0;var a={},b=L.DomUtil.create("div","info embed-inputarea"),c="http://"+location.hostname+Arg.url(v).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),d="http://"+location.hostname+encodeURIComponent(Arg.url(v).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));m.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",b),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+c+'" readonly></input>'),_.has(m,"urlShortener")&&m.urlShortener.active&&m.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",b),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',o.shorten(d,m.urlShortener.prefix+md5(c),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),m.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",b),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+c+'&md=embed&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),m.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",b),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+c+'&md=widget&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),m.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",b),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(c).replace(/^[^?]+\?/,"").replace(/&/g," ")+' md=embed]" readonly></input>'),_.has(m.controls.embed,"svg")&&m.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",b),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+m.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,m.controls.embed.svg.filename)}));for(var e in a)_.has(a,e)&&d3.select(a[e]).select("input").on("focus",function(){this.select()});return b},M=L.control({position:"mobile"===v.md?"bottomleft":"topright"}),M.onAdd=function(a){var b=L.DomUtil.create("img","embed "+v.md);return b.setAttribute("src",m.controls.embed.image),b.setAttribute("title",m.controls.embed.title),d3.select(b).on("click",function(){N.isAdded?N&&N.isAdded&&N.removeFrom(a):N.addTo(a)}),b},M.addTo(x)),m.debug&&console.log("embed",M);var O;_.has(m.controls,"screenshot")&&m.controls.screenshot.active&&"widget"!=v.md&&(O=L.control({position:"mobile"===v.md?"bottomleft":"topright"}),O.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+v.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",m.controls.screenshot.image),a.setAttribute("title",m.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=m.controls.screenshot.offsetX||"auto",d=m.controls.screenshot.offsetY||"auto";canvg(a,b.node().outerHTML,{ignoreMouse:m.controls.screenshot.ignoreMouse||!0,ignoreAnimation:m.controls.screenshot.ignoreAnimation||!0,ignoreDimensions:m.controls.screenshot.ignoreDimensions||!0,ignoreClear:m.controls.screenshot.ignoreClear||!0,offsetX:_.isNumber(c)?c:j[0],offsetY:_.isNumber(d)?d:j[1]}),a.toBlob(function(a){saveAs(a,m.controls.screenshot.filename)})}})}),a},O.addTo(x)),m.debug&&console.log("screenshot",O);var P;_.has(m.controls,"detach")&&m.controls.detach.active&&("embed"===v.md||"widget"===v.md)&&(P=L.control({position:"topright"}),P.onAdd=function(){var a=L.DomUtil.create("a","detach "+v.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(v).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",m.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",m.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(v).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},P.addTo(x)),m.debug&&console.log("detach",P);var Q;_.has(m.controls,"socialButtons")&&m.controls.socialButtons.active&&(v.md||(Q=L.control({position:"bottomleft"}),Q.onAdd=function(){var a=L.DomUtil.create("div","share "+v.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",_.has(m.controls.socialButtons,"twitter")&&m.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+m.controls.socialButtons.twitter.via+'" data-lang="'+m.controls.socialButtons.twitter.lang+'" data-related="'+m.controls.socialButtons.twitter.related+'" data-hashtags="'+m.controls.socialButtons.twitter.hashtags+'" data-count="'+m.controls.socialButtons.twitter.count+'">'+m.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),_.has(m.controls.socialButtons,"facebook")&&m.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+m.controls.socialButtons.facebook.layout+'" data-action="'+m.controls.socialButtons.facebook.action+'" data-show-faces="'+m.controls.socialButtons.facebook["show-faces"].toString()+'" data-share="'+m.controls.socialButtons.facebook.share.toString()+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+m.controls.socialButtons.facebook.appId+"&version=v2.0")),_.has(m.controls.socialButtons,"gplus")&&m.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+m.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+m.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a},Q.addTo(x))),m.debug&&console.log("share",Q);var R,S=m.geoLayers.filter(function(a){return"tile"!=a.type});S.length>1&&(R=L.control({position:"topleft"}),R.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+v.md);return a.setAttribute("id","geomenu-ui"),"widget"===v.md&&a.setAttribute("style","display:none;"),a},R.addTo(x),d3.select("nav#geomenu-ui").selectAll("a").data(S.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).attr("class",function(a,b){return 0===b?"first-item":b===S.length-1?"last-item":""}).classed("disabled",function(a){return!_.has(q,a.name)}).on("click",function(a,b){if(_.has(q,a.name)){var c=a.name;s[c][0].active=!0;for(var b=0;b<s[c].length;b++)0!=b&&(s[c][b].active=!1);delete v.i,N&&N.isAdded&&N.removeFrom(x),H.update(),X.update(),T.update(a.name),T.onChange(a.name),i(a.name)}}).text(function(a){return a.menu})),m.debug&&console.log("menuGeoLayers",S),m.debug&&console.log("geoMenu",R);var T=L.control({position:"topleft"});T.onAdd=function(a){var b=L.DomUtil.create("nav","menu-ui "+v.md);return b.setAttribute("id","datamenu-ui"),"widget"===v.md&&b.setAttribute("style","display:none;"),this._nav=b,d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},T.onChange=function(a,b){d3.select(this._nav).select("select").remove();for(var b=b||0,c=s[a][b],d=[],e="",f=0;f<c.labels.length;f++)_.has(c.groups,c.labels[f])?(c.groups[c.labels[f]]!=e&&(e=c.groups[c.labels[f]],d.push({label:e,enabled:!1,level:"first-level"})),d.push({label:c.labels[f],descr:c.descriptions[f],enabled:!0,level:"second-level"})):d.push({label:c.labels[f],descr:c.descriptions[f],enabled:!0,level:"first-level"});c.columns&&c.columns.length>1&&d3.select(this._nav).append("select").attr("disabled","disabled").on("change",function(){var b=d3.select(this).property("selectedIndex"),d=d3.select(this).selectAll("option")[0][b].value,e=_.indexOf(c.columns,d);console.log(d3.select(this).selectAll("option")[0][b]),c.column=d,c.label=c.labels[e],c.description=c.descriptions[e],c.binsNum=c.binsNums[e],i(a,c.name)}).selectAll("option").data(d).enter().append("option").attr("title",function(a){return a.descr}).attr("disabled",function(a){return a.enabled?null:"disabled"
}).attr("class",function(a){return a.level+" "+(a.enabled?"enabled":"disabled")}).attr("value",function(a){return a.label}).text(function(a){return("second-level"===a.level?"- ":"")+a.label})},T.update=function(a){if(d3.select(this._nav).style("display",null).selectAll("a, select").remove(),a){var b=s[a];b.length>1?d3.select(this._nav).selectAll("a").data(b).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).attr("title",function(a){return a.description}).attr("class",function(a,c){return 0===c?"first-item":c===b.length-1?"last-item":""}).on("click",function(a,b){var c=a.layer,d=s[c][b];d.active=!0;for(var e=0;e<s[c].length;e++)e!=b&&(s[c][e].active=!1);delete v.i,N&&N.isAdded&&N.removeFrom(x),H.update(),X.update(),T.onChange(c,b),d.column=d.columns[0],d.label=d.labels[0],d.description=d.descriptions[0],d.binsNum=d.binsNums[0],i(c,a.name)}).text(function(a){return a.menuLabel}):d3.select(this._nav).style("display","none")}},T.addTo(x),T.update(S[0].schema.name),T.onChange(S[0].schema.name),m.debug&&console.log("dataMenu",T);var U;if(_.has(m.controls,"geocoder")&&m.controls.geocoder.active&&"widget"!=v.md&&"mobile"!=v.md&&(U=new L.Control.OSMGeocoder({collapsed:m.controls.geocoder.collapsed,position:"topleft",text:m.controls.geocoder.title,bounds:A,email:m.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete v.i,N&&N.isAdded&&N.removeFrom(x),H.update(),i(m.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:m.controls.geocoder.zoom})}}}),x.addControl(U),_.has(m.controls.geocoder,"autocomplete")&&m.controls.geocoder.autocomplete.active)){U._completely=completely(U._input),U._completely.onChange=function(a){U._completely.startFrom=a.lastIndexOf(" ")+1,U._completely.repaint()},U._completely.input.maxLength=50;var V=m.controls.geocoder.autocomplete.url.call(m.controls.geocoder.autocomplete,v.t||void 0);d3[m.controls.geocoder.autocomplete.format](V,function(a,b){p[m.controls.geocoder.layer].list=m.controls.geocoder.autocomplete.transform(b),U._completely.options=p[m.controls.geocoder.layer].list.map(function(a){return a[q[m.controls.geocoder.layer].label]})})}m.debug&&console.log("osmGeocoder",U);var W;m.debug&&(W=L.control({position:"bottomleft"}),W.onAdd=function(a){var b=L.DomUtil.create("div","devutil");return d3.select(b).append("p").attr("id","devutil-coord").text("Mouse position: ..."),d3.select(b).append("p").attr("id","devutil-sw").text("SouthWest bound: "+a.getBounds().getSouthWest().toString()),d3.select(b).append("p").attr("id","devutil-ne").text("NorthEast bound: "+a.getBounds().getNorthEast().toString()),d3.select(b).append("p").attr("id","devutil-center").text("Map center: "+a.getCenter().toString()),d3.select(b).append("p").attr("id","devutil-zoom").text("Zoom level: "+a.getZoom()),d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},W.addTo(x),x.on("mousemove",function(a){d3.select("#devutil-coord").text("Mouse position: "+a.latlng.toString())}).on("move",function(){d3.select("#devutil-sw").text("SouthWest bound: "+x.getBounds().getSouthWest().toString()),d3.select("#devutil-ne").text("NorthEast bound: "+x.getBounds().getNorthEast().toString()),d3.select("#devutil-center").text("Map center: "+x.getCenter().toString())}).on("zoomend",function(){d3.select("#devutil-zoom").text("Zoom level: "+x.getZoom())}));var X;if(_.has(m,"legend")&&m.legend.active&&(X=L.control({position:"bottomleft"}),X.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+v.md),this._div},X.update=function(a){if(a){var b=s[a].filter(function(a){return a.active})[0],c=m.legend.delimiter||"-",d=b.ranges.map(function(a){return a.split(" - ").map(function(a){var c=parseFloat(a);return b.formatter(b.column,c)}).join(" "+c+" ")}),e=b.description||m.legend.description||"";this._div.innerHTML="widget"!=v.md?'<h3 title="'+e+'">'+m.legend.title+"</h3>":"";for(var f=0;f<d.length;f++){var g=colorbrewer[b.palette][d.length]?colorbrewer[b.palette][d.length][f]:colorbrewer[b.palette][3][f];this._div.innerHTML+='<i title="'+(_.has(m.legend,"label")?m.legend.label.call(m.legend,d[f].split(" "+c+" ")[0],d[f].split(" "+c+" ")[1],b.label):d[f])+'" style="background:'+g+'"></i> '+("widget"!=v.md?m.legend.label.call(m.legend,d[f].split(" "+c+" ")[0],d[f].split(" "+c+" ")[1]):"")+"<br>"}"widget"!=v.md&&(this._div.innerHTML+="<p>"+e+"</p>")}else this._div.innerHTML="widget"!=v.md?"<h3>"+m.legend.title+"</h3>":""},X.addTo(x),X.update()),m.debug&&console.log("legend",X),m.pointsSet&&m.pointsSet.active&&m.pointsSet.resourceId){var Y=m.pointsSet.url.call(m.pointsSet);m.debug&&console.log("markersPath",Y),d3[m.pointsSet.format](Y,function(a,b){m.debug&&console.log("markers",arguments);var c=b?m.pointsSet.transform(b):null;if(c){for(var d=new L.MarkerClusterGroup({showCoverageOnHover:!1}),e=[],f=0;f<c.length;f++){var g=L.marker();g.setIcon(L.icon({iconUrl:m.pointsSet.icon,shadowUrl:m.pointsSet.shadow})),g.setLatLng(L.latLng(c[f][v.mr.lat],c[f][v.mr.lng])),_.has(v.mr,"iw")&&g.bindPopup(c[f][v.mr.iw]),e.push(g),d.addLayer(g)}x.addLayer(m.pointsSet.clusters?d:L.layerGroup(e))}})}var Z,$=new L.Label;Z=L.geoJson("",{style:b,onEachFeature:f}).addTo(x),m.debug&&console.log("geojson",Z),setTimeout(function(){x.spin(!1),i(v.dl)},3e3)})}(mapConfig);