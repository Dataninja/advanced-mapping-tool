/*! dataninja-advanced-mapping-tool 14-11-2014 */
!function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){for(var d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){var c=b.properties._layer,d=F.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=K[c].filter(function(a){return a.active})[0],f=d.style.default;return f.fillColor=a(b.properties.data[e.name][e.value],e.bins,e.palette),f}function c(a){var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=F.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=K[d].filter(function(a){return a.active})[0],g=e.style.highlight,h=c.data[f.name][f.value];b.selected||b.setStyle(g),F.hasOwnProperty("label")&&F.label.active&&(ab.setContent(c[I[d].label]+"<br>"+f.label+": "+(f.formatter(f.value,h)?d3.format(f.formatter(f.value,h))(h):d3.format(",d")(h)||d3.format(",.2f")(h)||h)),ab.setLatLng(b.getBounds().getCenter()),o.showLabel(ab))}function d(a){{var b=a.target,c=b.feature.properties._layer,d=F.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||_.eachLayer(function(a){a.selected||_.resetStyle(a)}),F.hasOwnProperty("label")&&F.label.active&&ab.close()}function e(a,b){F.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=F.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;_.eachLayer(function(a){a.selected=!1,_.resetStyle(a)}),b.selected=!0,b.setStyle(e),G.i=b.feature.properties[I[G.dl].id],w&&w.isAdded&&w.removeFrom(o),r.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){b.on({mouseover:c,mouseout:d,click:e})}function g(a){F.debug&&console.log("joinDataFunction",arguments);for(var b,c,d=0;d<I[a].resource.length;d++){b=I[a].resource[d].properties[I[a].id],I[a].resource[d].properties.data={};for(var e=0;e<K[a].length;e++){K[a][e].active=!e;for(var f=0;f<K[a][e].resource.length;f++){var c=K[a][e].resource[f][K[a][e].id];if(c==b){I[a].resource[d].properties.data[K[a][e].name]=K[a][e].resource[f];for(var g in I[a].resource[d].properties.data[K[a][e].name])I[a].resource[d].properties.data[K[a][e].name].hasOwnProperty(g)&&(I[a].resource[d].properties.data[K[a][e].name][g]=K[a][e].parse(I[a].resource[d].properties.data[K[a][e].name][g]));I[a].resource[d].properties._layer=a}}}d3.keys(I[a].resource[d].properties.data).length||(I[a].resource.splice(d,1),d--)}}function h(a){F.debug&&console.log("binDataFunction",arguments);var b=K[a].map(function(a){return a.active}).indexOf(!0),c=K[a][b].value,d=(F.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],F.dataSets.filter(function(b){return b.schema.layer===a})[b]),e=K[a][b].resource.map(function(a){return a[c]}),f=new geostats(e);K[a][b].bins=f.getJenks(e.length>d.bins?d.bins:e.length-1),K[a][b].ranges=f.ranges,E.update(a)}function i(a,b){F.debug&&console.log("loadDataFunction",arguments);var c,d,f,i=F.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],j=F.dataSets.filter(function(b){return b.schema.layer===a});if(d3.selectAll("nav#geomenu-ui a").classed("active",!1),d3.select("nav#geomenu-ui a#"+a).classed("active",!0),d3.selectAll("nav#datamenu-ui a").classed("active",!1),d3.select("nav#datamenu-ui a#"+(b||j[0].schema.name)).classed("active",!0),d3.select("nav#datamenu-ui select").attr("disabled",null),G.dl=a,_.clearLayers(),F.debug&&console.log("geoLayer",i),F.debug&&console.log("dataSets",j),I[a].resource)h(a),_.addData(I[a].resource),delete G.i,w&&w.isAdded&&w.removeFrom(o),E.update(a),r.update();else{o.spin(!0),f=queue(),c=i.url.call(i,a,G.t?G.tl:void 0,G.t||void 0),f.defer(d3[i.format],c),F.debug&&console.log("geoPath",c);for(var l=0;l<j.length;l++)d=j[l].url.call(j[l],a,G.t?J[G.tl].id:void 0,G.t||void 0),f.defer(d3[j[l].format],d),F.debug&&console.log("dataPath",l,d);f.await(function(b,c){F.debug&&console.log("await",arguments),I[a].resource=i.transform(c);for(var d=2;d<arguments.length;d++)K[a][d-2].resource=j[d-2].transform(arguments[d]);o.spin(!1),g(a),h(a),_.addData(I[a].resource),k||(k=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),G.t&&o.fitBounds(_.getBounds()),G.i&&_.eachLayer(function(b){b.feature.properties[I[a].id]==G.i&&e(null,b)})})}}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F=mapConfig,G=Arg.query(),H={},I={},J={},K={};if(F.hasOwnProperty("language")){switch(F.language){case"it":l=d3.locale({decimal:",",thousands:".",grouping:[3],currency:["€ ",""],dateTime:"%a %b %e %X %Y",date:"%d/%m/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"],shortDays:["Dom","Lun","Mar","Mer","Gio","Ven","Sab"],months:["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],shortMonths:["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"]});break;default:l=d3.locale()}d3.format=l.numberFormat,d3.time.format=l.timeFormat}var M,N;for(m=0;m<F.geoLayers.length;m++){N=F.geoTypes[F.geoLayers[m].type];for(n in N)if(N.hasOwnProperty(n))if(F.geoLayers[m].hasOwnProperty(n)){if("object"==typeof N[n])for(var O in N[n])N[n].hasOwnProperty(O)&&!F.geoLayers[m][n].hasOwnProperty(O)&&(F.geoLayers[m][n][O]=N[n][O])}else F.geoLayers[m][n]=N[n];M=F.geoSources[F.geoLayers[m].source];for(n in M)M.hasOwnProperty(n)&&!F.geoLayers[m].hasOwnProperty(n)&&(F.geoLayers[m][n]=M[n]);F.geoLayers[m].active||(F.geoLayers.splice(m,1),m--)}for(m=0;m<F.dataSets.length;m++){N=F.dataTypes[F.dataSets[m].type];for(n in N)N.hasOwnProperty(n)&&!F.dataSets[m].hasOwnProperty(n)&&(F.dataSets[m][n]=N[n]);M=F.dataSources[F.dataSets[m].source];for(n in M)M.hasOwnProperty(n)&&!F.dataSets[m].hasOwnProperty(n)&&(F.dataSets[m][n]=M[n]);var P=F.geoLayers.filter(function(a){return a.hasOwnProperty("schema")&&a.schema.name===F.dataSets[m].schema.layer});P.length&&P[0].active||(F.dataSets.splice(m,1),m--)}if(F.hasOwnProperty("infowindow")&&F.infowindow.active&&F.infowindow.hasOwnProperty("downloads")&&F.infowindow.downloads.active)for(m=0;m<F.infowindow.downloads.files.length;m++)if(F.infowindow.downloads.files[m].active){M=F.dataSources[F.infowindow.downloads.files[m].source];for(n in M)M.hasOwnProperty(n)&&!F.infowindow.downloads.files[m].hasOwnProperty(n)&&(F.infowindow.downloads.files[m][n]=M[n])}if(F.hasOwnProperty("pointsSet")&&F.pointsSet.active){M=F.dataSources[F.pointsSet.source];for(n in M)M.hasOwnProperty(n)&&!F.pointsSet.hasOwnProperty(n)&&(F.pointsSet[n]=M[n])}for(F.debug&&console.log("$",F),F.hasOwnProperty("urlShortener")&&F.urlShortener.active&&(j=yourls.connect(F.urlShortener.url.call(F.urlShortener),{signature:F.urlShortener.signature})),F.debug&&console.log("dtnj",j),m=0;m<F.geoLayers.length;m++)"vector"===F.geoLayers[m].type&&(H[F.geoLayers[m].schema.name]={id:F.geoLayers[m].schema.id,label:F.geoLayers[m].schema.label,resource:null,list:[]});for(F.debug&&console.log("defaultGeo",H),m=0;m<F.dataSets.length;m++)J[F.dataSets[m].schema.name]={name:F.dataSets[m].schema.name,menu:F.dataSets[m].schema.menu,layer:F.dataSets[m].schema.layer,id:F.dataSets[m].schema.id,values:"string"==typeof F.dataSets[m].schema.values?[F.dataSets[m].schema.values]:F.dataSets[m].schema.values,value:"string"==typeof F.dataSets[m].schema.values?F.dataSets[m].schema.values:F.dataSets[m].schema.values[0],resourceId:F.dataSets[m].resourceId,palette:F.dataSets[m].palette,transform:F.dataSets[m].transform||function(a,b){return b},formatter:F.dataSets[m].formatter||function(){return""},resource:null,bins:[],ranges:[],active:!1},F.dataSets[m].schema.hasOwnProperty("descriptions")&&F.dataSets[m].schema.descriptions.length?(J[F.dataSets[m].schema.name].descriptions="string"==typeof F.dataSets[m].schema.descriptions?[F.dataSets[m].schema.descriptions]:F.dataSets[m].schema.descriptions,J[F.dataSets[m].schema.name].description="string"==typeof F.dataSets[m].schema.descriptions?F.dataSets[m].schema.descriptions:F.dataSets[m].schema.descriptions[0]):(J[F.dataSets[m].schema.name].descriptions=J[F.dataSets[m].schema.name].values,J[F.dataSets[m].schema.name].description=J[F.dataSets[m].schema.name].value),F.dataSets[m].schema.hasOwnProperty("labels")&&F.dataSets[m].schema.labels.length?(J[F.dataSets[m].schema.name].labels="string"==typeof F.dataSets[m].schema.labels?[F.dataSets[m].schema.labels]:F.dataSets[m].schema.labels,J[F.dataSets[m].schema.name].label="string"==typeof F.dataSets[m].schema.labels?F.dataSets[m].schema.labels:F.dataSets[m].schema.labels[0]):(J[F.dataSets[m].schema.name].labels=J[F.dataSets[m].schema.name].values,J[F.dataSets[m].schema.name].label=J[F.dataSets[m].schema.name].value),J[F.dataSets[m].schema.name].parse="string"==typeof F.dataSets[m].parse?function(a){return window[F.dataSets[m].parse](a)||a}:"function"==typeof F.dataSets[m].parse?F.dataSets[m].parse:function(a){return parseInt(a)||parseFloat(a)||a};for(F.debug&&console.log("defaultData",J),G.ls=G.ls||d3.keys(H),G.ml=G.ls[0],G.dl=G.dl||G.ml,G.md=G.md||(head.mobile?"mobile":""),d3.select("body").classed(G.md,!0),G.t&&(G.tl=G.tl||G.ml,G.ml=G.ls[G.ls.indexOf(G.tl)+1],G.ls.indexOf(G.dl)<G.ls.indexOf(G.tl)+1&&(G.dl=G.ml)),F.hasOwnProperty("pointsSet")&&F.pointsSet.active&&G.mr&&G.mr.hasOwnProperty("rid")&&(F.pointsSet.resourceId=G.mr.rid,G.mr.lat=G.mr.lat||"lat",G.mr.lng=G.mr.lng||"lng"),F.debug&&console.log("parameters",G),m=G.ls.indexOf(G.ml);m<G.ls.length;m++)if(H.hasOwnProperty(G.ls[m])){var Q=[];for(n in J)J.hasOwnProperty(n)&&J[n].layer===G.ls[m]&&Q.push(J[n]);Q.length&&(I[G.ls[m]]=H[G.ls[m]],K[G.ls[m]]=Q)}F.debug&&console.log("geo",I),F.debug&&console.log("data",K);var R,S,T,U,V,W;F.map.hasOwnProperty("bounds")&&(F.map.bounds.hasOwnProperty("init")&&(R=L.latLng(F.map.bounds.init.southWest),S=L.latLng(F.map.bounds.init.northEast),T=L.latLngBounds(R,S)),F.map.bounds.hasOwnProperty("max")&&(U=L.latLng(F.map.bounds.max.southWest),V=L.latLng(F.map.bounds.max.northEast),W=L.latLngBounds(U,V))),o=L.map("map",{maxZoom:F.map.zoom.max||null,minZoom:F.map.zoom.min||null,zoom:F.map.zoom.init||null,center:F.map.center||(T?T.getCenter():null),scrollWheelZoom:F.map.zoom.scrollWheel||!0,attributionControl:!F.map.attribution.length,maxBounds:W||null}),!F.map.zoom.init&&T&&o.fitBounds(T),F.debug&&console.log("map",o);var X=F.geoLayers.filter(function(a){return"tile"===a.type});for(F.debug&&console.log("tileLayers",X),m=0;m<X.length;m++)L.tileLayer(X[m].url.call(X[m]),X[m].options).addTo(o);for(o.spin(!0),q=L.control.attribution(),m=0;m<F.map.attribution.length;m++)q.addAttribution(F.map.attribution[m]);F.debug&&console.log("attrib",q),q.addTo(o),F.hasOwnProperty("description")&&F.description.active&&"widget"!=G.md&&(F.description.position=F.description.position||"right",d3.select("body").classed("description "+F.description.position,!0),p="top"===F.description.position||"left"===F.description.position?d3.select("body").insert("div","#map"):d3.select("body").append("div"),p.attr("id","map-description").attr("class","description "+F.description.position).append("div").html(F.description.content||"")),F.hasOwnProperty("infowindow")&&F.infowindow.active&&("widget"===G.md?(r={},r._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info bottom").node()):F.infowindow.hasOwnProperty("position")&&"inside"!=F.infowindow.position?(r={},d3.select("body").classed("description "+F.infowindow.position,!0),"top"===F.infowindow.position||"left"===F.infowindow.position?r._div=d3.select("body").insert("div","#map").attr("id","infowindow").attr("class","info external "+F.infowindow.position).node():("right"===F.infowindow.position||"bottom"===F.infowindow.position)&&(r._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info external "+F.infowindow.position).node())):(r=L.control({position:"bottomright"}),r.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+G.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),r.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===G.md&&o.dragging.disable();var b,c,d,e=agnes.rowDelimiter(),f=new Date,g=d3.time.format("%Y%m%d")(f),h=a._layer,i=K[h].filter(function(a){return a.active})[0],k=i.id,l=a[I[h].id],n=[],p=[];if(F.infowindow.hasOwnProperty("shareButtons")&&F.infowindow.shareButtons.active&&(b=F.infowindow.shareButtons.title+("regioni"==h?" in ":" a ")+a[I[h].label],c="http://"+location.hostname+Arg.url(G).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(G).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[I[h].label],F.infowindow.shareButtons.hasOwnProperty("twitter")&&F.infowindow.shareButtons.twitter.active&&n.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+F.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+F.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),F.infowindow.shareButtons.hasOwnProperty("facebook")&&F.infowindow.shareButtons.facebook.active&&n.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),F.infowindow.shareButtons.hasOwnProperty("gplus")&&F.infowindow.shareButtons.gplus.active&&n.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),F.infowindow.shareButtons.hasOwnProperty("linkedin")&&F.infowindow.shareButtons.linkedin.active&&n.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),F.infowindow.shareButtons.hasOwnProperty("email")&&F.infowindow.shareButtons.email.active&&n.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(F.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+F.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),F.infowindow.shareButtons.hasOwnProperty("permalink")&&F.infowindow.shareButtons.permalink.active&&n.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>')),F.debug&&console.log("shareButtons",n),F.infowindow.hasOwnProperty("downloads")&&F.infowindow.downloads.active)for(m=0;m<F.infowindow.downloads.files.length;m++)F.infowindow.downloads.files[m].active&&p.push('<a id="a-'+F.infowindow.downloads.files[m].name+'" class="dnl" href="#" title="'+F.infowindow.downloads.files[m].title+'"><img src="'+F.infowindow.downloads.files[m].image+'" /></a>');F.debug&&console.log("downloadButtons",p);var q="<thead><tr><th>"+(p.length?'<span id="sdnlBtn">'+p.join("&nbsp;")+"</span>&nbsp;&nbsp;":"")+(n.length?'<span id="sshrBtn">'+n.join("&nbsp;")+"</span>":"")+'</th><th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[I[h].label]+"</th></tr></thead>";F.debug&&console.log("Table header",q);var s;s=F.infowindow.hasOwnProperty("downloads")&&F.infowindow.downloads.active?'<tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">'+(F.infowindow.downloads.license||"")+"</td></tr></tfoot>":"<tfoot></tfoot>",F.debug&&console.log("Table footer",s);var t;if(F.infowindow.hasOwnProperty("view")&&F.infowindow.view.active&&F.viewTypes.hasOwnProperty(F.infowindow.view.type)?(t=F.viewTypes[F.infowindow.view.type](a.data[i.name],F.infowindow.view.options,i.formatter),t.indexOf("<tbody>")>-1||(t="<tbody>"+t+"</tbody>")):t="<tbody></tbody>",F.debug&&console.log("Table body",t),this._div.innerHTML+='<table class="zebra">'+q+t+s+"</table>",F.debug&&console.log("Table",this._div.innerHTML),F.infowindow.hasOwnProperty("shareButtons")&&F.infowindow.shareButtons.active&&F.hasOwnProperty("urlShortener")&&F.urlShortener.active&&j.shorten(btnEncUrl,F.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];F.infowindow.shareButtons.hasOwnProperty("twitter")&&F.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+F.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+F.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),F.infowindow.shareButtons.hasOwnProperty("facebook")&&F.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),F.infowindow.shareButtons.hasOwnProperty("gplus")&&F.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),F.infowindow.shareButtons.hasOwnProperty("linkedin")&&F.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),F.infowindow.shareButtons.hasOwnProperty("email")&&F.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(F.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+F.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),F.infowindow.shareButtons.hasOwnProperty("permalink")&&F.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),F.infowindow.hasOwnProperty("downloads")&&F.infowindow.downloads.active)for(m=0;m<F.infowindow.downloads.files.length;m++)F.infowindow.downloads.files[m].active&&!function(a){var b=F.infowindow.downloads.files[a].url.call(F.infowindow.downloads.files[a],h,k,l),c=g+"_"+F.infowindow.downloads.files[a].filebase+"-"+F.infowindow.downloads.files[a].name+(k&&l?"_"+k+"-"+l:"")+".csv";d3.select("a#a-"+F.infowindow.downloads.files[a].name).on("click",function(){F.debug&&console.log(this,a,F.infowindow.downloads.files[a].name,b,c),d3[F.infowindow.downloads.files[a].format](b,function(b,d){var f=F.infowindow.downloads.files[a].transform(d);if(f.length>0){var g=agnes.jsonToCsv(f,e),h=new Blob([g],{type:"text/csv;charset=utf-8"});saveAs(h,c)}else alert("No data!")})})}(m);d3.select(this._div).select("a#close-cross").on("click",function(){return F.debug&&console.log("clickCloseCross",arguments),_.eachLayer(function(a){a.selected=!1,_.resetStyle(a)}),delete G.i,w&&w.isAdded&&w.removeFrom(o),r.update(),o.scrollWheelZoom.enable(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===G.md?(o.dragging.enable(),this._div.innerHTML+=F.infowindow.content.mobile):this._div.innerHTML+=F.infowindow.content.default},"widget"===G.md||F.infowindow.hasOwnProperty("position")&&"inside"!=F.infowindow.position?r.update():r.addTo(o)),F.debug&&console.log("info",r),F.controls.hasOwnProperty("fullscreen")&&F.controls.fullscreen.active&&"widget"!=G.md&&"embed"!=G.md&&(s=L.control.fullscreen({title:F.controls.fullscreen.title}).addTo(o)),F.debug&&console.log("fullscreen",s),F.controls.hasOwnProperty("logo")&&F.controls.logo.active&&("widget"===G.md?t=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+G.md,!0).attr("href",F.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",F.controls.logo.image):(t=L.control({position:"topleft"}),t.onAdd=function(){var a=L.DomUtil.create("a","logo "+G.md),b=L.DomUtil.create("img","logo"+(F.controls.logo.border?" border":""),a);return a.setAttribute("href",F.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",F.controls.logo.image),a},t.addTo(o))),F.debug&&console.log("logo",t),F.controls.hasOwnProperty("reset")&&F.controls.reset.active&&(u=L.control({position:"mobile"===G.md?"bottomleft":"topright"}),u.onAdd=function(a){var b=L.DomUtil.create("img","reset "+G.md);return b.setAttribute("src",F.controls.reset.image),b.setAttribute("title",F.controls.reset.title),d3.select(b).on("click",function(){i(G.ml),a.fitBounds(T)}),b},u.addTo(o)),F.debug&&console.log("reset",u),F.controls.hasOwnProperty("embed")&&F.controls.embed.active&&(w=L.control({position:"mobile"===G.md?"bottomleft":"topright"}),w.isAdded=!1,w.onRemove=function(){this.isAdded=!1},w.onAdd=function(){this.isAdded=!0;var a={},b=L.DomUtil.create("div","info embed-inputarea"),c="http://"+location.hostname+Arg.url(G).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),d="http://"+location.hostname+encodeURIComponent(Arg.url(G).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));F.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",b),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+c+'" readonly></input>'),F.hasOwnProperty("urlShortener")&&F.urlShortener.active&&F.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",b),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',j.shorten(d,F.urlShortener.prefix+md5(c),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),F.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",b),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+c+'&md=embed&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),F.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",b),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+c+'&md=widget&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),F.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",b),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(c).replace(/^[^?]+\?/,"").replace(/&/g," ")+' md=embed]" readonly></input>'),F.controls.embed.hasOwnProperty("svg")&&F.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",b),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+F.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,F.controls.embed.svg.filename)}));for(var e in a)a.hasOwnProperty(e)&&d3.select(a[e]).select("input").on("focus",function(){this.select()});return b},v=L.control({position:"mobile"===G.md?"bottomleft":"topright"}),v.onAdd=function(a){var b=L.DomUtil.create("img","embed "+G.md);return b.setAttribute("src",F.controls.embed.image),b.setAttribute("title",F.controls.embed.title),d3.select(b).on("click",function(){w.isAdded?w&&w.isAdded&&w.removeFrom(a):w.addTo(a)}),b},v.addTo(o)),F.debug&&console.log("embed",v),F.controls.hasOwnProperty("screenshot")&&F.controls.screenshot.active&&"widget"!=G.md&&(x=L.control({position:"mobile"===G.md?"bottomleft":"topright"}),x.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+G.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",F.controls.screenshot.image),a.setAttribute("title",F.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=F.controls.screenshot.offsetX||"auto",d=F.controls.screenshot.offsetY||"auto";canvg(a,b.node().outerHTML,{ignoreMouse:F.controls.screenshot.ignoreMouse||!0,ignoreAnimation:F.controls.screenshot.ignoreAnimation||!0,ignoreDimensions:F.controls.screenshot.ignoreDimensions||!0,ignoreClear:F.controls.screenshot.ignoreClear||!0,offsetX:"number"==typeof c?c:k[0],offsetY:"number"==typeof d?d:k[1]}),a.toBlob(function(a){saveAs(a,F.controls.screenshot.filename)})}})}),a},x.addTo(o)),F.debug&&console.log("screenshot",x),F.controls.hasOwnProperty("detach")&&F.controls.detach.active&&("embed"===G.md||"widget"===G.md)&&(y=L.control({position:"topright"}),y.onAdd=function(){var a=L.DomUtil.create("a","detach "+G.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(G).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",F.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",F.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(G).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},y.addTo(o)),F.debug&&console.log("detach",y),F.controls.hasOwnProperty("socialButtons")&&F.controls.socialButtons.active&&(G.md||(A=L.control({position:"bottomleft"}),A.onAdd=function(){var a=L.DomUtil.create("div","share "+G.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",F.controls.socialButtons.hasOwnProperty("twitter")&&F.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+F.controls.socialButtons.twitter.via+'" data-lang="'+F.controls.socialButtons.twitter.lang+'" data-related="'+F.controls.socialButtons.twitter.related+'" data-hashtags="'+F.controls.socialButtons.twitter.hashtags+'" data-count="'+F.controls.socialButtons.twitter.count+'">'+F.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),F.controls.socialButtons.hasOwnProperty("facebook")&&F.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+F.controls.socialButtons.facebook.layout+'" data-action="'+F.controls.socialButtons.facebook.action+'" data-show-faces="'+F.controls.socialButtons.facebook["show-faces"].toString()+'" data-share="'+F.controls.socialButtons.facebook.share.toString()+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+F.controls.socialButtons.facebook.appId+"&version=v2.0")),F.controls.socialButtons.hasOwnProperty("gplus")&&F.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+F.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+F.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a},A.addTo(o))),F.debug&&console.log("share",A);var Y=F.geoLayers.filter(function(a){return"tile"!=a.type});if(Y.length>1&&(B=L.control({position:"topleft"}),B.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+G.md);return a.setAttribute("id","geomenu-ui"),"widget"===G.md&&a.setAttribute("style","display:none;"),a},B.addTo(o),d3.select("nav#geomenu-ui").selectAll("a").data(Y.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).classed("disabled",function(a){return!I.hasOwnProperty(a.name)}).on("click",function(a,b){if(I.hasOwnProperty(a.name)){var c=a.name;K[c][0].active=!0;for(var b=0;b<K[c].length;b++)0!=b&&(K[c][b].active=!1);delete G.i,w&&w.isAdded&&w.removeFrom(o),r.update(),E.update(),C.update(a.name),C.onChange(a.name),i(a.name)}}).text(function(a){return a.menu})),F.debug&&console.log("menuGeoLayers",Y),F.debug&&console.log("geoMenu",B),C=L.control({position:"topleft"}),C.onAdd=function(a){var b=L.DomUtil.create("nav","menu-ui "+G.md);return b.setAttribute("id","datamenu-ui"),"widget"===G.md&&b.setAttribute("style","display:none;"),this._nav=b,d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},C.onChange=function(a,b){d3.select(this._nav).select("select").remove();var b=b||0,c=K[a][b].values;c&&c.length>1&&d3.select(this._nav).append("select").attr("disabled","disabled").on("change",function(){var c=d3.select(this).property("selectedIndex"),d=d3.select(this).selectAll("option")[0][c].__data__;K[a][b].value=d,K[a][b].label=K[a][b].labels[c],K[a][b].description=K[a][b].descriptions[c],i(a,K[a][b].name)}).selectAll("option").data(c).enter().append("option").text(function(a){return a})},C.update=function(a){if(d3.select(this._nav).style("display",null).selectAll("a, select").remove(),a){var b=F.dataSets.filter(function(b){return b.schema.layer===a});b.length>1?d3.select(this._nav).selectAll("a").data(b.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).on("click",function(a,b){var c=a.layer;K[c][b].active=!0;for(var d=0;d<K[c].length;d++)d!=b&&(K[c][d].active=!1);delete G.i,w&&w.isAdded&&w.removeFrom(o),r.update(),E.update(),C.onChange(c,b),i(c,a.name)}).text(function(a){return a.menu}):d3.select(this._nav).style("display","none")}},C.addTo(o),C.update(Y[0].schema.name),C.onChange(Y[0].schema.name),F.debug&&console.log("dataMenu",C),F.controls.hasOwnProperty("geocoder")&&F.controls.geocoder.active&&"widget"!=G.md&&"mobile"!=G.md&&(D=new L.Control.OSMGeocoder({collapsed:F.controls.geocoder.collapsed,position:"topleft",text:F.controls.geocoder.title,bounds:T,email:F.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete G.i,w&&w.isAdded&&w.removeFrom(o),r.update(),i(F.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:F.controls.geocoder.zoom})}}}),o.addControl(D),F.controls.geocoder.hasOwnProperty("autocomplete")&&F.controls.geocoder.autocomplete.active)){D._completely=completely(D._input),D._completely.onChange=function(a){D._completely.startFrom=a.lastIndexOf(" ")+1,D._completely.repaint()},D._completely.input.maxLength=50;var Z=F.controls.geocoder.autocomplete.url.call(F.controls.geocoder.autocomplete,G.t||void 0);d3[F.controls.geocoder.autocomplete.format](Z,function(a,b){H[F.controls.geocoder.layer].list=F.controls.geocoder.autocomplete.transform(b),D._completely.options=H[F.controls.geocoder.layer].list.map(function(a){return a[I[F.controls.geocoder.layer].label]
})})}if(F.debug&&console.log("osmGeocoder",D),F.debug&&(z=L.control({position:"bottomleft"}),z.onAdd=function(a){var b=L.DomUtil.create("div","devutil");return d3.select(b).append("p").attr("id","devutil-coord").text("Mouse position: ..."),d3.select(b).append("p").attr("id","devutil-sw").text("SouthWest bound: "+a.getBounds().getSouthWest().toString()),d3.select(b).append("p").attr("id","devutil-ne").text("NorthEast bound: "+a.getBounds().getNorthEast().toString()),d3.select(b).append("p").attr("id","devutil-center").text("Map center: "+a.getCenter().toString()),d3.select(b).append("p").attr("id","devutil-zoom").text("Zoom level: "+a.getZoom()),d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},z.addTo(o),o.on("mousemove",function(a){d3.select("#devutil-coord").text("Mouse position: "+a.latlng.toString())}).on("move",function(){d3.select("#devutil-sw").text("SouthWest bound: "+o.getBounds().getSouthWest().toString()),d3.select("#devutil-ne").text("NorthEast bound: "+o.getBounds().getNorthEast().toString()),d3.select("#devutil-center").text("Map center: "+o.getCenter().toString())}).on("zoomend",function(){d3.select("#devutil-zoom").text("Zoom level: "+o.getZoom())})),F.hasOwnProperty("legend")&&F.legend.active&&(E=L.control({position:"bottomleft"}),E.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+G.md),this._div},E.update=function(a){if(a){var b=K[a].filter(function(a){return a.active})[0],c=b.ranges.map(function(a){return a.split(" - ").map(function(a){var c=parseFloat(a);return b.formatter(b.value,c)?d3.format(b.formatter(b.value,c))(c):d3.format(",d")(c)||d3.format(",.2f")(c)||c}).join(" - ")}),d=b.description||F.legend.description||"";console.log(b),this._div.innerHTML="widget"!=G.md?'<h4 title="'+d+'">'+F.legend.title+"</h4>":"";for(var e=0;e<c.length;e++){var f=colorbrewer[b.palette][c.length]?colorbrewer[b.palette][c.length][e]:colorbrewer[b.palette][3][e];this._div.innerHTML+='<i title="'+(F.legend.hasOwnProperty("label")?F.legend.label(c[e].split(" - ")[0],c[e].split(" - ")[1],b.label):c[e])+'" style="background:'+f+'"></i> '+("widget"!=G.md?c[e]:"")+"<br>"}"widget"!=G.md&&(this._div.innerHTML+="<br>"+d)}else this._div.innerHTML="widget"!=G.md?"<h4>"+F.legend.title+"</h4>":""},E.addTo(o),E.update()),F.debug&&console.log("legend",E),F.pointsSet&&F.pointsSet.active&&F.pointsSet.resourceId){var $=F.pointsSet.url.call(F.pointsSet);F.debug&&console.log("markersPath",$),d3[F.pointsSet.format]($,function(a,b){F.debug&&console.log("markers",arguments);var c=b?F.pointsSet.transform(b):null;if(c){for(var d=new L.MarkerClusterGroup({showCoverageOnHover:!1}),e=[],f=0;f<c.length;f++){var g=L.marker();g.setIcon(L.icon({iconUrl:F.pointsSet.icon,shadowUrl:F.pointsSet.shadow})),g.setLatLng(L.latLng(c[f][G.mr.lat],c[f][G.mr.lng])),G.mr.hasOwnProperty("iw")&&g.bindPopup(c[f][G.mr.iw]),e.push(g),d.addLayer(g)}o.addLayer(F.pointsSet.clusters?d:L.layerGroup(e))}})}var _,ab=new L.Label;_=L.geoJson("",{style:b,onEachFeature:f}).addTo(o),F.debug&&console.log("geojson",_),setTimeout(function(){o.spin(!1),i(G.dl)},3e3)})}(mapConfig);