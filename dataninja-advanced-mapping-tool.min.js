/*! dataninja-advanced-mapping-tool 12-11-2014 */
var mapConfig={debug:!0,urlShortener:{active:!1,domain:"",path:"/api/dtnj/yourls-api.php",signature:"efe758b8d3",prefix:"confiscatibene-",url:function(){return this.domain+this.path}},map:{bounds:{init:{southWest:{lat:35.568,lng:1.537},northEast:{lat:47.843,lng:23.203}},max:{southWest:{lat:22.472,lng:-16.523},northEast:{lat:62.083,lng:73.828}}},zoom:{max:13,min:5,scrollWheel:!0},attribution:['Powered by <a href="http://www.dataninja.it/" target="_blank">Dataninja</a>','tileset from <a href="http://www.geoiq.com/" target="_blank">GeoIQ</a>','icons from <a href="http://www.flaticon.com/" target="_blank">Freepik</a> and <a href="http://www.simplesharebuttons.com/" target="_blank">Simple Share Buttons</a>','geocoding by <a href="http://wiki.openstreetmap.org/wiki/Nominatim" target="_blank">OSM Nominatim</a>','code on <a href="https://github.com/Dataninja/confiscatibene-choropleth" target="_blank">GitHub</a>.']},label:{active:!0,text:"Beni confiscati"},legend:{active:!0,title:"Legenda",description:"Numero totale di beni confiscati",itemLabel:"beni confiscati"},geoLayers:[{type:"tile"},{source:"file",path:"geo/",format:"json",type:"vector",schema:{name:"regioni",menu:"Regioni",id:"COD_REG",label:"NOME_REG"}},{source:"file",path:"geo/",format:"json",type:"vector",schema:{name:"province",menu:"Province",id:"COD_PRO",label:"NOME_PRO"}},{active:!1,source:"file",path:"geo/",format:"json",type:"vector",schema:{name:"comuni",menu:"Comuni",id:"PRO_COM",label:"NOME_COM"}}],dataSets:[{source:"file",path:"data/",filename:"e2f0c989-929f-4e4d-87e2-097140f8880f.json",format:"json",transform:function(a){return a.result.records},type:"choropleth",bins:7,palette:"Reds",schema:{name:"regioni1",menu:"Beni confiscati 1",layer:"regioni",id:"IdRegioneISTAT",label:"",values:["Totale beni","Totale immobili","Totale aziende"]},parse:"parseInt"},{source:"file",path:"data/",filename:"e2f0c989-929f-4e4d-87e2-097140f8880f.json",format:"json",transform:function(a){return a.result.records},type:"choropleth",bins:7,palette:"Greens",schema:{name:"regioni2",menu:"Beni confiscati 2",layer:"regioni",id:"IdRegioneISTAT",label:"",values:"Totale beni"},parse:"parseInt"},{source:"file",path:"data/",filename:"c18fa1ca-971f-4cfa-92e9-869785260dec.json",format:"json",type:"choropleth",bins:7,palette:"Blues",schema:{name:"province1",layer:"province",id:"IdProvinciaISTAT",label:"",values:["Totale beni"]},parse:"parseInt"},{source:"file",path:"data/",filename:"69b2565e-0332-422f-ad57-b11491e33b08.json",format:"json",type:"choropleth",bins:7,palette:"Greens",schema:{name:"comuni1",layer:"comuni",id:"IdComuneISTAT",label:"",values:["Totale beni"]},parse:"parseInt"}],pointsSet:{active:!1,source:"dkan",clusters:!0,icon:"img/marker-icon.png",shadow:"img/marker-shadow.png"},infowindow:{active:!0,content:{"default":'<p>La mappa mostra il numero di beni confiscati per tutti i territori amministrativi italiani, secondo i dati ufficiali dell\'<a href="http://www.benisequestraticonfiscati.it" target="_blank">ANBSC</a> (sono esclusi i beni non confiscati in via autonoma). La corrispondenza tra il gradiente di colore e il numero complessivo di beni confiscati Ã¨ dato nella legenda in basso a sinistra.</p><p>Mediante il selettore in alto a sinistra si possono caricare e visualizzare ulteriori livelli (regioni, province, comuni).</p><p>Principali funzioni della mappa: <ul><li>cerca i dati relativi al tuo territorio cliccando sulla lente e inserendo il nome di un comune;</li><li>clicca sul territorio per visualizzare i dati in dettaglio, la composizione dei beni e per scaricarne la lista completa;</li><li>includi la vista corrente della mappa sul tuo sito con il codice di embed o scaricane uno screenshot (pulsanti in alto a destra).</li></ul></p><p>Tieniti aggiornato sul progetto visitando il sito ufficiale di <a href="http://www.confiscatibene.it" target="_blank">Confiscati Bene</a> o seguendo l\'account Twitter <a href="https://twitter.com/confiscatibene" target="_blank">@confiscatibene</a>, puoi anche scriverci all\'indirizzo <a href="mailto:info@confiscatibene.it" target="_blank">info@confiscatibene.it</a>.</p>',mobile:'<a href="mailto:info@confiscatibene.it" target="_blank" style="margin-right: 30px;">Info</a>'},downloads:{active:!1,license:'Creative Commons Attribution <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0 International</a>.',files:[{active:!0,source:"dkan",resourceId:"e5b4d63a-e1e8-40a3-acec-1d351f03ee56",name:"immobili",filebase:"confiscatibene",title:"Scarica l'elenco degli immobili",image:"img/house109-dnl.png"},{active:!0,source:"dkan",resourceId:"8b7e12f1-6484-47f0-9cf6-88b446297dbc",name:"aziende",filebase:"confiscatibene",title:"Scarica l'elenco delle aziende",image:"img/factory6-dnl.png"}]},shareButtons:{active:!0,title:"Condividi la situazione",twitter:{active:!0,via:"confiscatibene",text:"Immobili e aziende #confiscatibene"},facebook:{active:!0},gplus:{active:!0},linkedin:{active:!0},email:{active:!0,subject:"Confiscati Bene",body:"Gli immobili e le aziende #confiscatibene"},permalink:{active:!0}},view:{active:!0,type:"table",options:{bold:function(a){return a.indexOf("Totale")>-1},filter:function(a,b){return"0"!=b&&a.charAt(0)==a.charAt(0).toUpperCase()&&"Id"!=a.slice(0,2)},transform:function(a,b){return parseInt(b)||b}}}},controls:{fullscreen:{active:!0,title:"Fullscreen mode"},logo:{active:!0,title:"",image:"img/logo.png",link:"http://www.confiscatibene.it/"},reset:{active:!0,title:"Reset",image:"img/reset.png"},embed:{active:!0,title:"Embed this map",image:"img/embed.png",permalink:!0,shorturl:!0,iframe:!0,widget:!0,shortcode:!0,svg:{active:!0,filename:"confiscatibene_map.svg",image:"img/svg.png"}},screenshot:{active:!0,title:"Take a screenshot",image:"img/screenshot.png",filename:"confiscatibene_map.png"},detach:{active:!0,title:"Open in new window",image:"img/detach.png"},socialButtons:{active:!1,twitter:{active:!0,via:"confiscatibene",lang:"it",related:"jenkin27:Data scientist at Dataninja",hashtags:"confiscatibene,dataninja",count:"vertical",text:"Tweet"},facebook:{active:!0,appId:"470290923072583",layout:"box_count",action:"like","show-faces":!1,share:!1},gplus:{active:!0,size:"tall",annotation:"bubble"}},geocoder:{active:!1,layer:"comuni",collapsed:!0,title:"Cerca il tuo comune",email:"jenkin@dataninja.it",zoom:10,autocomplete:{active:!1,domain:"",path:"geo/",filename:"lista_comuni.json",prefix:"lista_comuni-",format:"json",url:function(a){return this.domain+this.path+(a?this.prefix+a+"."+this.format:this.filename)},transform:function(a){return a}}}},dataSources:{file:{domain:"",path:"",filename:"",format:"",url:function(a,b,c){return this.domain+this.path+(this.filename||a+(b&&c?"_"+b+"-"+c:"")+"."+this.format)},transform:function(a){return a}},dkan:{domain:"",path:"/api/confiscatibene/action/datastore/search.json",resourceId:"",limit:5e3,format:"json",url:function(a,b,c){return this.domain+this.path+"?resource_id="+this.resourceId+(b&&c?"&filters["+b+"]="+c:"")+(this.limit?"&limit="+this.limit:"")},transform:function(a){return a.result.records}}},dataTypes:{choropleth:{palette:"Reds",bins:3},points:{}},geoSources:{file:{domain:"",path:"",format:"json",filename:"",url:function(a,b,c){return this.domain+this.path+(this.filename||a+(b&&c?"_"+b+"-"+c:"")+"."+this.format)},transform:function(a){return a.features}},tileserver:{domain:"http://{s}.tile.openstreetmap.org",path:"/{z}/{x}/{y}.png",url:function(){return this.domain+this.path}}},geoTypes:{tile:{active:!0,source:"tileserver",options:{attribution:"",opacity:.7}},vector:{active:!0,style:{"default":{weight:.5,opacity:1,color:"white",fillOpacity:.7,fillColor:"none"},highlight:{},selected:{weight:2,color:"#666"}}}},viewTypes:{table:function(a,b){if(!a)return"";var c,d={include:[],exclude:[],bold:function(){return!1},filter:function(){return!0},transform:function(a,b){return b}},b=b||{},e="";for(c in d)d.hasOwnProperty(c)&&!b.hasOwnProperty(c)&&(b[c]=d[c]);for(c in a)if(a.hasOwnProperty(c)&&(!b.include.length||b.include.indexOf(c)>-1)&&!(b.exclude.length&&b.exclude.indexOf(c)>-1)&&b.filter(c,a[c])){var f=b.transform(c,a[c]),g=b.bold(c,a[c]);e+="<tr><td>"+(g?"<b>"+c+"</b>":c)+"</td><td>"+(g?"<b>"+f+"</b>":f)+"</td></tr>"}return e}}};!function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){for(var d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){var c=b.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=I[c].map(function(a){return a.active}).indexOf(!0),f=d.style.default;return f.fillColor=a(b.properties.data[I[c][e].name][I[c][e].value],I[c][e].bins,I[c][e].palette),f}function c(a){var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=I[d].map(function(a){return a.active}).indexOf(!0),g=e.style.highlight;b.selected||b.setStyle(g),D.hasOwnProperty("label")&&D.label.active&&($.setContent(c[G[d].label]+"<br>"+D.label.text+": "+c.data[I[d][f].name][I[d][f].value]),$.setLatLng(b.getBounds().getCenter()),n.showLabel($))}function d(a){{var b=a.target,c=b.feature.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||Z.eachLayer(function(a){a.selected||Z.resetStyle(a)}),D.hasOwnProperty("label")&&D.label.active&&$.close()}function e(a,b){D.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;Z.eachLayer(function(a){a.selected=!1,Z.resetStyle(a)}),b.selected=!0,b.setStyle(e),E.i=b.feature.properties[G[E.dl].id],t&&t.isAdded&&t.removeFrom(n),o.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){b.on({mouseover:c,mouseout:d,click:e})}function g(a){D.debug&&console.log("joinDataFunction",arguments);for(var b,c,d=0;d<G[a].resource.length;d++){b=G[a].resource[d].properties[G[a].id],G[a].resource[d].properties.data={};for(var e=0;e<I[a].length;e++){I[a][e].active=!e;for(var f=0;f<I[a][e].resource.length;f++){var c=I[a][e].resource[f][I[a][e].id];if(c==b){G[a].resource[d].properties.data[I[a][e].name]=I[a][e].resource[f];for(var g in G[a].resource[d].properties.data[I[a][e].name])G[a].resource[d].properties.data[I[a][e].name].hasOwnProperty(g)&&(G[a].resource[d].properties.data[I[a][e].name][g]=I[a][e].parse(G[a].resource[d].properties.data[I[a][e].name][g]));G[a].resource[d].properties._layer=a}}}d3.keys(G[a].resource[d].properties.data).length||(G[a].resource.splice(d,1),d--)}}function h(a){D.debug&&console.log("binDataFunction",arguments);var b=I[a].map(function(a){return a.active}).indexOf(!0),c=I[a][b].value,d=(D.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],D.dataSets.filter(function(b){return b.schema.layer===a})[b]),e=I[a][b].resource.map(function(a){return a[c]}),f=new geostats(e);I[a][b].bins=f.getJenks(e.length>d.bins?d.bins:e.length-1),I[a][b].ranges=f.ranges,A.update(a)}function i(a,b){D.debug&&console.log("loadDataFunction",arguments);var c,d,f,i=D.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],j=D.dataSets.filter(function(b){return b.schema.layer===a});if(d3.selectAll("nav#geomenu-ui a").classed("active",!1),d3.select("nav#geomenu-ui a#"+a).classed("active",!0),d3.selectAll("nav#datamenu-ui a").classed("active",!1),d3.select("nav#datamenu-ui a#"+(b||j[0].schema.name)).classed("active",!0),d3.select("nav#datamenu-ui select").attr("disabled",null),E.dl=a,Z.clearLayers(),D.debug&&console.log("geoLayer",i),D.debug&&console.log("dataSets",j),G[a].resource)console.log(G[a].resource),h(a),Z.addData(G[a].resource),delete E.i,t&&t.isAdded&&t.removeFrom(n),A.update(a),o.update();else{n.spin(!0),f=queue(),c=i.url.call(i,a,E.t?E.tl:void 0,E.t||void 0),f.defer(d3[i.format],c),D.debug&&console.log("geoPath",c);for(var l=0;l<j.length;l++)d=j[l].url.call(j[l],a,E.t?H[E.tl].id:void 0,E.t||void 0),f.defer(d3[j[l].format],d),D.debug&&console.log("dataPath",l,d);f.await(function(b,c){D.debug&&console.log("await",arguments),G[a].resource=i.transform(c);for(var d=2;d<arguments.length;d++)I[a][d-2].resource=j[d-2].transform(arguments[d]);n.spin(!1),g(a),h(a),Z.addData(G[a].resource),k||(k=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),E.t&&n.fitBounds(Z.getBounds()),E.i&&Z.eachLayer(function(b){b.feature.properties[G[a].id]==E.i&&e(null,b)})})}}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=mapConfig,E=Arg.query(),F={},G={},H={},I={},J=L.control.attribution();for(l=0;l<D.geoLayers.length;l++){C=D.geoTypes[D.geoLayers[l].type];for(m in C)if(C.hasOwnProperty(m))if(D.geoLayers[l].hasOwnProperty(m)){if("object"==typeof C[m])for(var K in C[m])C[m].hasOwnProperty(K)&&!D.geoLayers[l][m].hasOwnProperty(K)&&(D.geoLayers[l][m][K]=C[m][K])}else D.geoLayers[l][m]=C[m];B=D.geoSources[D.geoLayers[l].source];for(m in B)B.hasOwnProperty(m)&&!D.geoLayers[l].hasOwnProperty(m)&&(D.geoLayers[l][m]=B[m]);D.geoLayers[l].active||(D.geoLayers.splice(l,1),l--)}for(l=0;l<D.dataSets.length;l++){C=D.dataTypes[D.dataSets[l].type];for(m in C)C.hasOwnProperty(m)&&!D.dataSets[l].hasOwnProperty(m)&&(D.dataSets[l][m]=C[m]);B=D.dataSources[D.dataSets[l].source];for(m in B)B.hasOwnProperty(m)&&!D.dataSets[l].hasOwnProperty(m)&&(D.dataSets[l][m]=B[m]);var M=D.geoLayers.filter(function(a){return a.hasOwnProperty("schema")&&a.schema.name===D.dataSets[l].schema.layer});M.length&&M[0].active||(D.dataSets.splice(l,1),l--)}if(D.hasOwnProperty("infowindow")&&D.infowindow.active&&D.infowindow.hasOwnProperty("downloads")&&D.infowindow.downloads.active)for(l=0;l<D.infowindow.downloads.files.length;l++)if(D.infowindow.downloads.files[l].active){B=D.dataSources[D.infowindow.downloads.files[l].source];for(m in B)B.hasOwnProperty(m)&&!D.infowindow.downloads.files[l].hasOwnProperty(m)&&(D.infowindow.downloads.files[l][m]=B[m])}if(D.hasOwnProperty("pointsSet")&&D.pointsSet.active){B=D.dataSources[D.pointsSet.source];for(m in B)B.hasOwnProperty(m)&&!D.pointsSet.hasOwnProperty(m)&&(D.pointsSet[m]=B[m])}for(D.debug&&console.log("$",D),D.hasOwnProperty("urlShortener")&&D.urlShortener.active&&(j=yourls.connect(D.urlShortener.url.call(D.urlShortener),{signature:D.urlShortener.signature})),D.debug&&console.log("dtnj",j),l=0;l<D.geoLayers.length;l++)"vector"===D.geoLayers[l].type&&(F[D.geoLayers[l].schema.name]={id:D.geoLayers[l].schema.id,label:D.geoLayers[l].schema.label,resource:null,list:[]});for(D.debug&&console.log("defaultGeo",F),l=0;l<D.dataSets.length;l++)if(H[D.dataSets[l].schema.name]={id:D.dataSets[l].schema.id,label:D.dataSets[l].schema.label,value:"string"==typeof D.dataSets[l].schema.values?D.dataSets[l].schema.values:D.dataSets[l].schema.values[0],values:"string"==typeof D.dataSets[l].schema.values?[D.dataSets[l].schema.values]:D.dataSets[l].schema.values,layer:D.dataSets[l].schema.layer,name:D.dataSets[l].schema.name,resourceId:D.dataSets[l].resourceId,resource:null,bins:[],ranges:[],palette:D.dataSets[l].palette,active:!1},"string"==typeof D.dataSets[l].parse){var N=D.dataSets[l].parse;H[D.dataSets[l].schema.name].parse=function(a){return isNaN(window[N](a))?a:window[N](a)}}else H[D.dataSets[l].schema.name].parse="function"==typeof D.dataSets[l].parse?D.dataSets[l].parse:function(a){return isNaN(parseFloat(a))?a:parseFloat(a)};for(D.debug&&console.log("defaultData",H),E.ls=E.ls||d3.keys(F),E.ml=E.ls[0],E.dl=E.dl||E.ml,E.md=E.md||(head.mobile?"mobile":""),d3.select("body").classed(E.md,!0),E.t&&(E.tl=E.tl||E.ml,E.ml=E.ls[E.ls.indexOf(E.tl)+1],E.ls.indexOf(E.dl)<E.ls.indexOf(E.tl)+1&&(E.dl=E.ml)),D.hasOwnProperty("pointsSet")&&D.pointsSet.active&&E.mr&&E.mr.hasOwnProperty("rid")&&(D.pointsSet.resourceId=E.mr.rid,E.mr.lat=E.mr.lat||"lat",E.mr.lng=E.mr.lng||"lng"),D.debug&&console.log("parameters",E),l=E.ls.indexOf(E.ml);l<E.ls.length;l++)if(F.hasOwnProperty(E.ls[l])){var O=[];for(m in H)H.hasOwnProperty(m)&&H[m].layer===E.ls[l]&&O.push(H[m]);O.length&&(G[E.ls[l]]=F[E.ls[l]],I[E.ls[l]]=O)}D.debug&&console.log("geo",G),D.debug&&console.log("data",I);var P=L.latLng(D.map.bounds.init.southWest),Q=L.latLng(D.map.bounds.init.northEast),R=L.latLngBounds(P,Q),S=L.latLng(D.map.bounds.max.southWest),T=L.latLng(D.map.bounds.max.northEast),U=L.latLngBounds(S,T);n=L.map("map",{maxZoom:D.map.zoom.max,minZoom:D.map.zoom.min,scrollWheelZoom:D.map.zoom.scrollWheel,attributionControl:!D.map.attribution.length,maxBounds:U}),D.debug&&console.log("map",n),n.fitBounds(R);var V=D.geoLayers.filter(function(a){return"tile"===a.type});for(D.debug&&console.log("tileLayers",V),l=0;l<V.length;l++)L.tileLayer(V[l].url.call(V[l]),V[l].options).addTo(n);for(n.spin(!0),l=0;l<D.map.attribution.length;l++)J.addAttribution(D.map.attribution[l]);D.debug&&console.log("attrib",J),J.addTo(n),D.hasOwnProperty("infowindow")&&D.infowindow.active&&("widget"===E.md?(o={},o._div=d3.select("body").append("div").attr("id","infowindow").classed("info",!0).node()):(o=L.control({position:"bottomright"}),o.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+E.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),o.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===E.md&&n.dragging.disable();var b,c,d,e=agnes.rowDelimiter(),f=new Date,g=d3.time.format("%Y%m%d")(f),h=a._layer,i=I[h].map(function(a){return a.active}).indexOf(!0),k=I[h][i].id,m=a[G[h].id],p=[],q=[];if(D.infowindow.hasOwnProperty("shareButtons")&&D.infowindow.shareButtons.active&&(b=D.infowindow.shareButtons.title+("regioni"==h?" in ":" a ")+a[G[h].label],c="http://"+location.hostname+Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[G[h].label],D.infowindow.shareButtons.hasOwnProperty("twitter")&&D.infowindow.shareButtons.twitter.active&&p.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+D.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),D.infowindow.shareButtons.hasOwnProperty("facebook")&&D.infowindow.shareButtons.facebook.active&&p.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),D.infowindow.shareButtons.hasOwnProperty("gplus")&&D.infowindow.shareButtons.gplus.active&&p.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),D.infowindow.shareButtons.hasOwnProperty("linkedin")&&D.infowindow.shareButtons.linkedin.active&&p.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),D.infowindow.shareButtons.hasOwnProperty("email")&&D.infowindow.shareButtons.email.active&&p.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(D.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),D.infowindow.shareButtons.hasOwnProperty("permalink")&&D.infowindow.shareButtons.permalink.active&&p.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>')),D.debug&&console.log("shareButtons",p),D.infowindow.hasOwnProperty("downloads")&&D.infowindow.downloads.active)for(l=0;l<D.infowindow.downloads.files.length;l++)D.infowindow.downloads.files[l].active&&q.push('<a id="a-'+D.infowindow.downloads.files[l].name+'" class="dnl" href="#" title="'+D.infowindow.downloads.files[l].title+'"><img src="'+D.infowindow.downloads.files[l].image+'" /></a>');D.debug&&console.log("downloadButtons",q);var r="<thead><tr><th>"+(q.length?'<span id="sdnlBtn">'+q.join("&nbsp;")+"</span>&nbsp;&nbsp;":"")+(p.length?'<span id="sshrBtn">'+p.join("&nbsp;")+"</span>":"")+'</th><th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[G[h].label]+"</th></tr></thead>";D.debug&&console.log("Table header",r);var s;s=D.infowindow.hasOwnProperty("downloads")&&D.infowindow.downloads.active?'<tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">'+(D.infowindow.downloads.license||"")+"</td></tr></tfoot>":"<tfoot></tfoot>",D.debug&&console.log("Table footer",s);var u;if(D.infowindow.hasOwnProperty("view")&&D.infowindow.view.active&&D.viewTypes.hasOwnProperty(D.infowindow.view.type)?(u=D.viewTypes[D.infowindow.view.type](a.data[I[h][i].name],D.infowindow.view.options),u.indexOf("<tbody>")>-1||(u="<tbody>"+u+"</tbody>")):u="<tbody></tbody>",D.debug&&console.log("Table body",u),this._div.innerHTML+='<table class="zebra">'+r+u+s+"</table>",D.debug&&console.log("Table",this._div.innerHTML),D.infowindow.hasOwnProperty("shareButtons")&&D.infowindow.shareButtons.active&&D.hasOwnProperty("urlShortener")&&D.urlShortener.active&&j.shorten(btnEncUrl,D.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];D.infowindow.shareButtons.hasOwnProperty("twitter")&&D.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+D.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),D.infowindow.shareButtons.hasOwnProperty("facebook")&&D.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),D.infowindow.shareButtons.hasOwnProperty("gplus")&&D.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),D.infowindow.shareButtons.hasOwnProperty("linkedin")&&D.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),D.infowindow.shareButtons.hasOwnProperty("email")&&D.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(D.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),D.infowindow.shareButtons.hasOwnProperty("permalink")&&D.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),D.infowindow.hasOwnProperty("downloads")&&D.infowindow.downloads.active)for(l=0;l<D.infowindow.downloads.files.length;l++)D.infowindow.downloads.files[l].active&&!function(a){var b=D.infowindow.downloads.files[a].url.call(D.infowindow.downloads.files[a],h,k,m),c=g+"_"+D.infowindow.downloads.files[a].filebase+"-"+D.infowindow.downloads.files[a].name+(k&&m?"_"+k+"-"+m:"")+".csv";d3.select("a#a-"+D.infowindow.downloads.files[a].name).on("click",function(){D.debug&&console.log(this,a,D.infowindow.downloads.files[a].name,b,c),d3[D.infowindow.downloads.files[a].format](b,function(b,d){var f=D.infowindow.downloads.files[a].transform(d);if(f.length>0){var g=agnes.jsonToCsv(f,e),h=new Blob([g],{type:"text/csv;charset=utf-8"});saveAs(h,c)}else alert("No data!")})})}(l);d3.select(this._div).select("a#close-cross").on("click",function(){return D.debug&&console.log("clickCloseCross",arguments),Z.eachLayer(function(a){a.selected=!1,Z.resetStyle(a)}),delete E.i,t&&t.isAdded&&t.removeFrom(n),o.update(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===E.md?(n.dragging.enable(),this._div.innerHTML+=D.infowindow.content.mobile):this._div.innerHTML+=D.infowindow.content.default},"widget"===E.md?o.update():o.addTo(n)),D.debug&&console.log("info",o),D.controls.hasOwnProperty("fullscreen")&&D.controls.fullscreen.active&&"widget"!=E.md&&"embed"!=E.md&&(p=L.control.fullscreen({title:D.controls.fullscreen.title}).addTo(n)),D.debug&&console.log("fullscreen",p),D.controls.hasOwnProperty("logo")&&D.controls.logo.active&&("widget"===E.md?q=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+E.md,!0).attr("href",D.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",D.controls.logo.image):(q=L.control({position:"topleft"}),q.onAdd=function(){var a=L.DomUtil.create("a","logo "+E.md),b=L.DomUtil.create("img","logo",a);return a.setAttribute("href",D.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",D.controls.logo.image),a},q.addTo(n))),D.debug&&console.log("logo",q),D.controls.hasOwnProperty("reset")&&D.controls.reset.active&&(r=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),r.onAdd=function(a){var b=L.DomUtil.create("img","reset "+E.md);return b.setAttribute("src",D.controls.reset.image),b.setAttribute("title",D.controls.reset.title),d3.select(b).on("click",function(){i(E.ml),a.fitBounds(R)}),b},r.addTo(n)),D.debug&&console.log("reset",r),D.controls.hasOwnProperty("embed")&&D.controls.embed.active&&(t=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),t.isAdded=!1,t.onRemove=function(){this.isAdded=!1},t.onAdd=function(){this.isAdded=!0;var a={},b=L.DomUtil.create("div","info embed-inputarea"),c="http://"+location.hostname+Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),d="http://"+location.hostname+encodeURIComponent(Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));D.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",b),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+c+'" readonly></input>'),D.hasOwnProperty("urlShortener")&&D.urlShortener.active&&D.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",b),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',j.shorten(d,D.urlShortener.prefix+md5(c),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),D.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",b),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+c+'&md=embed&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),D.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",b),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+c+'&md=widget&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),D.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",b),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(c).replace(/^[^?]+\?/,"").replace(/&/g," ")+' md=embed]" readonly></input>'),D.controls.embed.hasOwnProperty("svg")&&D.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",b),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+D.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,D.controls.embed.svg.filename)}));for(var e in a)a.hasOwnProperty(e)&&d3.select(a[e]).select("input").on("focus",function(){this.select()});return b},s=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),s.onAdd=function(a){var b=L.DomUtil.create("img","embed "+E.md);return b.setAttribute("src",D.controls.embed.image),b.setAttribute("title",D.controls.embed.title),d3.select(b).on("click",function(){t.isAdded?t&&t.isAdded&&t.removeFrom(a):t.addTo(a)}),b},s.addTo(n)),D.debug&&console.log("embed",s),D.controls.hasOwnProperty("screenshot")&&D.controls.screenshot.active&&"widget"!=E.md&&(u=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),u.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+E.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",D.controls.screenshot.image),a.setAttribute("title",D.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=D.controls.screenshot.offsetX||"auto",d=D.controls.screenshot.offsetY||"auto";canvg(a,b.node().outerHTML,{ignoreMouse:D.controls.screenshot.ignoreMouse||!0,ignoreAnimation:D.controls.screenshot.ignoreAnimation||!0,ignoreDimensions:D.controls.screenshot.ignoreDimensions||!0,ignoreClear:D.controls.screenshot.ignoreClear||!0,offsetX:"number"==typeof c?c:k[0],offsetY:"number"==typeof d?d:k[1]}),a.toBlob(function(a){saveAs(a,D.controls.screenshot.filename)})}})}),a},u.addTo(n)),D.debug&&console.log("screenshot",u),D.controls.hasOwnProperty("detach")&&D.controls.detach.active&&("embed"===E.md||"widget"===E.md)&&(v=L.control({position:"topright"}),v.onAdd=function(){var a=L.DomUtil.create("a","detach "+E.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",D.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",D.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},v.addTo(n)),D.debug&&console.log("detach",v),D.controls.hasOwnProperty("socialButtons")&&D.controls.socialButtons.active&&(E.md||(w=L.control({position:"bottomleft"}),w.onAdd=function(){var a=L.DomUtil.create("div","share "+E.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",D.controls.socialButtons.hasOwnProperty("twitter")&&D.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+D.controls.socialButtons.twitter.via+'" data-lang="'+D.controls.socialButtons.twitter.lang+'" data-related="'+D.controls.socialButtons.twitter.related+'" data-hashtags="'+D.controls.socialButtons.twitter.hashtags+'" data-count="'+D.controls.socialButtons.twitter.count+'">'+D.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),D.controls.socialButtons.hasOwnProperty("facebook")&&D.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+D.controls.socialButtons.facebook.layout+'" data-action="'+D.controls.socialButtons.facebook.action+'" data-show-faces="'+D.controls.socialButtons.facebook["show-faces"].toString()+'" data-share="'+D.controls.socialButtons.facebook.share.toString()+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+D.controls.socialButtons.facebook.appId+"&version=v2.0")),D.controls.socialButtons.hasOwnProperty("gplus")&&D.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+D.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+D.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a
},w.addTo(n))),D.debug&&console.log("share",w);var W=D.geoLayers.filter(function(a){return"tile"!=a.type});if(W.length>1&&(x=L.control({position:"topleft"}),x.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+E.md);return a.setAttribute("id","geomenu-ui"),"widget"===E.md&&a.setAttribute("style","display:none;"),a},x.addTo(n),d3.select("nav#geomenu-ui").selectAll("a").data(W.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).classed("disabled",function(a){return!G.hasOwnProperty(a.name)}).on("click",function(a,b){if(G.hasOwnProperty(a.name)){var c=a.name;I[c][0].active=!0;for(var b=0;b<I[c].length;b++)0!=b&&(I[c][b].active=!1);delete E.i,t&&t.isAdded&&t.removeFrom(n),o.update(),A.update(),y.update(a.name),y.onChange(I[a.name][0].values),i(a.name)}}).text(function(a){return a.menu})),D.debug&&console.log("menuGeoLayers",W),D.debug&&console.log("geoMenu",x),y=L.control({position:"topleft"}),y.onAdd=function(a){var b=L.DomUtil.create("nav","menu-ui "+E.md);return b.setAttribute("id","datamenu-ui"),"widget"===E.md&&b.setAttribute("style","display:none;"),this._nav=b,d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},y.onChange=function(a,b){d3.select(this._nav).select("select").remove();var b=b||0,c=I[a][b].values;c&&c.length>1&&d3.select(this._nav).append("select").attr("disabled","disabled").on("change",function(){var c=d3.select(this).property("selectedIndex"),d=d3.select(this).selectAll("option")[0][c].__data__;I[a][b].value=d,i(a,I[a][b].name)}).selectAll("option").data(c).enter().append("option").text(function(a){return a})},y.update=function(a){if(d3.select(this._nav).style("display",null).selectAll("a, select").remove(),a){var b=D.dataSets.filter(function(b){return b.schema.layer===a});b.length>1?d3.select(this._nav).selectAll("a").data(b.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).on("click",function(a,b){var c=a.layer;I[c][b].active=!0;for(var d=0;d<I[c].length;d++)d!=b&&(I[c][d].active=!1);delete E.i,t&&t.isAdded&&t.removeFrom(n),o.update(),A.update(),y.onChange(c,b),i(c,a.name)}).text(function(a){return a.menu}):d3.select(this._nav).style("display","none")}},y.addTo(n),y.update(W[0].schema.name),y.onChange(W[0].schema.name),D.debug&&console.log("dataMenu",y),D.controls.hasOwnProperty("geocoder")&&D.controls.geocoder.active&&"widget"!=E.md&&"mobile"!=E.md&&(z=new L.Control.OSMGeocoder({collapsed:D.controls.geocoder.collapsed,position:"topleft",text:D.controls.geocoder.title,bounds:R,email:D.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete E.i,t&&t.isAdded&&t.removeFrom(n),o.update(),i(D.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:D.controls.geocoder.zoom})}}}),n.addControl(z),D.controls.geocoder.hasOwnProperty("autocomplete")&&D.controls.geocoder.autocomplete.active)){z._completely=completely(z._input),z._completely.onChange=function(a){z._completely.startFrom=a.lastIndexOf(" ")+1,z._completely.repaint()},z._completely.input.maxLength=50;var X=D.controls.geocoder.autocomplete.url.call(D.controls.geocoder.autocomplete,E.t||void 0);d3[D.controls.geocoder.autocomplete.format](X,function(a,b){F[D.controls.geocoder.layer].list=D.controls.geocoder.autocomplete.transform(b),z._completely.options=F[D.controls.geocoder.layer].list.map(function(a){return a[G[D.controls.geocoder.layer].label]})})}if(D.debug&&console.log("osmGeocoder",z),D.hasOwnProperty("legend")&&D.legend.active&&(A=L.control({position:"bottomleft"}),A.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+E.md),this._div},A.update=function(a){if(a){var b=I[a].map(function(a){return a.active}).indexOf(!0),c=D.dataSets.filter(function(b){return b.schema.layer===a})[b],d=I[a][b].ranges;this._div.innerHTML="widget"!=E.md?'<h4 title="'+D.legend.description+'">'+D.legend.title+"</h4>":"";for(var e=0;e<d.length;e++){var f=colorbrewer[c.palette][d.length]?colorbrewer[c.palette][d.length][e]:colorbrewer[c.palette][3][e];this._div.innerHTML+='<i title="Tra '+d[e].replace("-","e")+" "+D.legend.itemLabel+'" style="background:'+f+'"></i> '+("widget"!=E.md?d[e]:"")+"<br>"}"widget"!=E.md&&(this._div.innerHTML+="<br>"+D.legend.description)}else this._div.innerHTML="widget"!=E.md?"<h4>"+D.legend.title+"</h4>":""},A.addTo(n),A.update()),D.debug&&console.log("legend",A),D.pointsSet&&D.pointsSet.active&&D.pointsSet.resourceId){var Y=D.pointsSet.url.call(D.pointsSet);D.debug&&console.log("markersPath",Y),d3[D.pointsSet.format](Y,function(a,b){D.debug&&console.log("markers",arguments);var c=b?D.pointsSet.transform(b):null;if(c){for(var d=new L.MarkerClusterGroup({showCoverageOnHover:!1}),e=[],f=0;f<c.length;f++){var g=L.marker();g.setIcon(L.icon({iconUrl:D.pointsSet.icon,shadowUrl:D.pointsSet.shadow})),g.setLatLng(L.latLng(c[f][E.mr.lat],c[f][E.mr.lng])),E.mr.hasOwnProperty("iw")&&g.bindPopup(c[f][E.mr.iw]),e.push(g),d.addLayer(g)}n.addLayer(D.pointsSet.clusters?d:L.layerGroup(e))}})}var Z,$=new L.Label;Z=L.geoJson("",{style:b,onEachFeature:f}).addTo(n),D.debug&&console.log("geojson",Z),setTimeout(function(){n.spin(!1),i(E.dl)},3e3)})}(mapConfig);