/*! dataninja-advanced-mapping-tool 11-11-2014 */
var mapConfig={debug:!0,urlShortener:{active:!1,domain:"",path:"/api/dtnj/yourls-api.php",signature:"efe758b8d3",prefix:"confiscatibene-",url:function(){return this.domain+this.path}},map:{bounds:{init:{southWest:{lat:35.568,lng:1.537},northEast:{lat:47.843,lng:23.203}},max:{southWest:{lat:22.472,lng:-16.523},northEast:{lat:62.083,lng:73.828}}},zoom:{max:13,min:5,scrollWheel:!0},attribution:['Powered by <a href="http://www.dataninja.it/" target="_blank">Dataninja</a>','tileset from <a href="http://www.geoiq.com/" target="_blank">GeoIQ</a>','icons from <a href="http://www.flaticon.com/" target="_blank">Freepik</a> and <a href="http://www.simplesharebuttons.com/" target="_blank">Simple Share Buttons</a>','geocoding by <a href="http://wiki.openstreetmap.org/wiki/Nominatim" target="_blank">OSM Nominatim</a>','code on <a href="https://github.com/Dataninja/confiscatibene-choropleth" target="_blank">GitHub</a>.']},label:{active:!0,text:"Beni confiscati"},legend:{active:!0,title:"Legenda",description:"Numero totale di beni confiscati",itemLabel:"beni confiscati"},geoLayers:[{type:"tile"},{source:"file",path:"geo/",format:"json",type:"vector",schema:{name:"regioni",id:"COD_REG",label:"NOME_REG"}},{source:"file",path:"geo/",format:"json",type:"vector",schema:{name:"province",id:"COD_PRO",label:"NOME_PRO"}},{source:"file",path:"geo/",format:"json",type:"vector",schema:{name:"comuni",id:"PRO_COM",label:"NOME_COM"}}],dataSets:[{source:"file",path:"data/",filename:"e2f0c989-929f-4e4d-87e2-097140f8880f.json",format:"json",transform:function(a){return a.result.records},type:"choropleth",bins:7,palette:"Reds",schema:{layer:"regioni",id:"IdRegioneISTAT",label:"",value:"Totale beni"}},{source:"file",path:"data/",filename:"c18fa1ca-971f-4cfa-92e9-869785260dec.json",format:"json",type:"choropleth",bins:7,palette:"Blues",schema:{layer:"province",id:"IdProvinciaISTAT",label:"",value:"Totale beni"}},{source:"file",path:"data/",filename:"69b2565e-0332-422f-ad57-b11491e33b08.json",format:"json",type:"choropleth",bins:7,palette:"Greens",schema:{layer:"comuni",id:"IdComuneISTAT",label:"",value:"Totale beni"}}],pointsSet:{active:!1,source:"dkan",clusters:!0,icon:"img/marker-icon.png",shadow:"img/marker-shadow.png"},infowindow:{active:!0,content:{"default":'<p>La mappa mostra il numero di beni confiscati per tutti i territori amministrativi italiani, secondo i dati ufficiali dell\'<a href="http://www.benisequestraticonfiscati.it" target="_blank">ANBSC</a> (sono esclusi i beni non confiscati in via autonoma). La corrispondenza tra il gradiente di colore e il numero complessivo di beni confiscati Ã¨ dato nella legenda in basso a sinistra.</p><p>Mediante il selettore in alto a sinistra si possono caricare e visualizzare ulteriori livelli (regioni, province, comuni).</p><p>Principali funzioni della mappa: <ul><li>cerca i dati relativi al tuo territorio cliccando sulla lente e inserendo il nome di un comune;</li><li>clicca sul territorio per visualizzare i dati in dettaglio, la composizione dei beni e per scaricarne la lista completa;</li><li>includi la vista corrente della mappa sul tuo sito con il codice di embed o scaricane uno screenshot (pulsanti in alto a destra).</li></ul></p><p>Tieniti aggiornato sul progetto visitando il sito ufficiale di <a href="http://www.confiscatibene.it" target="_blank">Confiscati Bene</a> o seguendo l\'account Twitter <a href="https://twitter.com/confiscatibene" target="_blank">@confiscatibene</a>, puoi anche scriverci all\'indirizzo <a href="mailto:info@confiscatibene.it" target="_blank">info@confiscatibene.it</a>.</p>',mobile:'<a href="mailto:info@confiscatibene.it" target="_blank" style="margin-right: 30px;">Info</a>'},downloads:{active:!1,license:'Creative Commons Attribution <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0 International</a>.',files:[{active:!0,source:"dkan",resourceId:"e5b4d63a-e1e8-40a3-acec-1d351f03ee56",name:"immobili",filebase:"confiscatibene",title:"Scarica l'elenco degli immobili",image:"img/house109-dnl.png"},{active:!0,source:"dkan",resourceId:"8b7e12f1-6484-47f0-9cf6-88b446297dbc",name:"aziende",filebase:"confiscatibene",title:"Scarica l'elenco delle aziende",image:"img/factory6-dnl.png"}]},shareButtons:{active:!0,title:"Condividi la situazione",twitter:{active:!0,via:"confiscatibene",text:"Immobili e aziende #confiscatibene"},facebook:{active:!0},gplus:{active:!0},linkedin:{active:!0},email:{active:!0,subject:"Confiscati Bene",body:"Gli immobili e le aziende #confiscatibene"},permalink:{active:!0}},view:{active:!0,type:"table",options:{bold:function(a){return a.indexOf("Totale")>-1},filter:function(a,b){return"0"!=b&&a.charAt(0)==a.charAt(0).toUpperCase()&&"Id"!=a.slice(0,2)},transform:function(a,b){return parseInt(b)||b}}}},controls:{fullscreen:{active:!0,title:"Fullscreen mode"},logo:{active:!0,title:"",image:"img/logo.png",link:"http://www.confiscatibene.it/"},reset:{active:!0,title:"Reset",image:"img/reset.png"},embed:{active:!0,title:"Embed this map",image:"img/embed.png",permalink:!0,shorturl:!0,iframe:!0,widget:!0,shortcode:!0,svg:{active:!0,filename:"confiscatibene_map.svg",image:"img/svg.png"}},screenshot:{active:!0,title:"Take a screenshot",image:"img/screenshot.png",filename:"confiscatibene_map.png"},detach:{active:!0,title:"Open in new window",image:"img/detach.png"},socialButtons:{active:!1,twitter:{active:!0,via:"confiscatibene",lang:"it",related:"jenkin27:Data scientist at Dataninja",hashtags:"confiscatibene,dataninja",count:"vertical",text:"Tweet"},facebook:{active:!0,appId:"470290923072583",layout:"box_count",action:"like","show-faces":!1,share:!1},gplus:{active:!0,size:"tall",annotation:"bubble"}},geocoder:{active:!1,layer:"comuni",collapsed:!0,title:"Cerca il tuo comune",email:"jenkin@dataninja.it",zoom:10,autocomplete:{active:!1,domain:"",path:"geo/",filename:"lista_comuni.json",prefix:"lista_comuni-",format:"json",url:function(a){return this.domain+this.path+(a?this.prefix+a+"."+this.format:this.filename)},transform:function(a){return a}}}},dataSources:{file:{domain:"",path:"",filename:"",format:"",url:function(a,b,c){return this.domain+this.path+(this.filename||a+(b&&c?"_"+b+"-"+c:"")+"."+this.format)},transform:function(a){return a}},dkan:{domain:"",path:"/api/confiscatibene/action/datastore/search.json",resourceId:"",limit:5e3,format:"json",url:function(a,b,c){return this.domain+this.path+"?resource_id="+this.resourceId+(b&&c?"&filters["+b+"]="+c:"")+(this.limit?"&limit="+this.limit:"")},transform:function(a){return a.result.records}}},dataTypes:{choropleth:{palette:"Reds",bins:3},points:{}},geoSources:{file:{domain:"",path:"",format:"json",filename:"",url:function(a,b,c){return this.domain+this.path+(this.filename||a+(b&&c?"_"+b+"-"+c:"")+"."+this.format)},transform:function(a){return a.features}},tileserver:{domain:"http://{s}.tile.openstreetmap.org",path:"/{z}/{x}/{y}.png",url:function(){return this.domain+this.path}}},geoTypes:{tile:{active:!0,inMenu:!1,source:"tileserver",options:{attribution:"",opacity:.7}},vector:{active:!0,inMenu:!0,style:{"default":{weight:.5,opacity:1,color:"white",fillOpacity:.7,fillColor:"none"},highlight:{},selected:{weight:2,color:"#666"}}}},viewTypes:{table:function(a,b){if(!a)return"";var c,d={include:[],exclude:[],bold:function(){return!1},filter:function(){return!0},transform:function(a,b){return b}},b=b||{},e="";for(c in d)d.hasOwnProperty(c)&&!b.hasOwnProperty(c)&&(b[c]=d[c]);for(c in a)if(a.hasOwnProperty(c)&&(!b.include.length||b.include.indexOf(c)>-1)&&!(b.exclude.length&&b.exclude.indexOf(c)>-1)&&b.filter(c,a[c])){var f=b.transform(c,a[c]),g=b.bold(c,a[c]);e+="<tr><td>"+(g?"<b>"+c+"</b>":c)+"</td><td>"+(g?"<b>"+f+"</b>":f)+"</td></tr>"}return e}}};!function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){for(var c=c||"Reds",d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){var c=b.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.default;return e.fillColor=a(parseInt(b.properties.data[I[c].value]),I[c].bins,I[c].palette),e}function c(a){var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=e.style.highlight;b.selected||b.setStyle(f),D.hasOwnProperty("label")&&D.label.active&&(V.setContent(c[G[E.dl].label]+"<br>"+D.label.text+": "+c.data[I[E.dl].value]),V.setLatLng(b.getBounds().getCenter()),o.showLabel(V))}function d(a){{var b=a.target,c=b.feature.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||U.eachLayer(function(a){a.selected||U.resetStyle(a)}),D.hasOwnProperty("label")&&D.label.active&&V.close()}function e(a,b){D.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;U.eachLayer(function(a){a.selected=!1,U.resetStyle(a)}),b.selected=!0,b.setStyle(e),E.i=b.feature.properties[G[E.dl].id],u&&u.isAdded&&u.removeFrom(o),p.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){b.on({mouseover:c,mouseout:d,click:e})}function g(a){D.debug&&console.log("joinDataFunction",arguments);for(var b=(G[a].resource.length,I[a].resource.length),c=!0,d=0,e=0,f=0;f<G[a].resource.length;f++){for(var g=G[a].resource[f].properties[G[a].id],h=0;b>h;h++){var i=I[a].resource[h][I[a].id];if(i==g){d++,G[a].resource[f].properties.data=I[a].resource[h],G[a].resource[f].properties._layer=a,c=!1;break}}c?(e++,G[a].resource.splice(f,1),f--):c=!0}}function h(a){D.debug&&console.log("binDataFunction",arguments);var b=(D.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],D.dataSets.filter(function(b){return b.schema.layer===a})[0]),c=I[a].resource.map(function(b){return parseInt(b[I[a].value])}),d=new geostats(c);I[a].bins=d.getJenks(c.length>b.bins?b.bins:c.length-1),I[a].ranges=d.ranges,A.update(a)}function i(a){D.debug&&console.log("loadDataFunction",arguments);var b,c,d,f,i=D.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],j=D.dataSets.filter(function(b){return b.schema.layer===a})[0];d3.selectAll("nav#menu-ui a").classed("active",!1),d3.select("nav#menu-ui a#"+a).classed("active",!0),E.dl=a,U.clearLayers(),D.debug&&console.log("geoLayer",i),D.debug&&console.log("dataSet",j),G[a].resource&&I[a].resource?(U.addData(G[a].resource),delete E.i,u&&u.isAdded&&u.removeFrom(o),p.update()):(b=i.url.call(i,a,E.t?E.tl:void 0,E.t||void 0),c=j.url.call(j,a,E.t?H[E.tl].id:void 0,E.t||void 0),o.spin(!0),D.debug&&console.log("geoPath",b),D.debug&&console.log("dataPath",c),f=queue(),f.defer(d3[i.format],b),f.defer(d3[j.format],c),D.pointsSet.resourceId&&(d=D.pointsSet.url.call(D.pointsSet,a),D.debug&&console.log("markersPath",d),f.defer(d3[D.pointsSet.format],d)),f.await(function(b,c,d,f){if(D.debug&&console.log("await",arguments),G[a].resource=i.transform(c),I[a].resource=j.transform(d),I[a].markers=f?D.pointsSet.transform(f):null,o.spin(!1),g(a),h(a),U.addData(G[a].resource),k||(k=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),E.t&&o.fitBounds(U.getBounds()),E.i&&U.eachLayer(function(b){b.feature.properties[G[a].id]==E.i&&e(null,b)}),I[a].markers){for(var l=new L.MarkerClusterGroup({showCoverageOnHover:!1}),m=[],n=I[a].markers.result.records,p=0;p<n.length;p++){var q=L.marker();q.setIcon(L.icon({iconUrl:D.pointsSet.icon,shadowUrl:D.pointsSet.shadow})),q.setLatLng(L.latLng(n[p][E.mr.lat],n[p][E.mr.lng])),E.mr.hasOwnProperty("iw")&&q.bindPopup(n[p][E.mr.iw]),m.push(q),l.addLayer(q)}o.addLayer(D.pointsSet.clusters?l:L.layerGroup(m))}}))}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=mapConfig,E=Arg.query(),F={},G={},H={},I={},J=L.control.attribution();for(m=0;m<D.dataSets.length;m++){C=D.dataTypes[D.dataSets[m].type];for(n in C)C.hasOwnProperty(n)&&!D.dataSets[m].hasOwnProperty(n)&&(D.dataSets[m][n]=C[n]);B=D.dataSources[D.dataSets[m].source];for(n in B)B.hasOwnProperty(n)&&!D.dataSets[m].hasOwnProperty(n)&&(D.dataSets[m][n]=B[n])}if(D.hasOwnProperty("infowindow")&&D.infowindow.active&&D.infowindow.hasOwnProperty("downloads")&&D.infowindow.downloads.active)for(m=0;m<D.infowindow.downloads.files.length;m++)if(D.infowindow.downloads.files[m].active){B=D.dataSources[D.infowindow.downloads.files[m].source];for(n in B)B.hasOwnProperty(n)&&!D.infowindow.downloads.files[m].hasOwnProperty(n)&&(D.infowindow.downloads.files[m][n]=B[n])}if(D.hasOwnProperty("pointsSet")&&D.pointsSet.active){B=D.dataSources[D.pointsSet.source];for(n in B)B.hasOwnProperty(n)&&!D.pointsSet.hasOwnProperty(n)&&(D.pointsSet[n]=B[n])}for(m=0;m<D.geoLayers.length;m++){C=D.geoTypes[D.geoLayers[m].type];for(n in C)if(C.hasOwnProperty(n))if(D.geoLayers[m].hasOwnProperty(n)){if("object"==typeof C[n])for(var K in C[n])C[n].hasOwnProperty(K)&&!D.geoLayers[m][n].hasOwnProperty(K)&&(D.geoLayers[m][n][K]=C[n][K])}else D.geoLayers[m][n]=C[n];B=D.geoSources[D.geoLayers[m].source];for(n in B)B.hasOwnProperty(n)&&!D.geoLayers[m].hasOwnProperty(n)&&(D.geoLayers[m][n]=B[n])}for(D.debug&&console.log("$",D),D.hasOwnProperty("urlShortener")&&D.urlShortener.active&&(j=yourls.connect(D.urlShortener.url.call(D.urlShortener),{signature:D.urlShortener.signature})),D.debug&&console.log("dtnj",j),m=0;m<D.geoLayers.length;m++)"vector"===D.geoLayers[m].type&&(F[D.geoLayers[m].schema.name]={id:D.geoLayers[m].schema.id,label:D.geoLayers[m].schema.label,inMenu:D.geoLayers[m].inMenu,resource:null,list:[]});for(D.debug&&console.log("defaultGeo",F),m=0;m<D.dataSets.length;m++)H[D.dataSets[m].schema.layer]={id:D.dataSets[m].schema.id,label:D.dataSets[m].schema.label,value:D.dataSets[m].schema.value,resourceId:D.dataSets[m].resourceId,resource:null,markers:null,bins:[],ranges:[],palette:D.dataSets[m].palette};for(D.debug&&console.log("defaultData",H),E.ls=E.ls||d3.keys(F),E.ml=E.ls[0],E.dl=E.dl||E.ml,E.md=E.md||(head.mobile?"mobile":""),d3.select("body").classed(E.md,!0),E.t&&(E.tl=E.tl||E.ml,E.ml=E.ls[E.ls.indexOf(E.tl)+1],E.ls.indexOf(E.dl)<E.ls.indexOf(E.tl)+1&&(E.dl=E.ml)),D.hasOwnProperty("pointsSet")&&D.pointsSet.active&&E.mr&&E.mr.hasOwnProperty("rid")&&(D.pointsSet.resourceId=E.mr.rid,E.mr.lat=E.mr.lat||"lat",E.mr.lng=E.mr.lng||"lng"),D.debug&&console.log("parameters",E),m=E.ls.indexOf(E.ml);m<E.ls.length;m++)F.hasOwnProperty(E.ls[m])&&H.hasOwnProperty(E.ls[m])&&(G[E.ls[m]]=F[E.ls[m]],I[E.ls[m]]=H[E.ls[m]]);D.debug&&console.log("geo",G),D.debug&&console.log("data",I);var M=L.latLng(D.map.bounds.init.southWest),N=L.latLng(D.map.bounds.init.northEast),O=L.latLngBounds(M,N),P=L.latLng(D.map.bounds.max.southWest),Q=L.latLng(D.map.bounds.max.northEast),R=L.latLngBounds(P,Q);o=L.map("map",{maxZoom:D.map.zoom.max,minZoom:D.map.zoom.min,scrollWheelZoom:D.map.zoom.scrollWheel,attributionControl:!D.map.attribution.length,maxBounds:R}),D.debug&&console.log("map",o),o.fitBounds(O);var S=D.geoLayers.filter(function(a){return"tile"===a.type});for(D.debug&&console.log("tileLayers",S),m=0;m<S.length;m++)L.tileLayer(S[m].url.call(S[m]),S[m].options).addTo(o);for(o.spin(!0),m=0;m<D.map.attribution.length;m++)J.addAttribution(D.map.attribution[m]);if(D.debug&&console.log("attrib",J),J.addTo(o),D.hasOwnProperty("infowindow")&&D.infowindow.active&&("widget"===E.md?(p={},p._div=d3.select("body").append("div").attr("id","infowindow").classed("info",!0).node()):(p=L.control({position:"bottomright"}),p.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+E.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),p.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===E.md&&o.dragging.disable();var b,c,d,e=agnes.rowDelimiter(),f=new Date,g=d3.time.format("%Y%m%d")(f),h=E.dl,i=I[h].id,k=a[G[h].id],l=[],n=[];if(D.infowindow.hasOwnProperty("shareButtons")&&D.infowindow.shareButtons.active&&(b=D.infowindow.shareButtons.title+("regioni"==h?" in ":" a ")+a[G[h].label],c="http://"+location.hostname+Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[G[h].label],D.infowindow.shareButtons.hasOwnProperty("twitter")&&D.infowindow.shareButtons.twitter.active&&l.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+D.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),D.infowindow.shareButtons.hasOwnProperty("facebook")&&D.infowindow.shareButtons.facebook.active&&l.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),D.infowindow.shareButtons.hasOwnProperty("gplus")&&D.infowindow.shareButtons.gplus.active&&l.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),D.infowindow.shareButtons.hasOwnProperty("linkedin")&&D.infowindow.shareButtons.linkedin.active&&l.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),D.infowindow.shareButtons.hasOwnProperty("email")&&D.infowindow.shareButtons.email.active&&l.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(D.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),D.infowindow.shareButtons.hasOwnProperty("permalink")&&D.infowindow.shareButtons.permalink.active&&l.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>')),D.debug&&console.log("shareButtons",l),D.infowindow.hasOwnProperty("downloads")&&D.infowindow.downloads.active)for(m=0;m<D.infowindow.downloads.files.length;m++)D.infowindow.downloads.files[m].active&&n.push('<a id="a-'+D.infowindow.downloads.files[m].name+'" class="dnl" href="#" title="'+D.infowindow.downloads.files[m].title+'"><img src="'+D.infowindow.downloads.files[m].image+'" /></a>');D.debug&&console.log("downloadButtons",n);var q="<thead><tr><th>"+(n.length?'<span id="sdnlBtn">'+n.join("&nbsp;")+"</span>&nbsp;&nbsp;":"")+(l.length?'<span id="sshrBtn">'+l.join("&nbsp;")+"</span>":"")+'</th><th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[G[h].label]+"</th></tr></thead>";D.debug&&console.log("Table header",q);var r;r=D.infowindow.hasOwnProperty("downloads")&&D.infowindow.downloads.active?'<tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">'+(D.infowindow.downloads.license||"")+"</td></tr></tfoot>":"<tfoot></tfoot>",D.debug&&console.log("Table footer",r);var s;if(D.infowindow.hasOwnProperty("view")&&D.infowindow.view.active&&D.viewTypes.hasOwnProperty(D.infowindow.view.type)?(s=D.viewTypes[D.infowindow.view.type](a.data,D.infowindow.view.options),s.indexOf("<tbody>")>-1||(s="<tbody>"+s+"</tbody>")):s="<tbody></tbody>",D.debug&&console.log("Table body",s),this._div.innerHTML+='<table class="zebra">'+q+s+r+"</table>",D.debug&&console.log("Table",this._div.innerHTML),D.infowindow.hasOwnProperty("shareButtons")&&D.infowindow.shareButtons.active&&D.hasOwnProperty("urlShortener")&&D.urlShortener.active&&j.shorten(btnEncUrl,D.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];D.infowindow.shareButtons.hasOwnProperty("twitter")&&D.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+D.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),D.infowindow.shareButtons.hasOwnProperty("facebook")&&D.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),D.infowindow.shareButtons.hasOwnProperty("gplus")&&D.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),D.infowindow.shareButtons.hasOwnProperty("linkedin")&&D.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),D.infowindow.shareButtons.hasOwnProperty("email")&&D.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(D.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),D.infowindow.shareButtons.hasOwnProperty("permalink")&&D.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),D.infowindow.hasOwnProperty("downloads")&&D.infowindow.downloads.active)for(m=0;m<D.infowindow.downloads.files.length;m++)D.infowindow.downloads.files[m].active&&!function(a){var b=D.infowindow.downloads.files[a].url.call(D.infowindow.downloads.files[a],h,i,k),c=g+"_"+D.infowindow.downloads.files[a].filebase+"-"+D.infowindow.downloads.files[a].name+(i&&k?"_"+i+"-"+k:"")+".csv";d3.select("a#a-"+D.infowindow.downloads.files[a].name).on("click",function(){D.debug&&console.log(this,a,D.infowindow.downloads.files[a].name,b,c),d3[D.infowindow.downloads.files[a].format](b,function(b,d){var f=D.infowindow.downloads.files[a].transform(d);if(f.length>0){var g=agnes.jsonToCsv(f,e),h=new Blob([g],{type:"text/csv;charset=utf-8"});saveAs(h,c)}else alert("No data!")})})}(m);d3.select(this._div).select("a#close-cross").on("click",function(){return D.debug&&console.log("clickCloseCross",arguments),U.eachLayer(function(a){a.selected=!1,U.resetStyle(a)}),delete E.i,u&&u.isAdded&&u.removeFrom(o),p.update(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===E.md?(o.dragging.enable(),this._div.innerHTML+=D.infowindow.content.mobile):this._div.innerHTML+=D.infowindow.content.default},"widget"===E.md?p.update():p.addTo(o)),D.debug&&console.log("info",p),D.controls.hasOwnProperty("fullscreen")&&D.controls.fullscreen.active&&"widget"!=E.md&&"embed"!=E.md&&(q=L.control.fullscreen({title:D.controls.fullscreen.title}).addTo(o)),D.debug&&console.log("fullscreen",q),D.controls.hasOwnProperty("logo")&&D.controls.logo.active&&("widget"===E.md?r=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+E.md,!0).attr("href",D.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",D.controls.logo.image):(r=L.control({position:"topleft"}),r.onAdd=function(){var a=L.DomUtil.create("a","logo "+E.md),b=L.DomUtil.create("img","logo",a);return a.setAttribute("href",D.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",D.controls.logo.image),a},r.addTo(o))),D.debug&&console.log("logo",r),D.controls.hasOwnProperty("reset")&&D.controls.reset.active&&(s=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),s.onAdd=function(a){var b=L.DomUtil.create("img","reset "+E.md);return b.setAttribute("src",D.controls.reset.image),b.setAttribute("title",D.controls.reset.title),d3.select(b).on("click",function(){i(E.ml),a.fitBounds(O)}),b},s.addTo(o)),D.debug&&console.log("reset",s),D.controls.hasOwnProperty("embed")&&D.controls.embed.active&&(u=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),u.isAdded=!1,u.onRemove=function(){this.isAdded=!1},u.onAdd=function(){this.isAdded=!0;var a={},b=L.DomUtil.create("div","info embed-inputarea"),c="http://"+location.hostname+Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),d="http://"+location.hostname+encodeURIComponent(Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));D.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",b),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+c+'" readonly></input>'),D.hasOwnProperty("urlShortener")&&D.urlShortener.active&&D.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",b),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',j.shorten(d,D.urlShortener.prefix+md5(c),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),D.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",b),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+c+'&md=embed&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),D.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",b),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+c+'&md=widget&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),D.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",b),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(c).replace(/^[^?]+\?/,"").replace(/&/g," ")+' md=embed]" readonly></input>'),D.controls.embed.hasOwnProperty("svg")&&D.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",b),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+D.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,D.controls.embed.svg.filename)}));for(var e in a)a.hasOwnProperty(e)&&d3.select(a[e]).select("input").on("focus",function(){this.select()});return b},t=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),t.onAdd=function(a){var b=L.DomUtil.create("img","embed "+E.md);return b.setAttribute("src",D.controls.embed.image),b.setAttribute("title",D.controls.embed.title),d3.select(b).on("click",function(){u.isAdded?u&&u.isAdded&&u.removeFrom(a):u.addTo(a)}),b},t.addTo(o)),D.debug&&console.log("embed",t),D.controls.hasOwnProperty("screenshot")&&D.controls.screenshot.active&&"widget"!=E.md&&(v=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),v.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+E.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",D.controls.screenshot.image),a.setAttribute("title",D.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=D.controls.screenshot.offsetX||"auto",d=D.controls.screenshot.offsetY||"auto";canvg(a,b.node().outerHTML,{ignoreMouse:D.controls.screenshot.ignoreMouse||!0,ignoreAnimation:D.controls.screenshot.ignoreAnimation||!0,ignoreDimensions:D.controls.screenshot.ignoreDimensions||!0,ignoreClear:D.controls.screenshot.ignoreClear||!0,offsetX:"number"==typeof c?c:k[0],offsetY:"number"==typeof d?d:k[1]}),a.toBlob(function(a){saveAs(a,D.controls.screenshot.filename)})}})}),a},v.addTo(o)),D.debug&&console.log("screenshot",v),D.controls.hasOwnProperty("detach")&&D.controls.detach.active&&("embed"===E.md||"widget"===E.md)&&(w=L.control({position:"topright"}),w.onAdd=function(){var a=L.DomUtil.create("a","detach "+E.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",D.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",D.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},w.addTo(o)),D.debug&&console.log("detach",w),D.controls.hasOwnProperty("socialButtons")&&D.controls.socialButtons.active&&(E.md||(x=L.control({position:"bottomleft"}),x.onAdd=function(){var a=L.DomUtil.create("div","share "+E.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",D.controls.socialButtons.hasOwnProperty("twitter")&&D.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+D.controls.socialButtons.twitter.via+'" data-lang="'+D.controls.socialButtons.twitter.lang+'" data-related="'+D.controls.socialButtons.twitter.related+'" data-hashtags="'+D.controls.socialButtons.twitter.hashtags+'" data-count="'+D.controls.socialButtons.twitter.count+'">'+D.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),D.controls.socialButtons.hasOwnProperty("facebook")&&D.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+D.controls.socialButtons.facebook.layout+'" data-action="'+D.controls.socialButtons.facebook.action+'" data-show-faces="'+D.controls.socialButtons.facebook["show-faces"].toString()+'" data-share="'+D.controls.socialButtons.facebook.share.toString()+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+D.controls.socialButtons.facebook.appId+"&version=v2.0")),D.controls.socialButtons.hasOwnProperty("gplus")&&D.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+D.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+D.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a},x.addTo(o))),D.debug&&console.log("share",x),l=D.geoLayers.filter(function(a){return a.inMenu}),l.length&&(y=L.control({position:"topleft"}),y.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+E.md);return a.setAttribute("id","menu-ui"),"widget"===E.md&&a.setAttribute("style","display:none;"),a
},y.addTo(o),d3.select("nav#menu-ui").selectAll("a").data(d3.keys(F)).enter().append("a").attr("href","#").attr("id",function(a){return a}).classed("disabled",function(a){return!(G.hasOwnProperty(a)&&G[a].inMenu)}).on("click",function(a){G.hasOwnProperty(a)&&(delete E.i,u&&u.isAdded&&u.removeFrom(o),p.update(),i(a))}).text(function(a){return a})),D.debug&&console.log("menuLayers",l),D.debug&&console.log("menu",y),D.controls.hasOwnProperty("geocoder")&&D.controls.geocoder.active&&"widget"!=E.md&&"mobile"!=E.md&&(z=new L.Control.OSMGeocoder({collapsed:D.controls.geocoder.collapsed,position:"topleft",text:D.controls.geocoder.title,bounds:O,email:D.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete E.i,u&&u.isAdded&&u.removeFrom(o),p.update(),i(D.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:D.controls.geocoder.zoom})}}}),o.addControl(z),D.controls.geocoder.hasOwnProperty("autocomplete")&&D.controls.geocoder.autocomplete.active)){z._completely=completely(z._input),z._completely.onChange=function(a){z._completely.startFrom=a.lastIndexOf(" ")+1,z._completely.repaint()},z._completely.input.maxLength=50;var T=D.controls.geocoder.autocomplete.url.call(D.controls.geocoder.autocomplete,E.t||void 0);d3[D.controls.geocoder.autocomplete.format](T,function(a,b){F[D.controls.geocoder.layer].list=D.controls.geocoder.autocomplete.transform(b),z._completely.options=F[D.controls.geocoder.layer].list.map(function(a){return a[G[D.controls.geocoder.layer].label]})})}D.debug&&console.log("osmGeocoder",z),D.hasOwnProperty("legend")&&D.legend.active&&(A=L.control({position:"bottomleft"}),A.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+E.md),this._div.innerHTML="widget"!=E.md?"<h4>"+D.legend.title+"</h4>":"",this._div},A.update=function(a){var b=I[a].ranges;this._div.innerHTML="widget"!=E.md?'<h4 title="'+D.legend.description+'">'+D.legend.title+"</h4>":"";for(var c=0;c<b.length;c++){var d=colorbrewer.Reds[b.length]?colorbrewer.Reds[b.length][c]:colorbrewer.Reds[3][c];this._div.innerHTML+='<i title="Tra '+b[c].replace("-","e")+" "+D.legend.itemLabel+'" style="background:'+d+'"></i> '+("widget"!=E.md?b[c]:"")+"<br>"}"widget"!=E.md&&(this._div.innerHTML+="<br>"+D.legend.description)},A.addTo(o)),D.debug&&console.log("legend",A);var U,V=new L.Label;U=L.geoJson("",{style:b,onEachFeature:f}).addTo(o),D.debug&&console.log("geojson",U),setTimeout(function(){o.spin(!1),i(E.dl)},3e3)})}(mapConfig);