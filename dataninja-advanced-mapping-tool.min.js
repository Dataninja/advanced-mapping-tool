/*! dataninja-advanced-mapping-tool 17-11-2014 */
!function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){for(var d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){var c=b.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=w[c].filter(function(a){return a.active})[0],f=d.style.default;return f.fillColor=a(b.properties.data[e.name][e.column],e.bins,e.palette),f}function c(a){var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=w[d].filter(function(a){return a.active})[0],g=e.style.highlight,h=c.data[f.name][f.column];b.selected||b.setStyle(g),m.hasOwnProperty("label")&&m.label.active&&(db.setContent(c[u[d].label]+"<br>"+f.label+": "+(f.formatter(f.column,h)?d3.format(f.formatter(f.column,h))(h):d3.format(",d")(h)||d3.format(",.2f")(h)||h)),db.setLatLng(b.getBounds().getCenter()),B.showLabel(db))}function d(a){{var b=a.target,c=b.feature.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||cb.eachLayer(function(a){a.selected||cb.resetStyle(a)}),m.hasOwnProperty("label")&&m.label.active&&db.close()}function e(a,b){m.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;cb.eachLayer(function(a){a.selected=!1,cb.resetStyle(a)}),b.selected=!0,b.setStyle(e),z.i=b.feature.properties[u[z.dl].id],R&&R.isAdded&&R.removeFrom(B),M.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){b.on({mouseover:c,mouseout:d,click:e})}function g(a){m.debug&&console.log("joinDataFunction",arguments);for(var b,c,d=0;d<u[a].resource.length;d++){b=u[a].resource[d].properties[u[a].id],u[a].resource[d].properties.data={};for(var e=0;e<w[a].length;e++){w[a][e].active=!e;for(var f=0;f<w[a][e].resource.length;f++){var c=w[a][e].resource[f][w[a][e].id];if(c==b){u[a].resource[d].properties.data[w[a][e].name]=w[a][e].resource[f];for(var g in u[a].resource[d].properties.data[w[a][e].name])u[a].resource[d].properties.data[w[a][e].name].hasOwnProperty(g)&&(u[a].resource[d].properties.data[w[a][e].name][g]=w[a][e].parse(u[a].resource[d].properties.data[w[a][e].name][g]));u[a].resource[d].properties._layer=a}}}d3.keys(u[a].resource[d].properties.data).length||(u[a].resource.splice(d,1),d--)}}function h(a){m.debug&&console.log("binDataFunction",arguments);var b=w[a].filter(function(a){return a.active})[0],c=(m.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],b.resource.map(function(a){return a[b.column]})),d=new geostats(c);c.length>3?b.binsNum>c.length&&(b.binsNum=c.length-1):b.binsNum=3,bins=d.getJenks(b.binsNum);var e=_.uniq(bins);b.binsNum>3&&e.length<bins.length&&(b.binsNum=e.length-1,bins=d.getJenks(b.binsNum)),b.bins=bins.map(function(a){return parseInt(a)||parseFloat(a)||a}),b.ranges=d.ranges,ab.update(a)}function i(a,b){m.debug&&console.log("loadDataFunction",arguments);var c,d,f,i=m.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],k=m.dataSets.filter(function(b){return b.schema.layer===a});if(d3.selectAll("nav#geomenu-ui a").classed("active",!1),d3.select("nav#geomenu-ui a#"+a).classed("active",!0),d3.selectAll("nav#datamenu-ui a").classed("active",!1),d3.select("nav#datamenu-ui a#"+(b||k[0].schema.name)).classed("active",!0),d3.select("nav#datamenu-ui select").attr("disabled",null),z.dl=a,cb.clearLayers(),m.debug&&console.log("geoLayer",i),m.debug&&console.log("dataSets",k),u[a].resource)h(a),cb.addData(u[a].resource),delete z.i,R&&R.isAdded&&R.removeFrom(B),ab.update(a),M.update();else{B.spin(!0),f=queue(),c=i.url.call(i,a,z.t?z.tl:void 0,z.t||void 0),f.defer(d3[i.format],c),m.debug&&console.log("geoPath",c);for(var l=0;l<k.length;l++)d=k[l].url.call(k[l],a,z.t?v[z.tl].id:void 0,z.t||void 0),f.defer(d3[k[l].format],d),m.debug&&console.log("dataPath",l,d);f.await(function(b,c){m.debug&&console.log("await",arguments),u[a].resource=i.transform(c);for(var d=2;d<arguments.length;d++)w[a][d-2].resource=k[d-2].transform(arguments[d]);B.spin(!1),g(a),h(a),cb.addData(u[a].resource),j||(j=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),z.t&&B.fitBounds(cb.getBounds()),z.i&&cb.eachLayer(function(b){b.feature.properties[u[a].id]==z.i&&e(null,b)})})}}var j,k,l,m=mapConfig;if(m.hasOwnProperty("language")){var n;switch(m.language){case"it":n=d3.locale({decimal:",",thousands:".",grouping:[3],currency:["€ ",""],dateTime:"%a %b %e %X %Y",date:"%d/%m/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"],shortDays:["Dom","Lun","Mar","Mer","Gio","Ven","Sab"],months:["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],shortMonths:["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"]});break;default:n=d3.locale()}d3.format=n.numberFormat,d3.time.format=n.timeFormat}m.hasOwnProperty("analytics")&&m.analytics.active&&(!function(a,b,c,d,e,f,g){a.GoogleAnalyticsObject=e,a[e]=a[e]||function(){(a[e].q=a[e].q||[]).push(arguments)},a[e].l=1*new Date,f=b.createElement(c),g=b.getElementsByTagName(c)[0],f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create",m.analytics.ua||"","auto"),ga("send","pageview"));var o,p;for(k=0;k<m.geoLayers.length;k++){p=m.geoTypes[m.geoLayers[k].type];for(l in p)if(p.hasOwnProperty(l))if(m.geoLayers[k].hasOwnProperty(l)){if("object"==typeof p[l])for(var q in p[l])p[l].hasOwnProperty(q)&&!m.geoLayers[k][l].hasOwnProperty(q)&&(m.geoLayers[k][l][q]=p[l][q])}else m.geoLayers[k][l]=p[l];o=m.geoSources[m.geoLayers[k].source];for(l in o)o.hasOwnProperty(l)&&!m.geoLayers[k].hasOwnProperty(l)&&(m.geoLayers[k][l]=o[l]);m.geoLayers[k].active||(m.geoLayers.splice(k,1),k--)}for(k=0;k<m.dataSets.length;k++){p=m.dataTypes[m.dataSets[k].type];for(l in p)p.hasOwnProperty(l)&&!m.dataSets[k].hasOwnProperty(l)&&(m.dataSets[k][l]=p[l]);o=m.dataSources[m.dataSets[k].source];for(l in o)o.hasOwnProperty(l)&&!m.dataSets[k].hasOwnProperty(l)&&(m.dataSets[k][l]=o[l]);var r=m.geoLayers.filter(function(a){return a.hasOwnProperty("schema")&&a.schema.name===m.dataSets[k].schema.layer});r.length&&r[0].active||(m.dataSets.splice(k,1),k--)}if(m.hasOwnProperty("infowindow")&&m.infowindow.active&&m.infowindow.hasOwnProperty("downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)if(m.infowindow.downloads.files[k].active){o=m.dataSources[m.infowindow.downloads.files[k].source];for(l in o)o.hasOwnProperty(l)&&!m.infowindow.downloads.files[k].hasOwnProperty(l)&&(m.infowindow.downloads.files[k][l]=o[l])}if(m.hasOwnProperty("pointsSet")&&m.pointsSet.active){o=m.dataSources[m.pointsSet.source];for(l in o)o.hasOwnProperty(l)&&!m.pointsSet.hasOwnProperty(l)&&(m.pointsSet[l]=o[l])}m.debug&&console.log("$",m);var s;m.hasOwnProperty("urlShortener")&&m.urlShortener.active&&(s=yourls.connect(m.urlShortener.url.call(m.urlShortener),{signature:m.urlShortener.signature})),m.debug&&console.log("dtnj",s);var t={},u={};for(k=0;k<m.geoLayers.length;k++)"vector"===m.geoLayers[k].type&&(t[m.geoLayers[k].schema.name]={id:m.geoLayers[k].schema.id,label:m.geoLayers[k].schema.label,resource:null,list:[]});m.debug&&console.log("defaultGeo",t);var v={},w={};for(k=0;k<m.dataSets.length;k++){var x=m.dataSets[k];if(v[x.schema.name]={name:x.schema.name,menuLabel:x.schema.label||x.schema.name,layer:x.schema.layer,id:x.schema.id,columns:x.schema.hasOwnProperty("menu")&&x.schema.menu.length?x.schema.menu.map(function(a){return a.column}):null,labels:x.schema.hasOwnProperty("menu")&&x.schema.menu.length?x.schema.menu.map(function(a){return a.label||a.column}):null,descriptions:x.schema.hasOwnProperty("menu")&&x.schema.menu.length?x.schema.menu.map(function(a){return a.description||(a.label?a.label+">"+a.column:a.column)}):null,resourceId:x.resourceId,palette:x.palette,transform:x.transform||function(a,b){return b},formatter:x.formatter||function(){return""},resource:null,binsNums:x.schema.hasOwnProperty("menu")&&x.schema.menu.length?x.schema.menu.map(function(a){return a.bins||x.bins}):null,bins:[],ranges:[],active:!1},v[x.schema.name].column=v[x.schema.name].columns[0],v[x.schema.name].label=v[x.schema.name].labels[0],v[x.schema.name].description=v[x.schema.name].descriptions[0],v[x.schema.name].binsNum=v[x.schema.name].binsNums[0],"string"==typeof x.parse){var y=window[x.parse];v[x.schema.name].parse=function(a){return y(a)||a}}else v[x.schema.name].parse="function"==typeof x.parse?x.parse:function(a){return parseInt(a)||parseFloat(a)||a}}m.debug&&console.log("defaultData",v);var z=Arg.query();for(z.ls=z.ls||d3.keys(t),z.ml=z.ls[0],z.dl=z.dl||z.ml,z.md=z.md||(head.mobile?"mobile":""),d3.select("body").classed(z.md,!0),z.t&&(z.tl=z.tl||z.ml,z.ml=z.ls[z.ls.indexOf(z.tl)+1],z.ls.indexOf(z.dl)<z.ls.indexOf(z.tl)+1&&(z.dl=z.ml)),m.hasOwnProperty("pointsSet")&&m.pointsSet.active&&z.mr&&z.mr.hasOwnProperty("rid")&&(m.pointsSet.resourceId=z.mr.rid,z.mr.lat=z.mr.lat||"lat",z.mr.lng=z.mr.lng||"lng"),m.debug&&console.log("parameters",z),k=z.ls.indexOf(z.ml);k<z.ls.length;k++)if(t.hasOwnProperty(z.ls[k])){var A=[];for(l in v)v.hasOwnProperty(l)&&v[l].layer===z.ls[k]&&A.push(v[l]);A.length&&(u[z.ls[k]]=t[z.ls[k]],w[z.ls[k]]=A)}m.debug&&console.log("geo",u),m.debug&&console.log("data",w);var B,C,D,E,F,G,H;m.map.hasOwnProperty("bounds")&&(m.map.bounds.hasOwnProperty("init")&&(C=L.latLng(m.map.bounds.init.southWest),D=L.latLng(m.map.bounds.init.northEast),E=L.latLngBounds(C,D)),m.map.bounds.hasOwnProperty("max")&&(F=L.latLng(m.map.bounds.max.southWest),G=L.latLng(m.map.bounds.max.northEast),H=L.latLngBounds(F,G))),B=L.map("map",{maxZoom:m.map.zoom.max||null,minZoom:m.map.zoom.min||null,zoom:m.map.zoom.init||null,center:m.map.center||(E?E.getCenter():null),scrollWheelZoom:m.map.zoom.scrollWheel||!0,attributionControl:!m.map.attribution.length,maxBounds:H||null}),!m.map.zoom.init&&E&&B.fitBounds(E),m.debug&&console.log("map",B);var I=m.geoLayers.filter(function(a){return"tile"===a.type});for(m.debug&&console.log("tileLayers",I),k=0;k<I.length;k++)L.tileLayer(I[k].url.call(I[k]),I[k].options).addTo(B);B.spin(!0);var J=L.control.attribution();for(k=0;k<m.map.attribution.length;k++)J.addAttribution(m.map.attribution[k]);m.debug&&console.log("attrib",J),J.addTo(B);var K;m.hasOwnProperty("description")&&m.description.active&&"widget"!=z.md&&(m.description.position=m.description.position||"right",d3.select("body").classed("description "+m.description.position,!0),K="top"===m.description.position||"left"===m.description.position?d3.select("body").insert("div","#map"):d3.select("body").append("div"),K.attr("id","map-description").attr("class","description "+m.description.position).append("div").html(m.description.content||""));var M;m.hasOwnProperty("infowindow")&&m.infowindow.active&&("widget"===z.md?(M={},M._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info bottom").node()):m.infowindow.hasOwnProperty("position")&&"inside"!=m.infowindow.position?(M={},d3.select("body").classed("description "+m.infowindow.position,!0),"top"===m.infowindow.position||"left"===m.infowindow.position?M._div=d3.select("body").insert("div","#map").attr("id","infowindow").attr("class","info external "+m.infowindow.position).node():("right"===m.infowindow.position||"bottom"===m.infowindow.position)&&(M._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info external "+m.infowindow.position).node())):(M=L.control({position:"bottomright"}),M.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+z.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),M.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===z.md&&B.dragging.disable();var b,c,d,e=agnes.rowDelimiter(),f=new Date,g=d3.time.format("%Y%m%d")(f),h=a._layer,i=w[h].filter(function(a){return a.active})[0],j=i.id,l=a[u[h].id],n=[],o=[];if(m.infowindow.hasOwnProperty("shareButtons")&&m.infowindow.shareButtons.active&&(b=m.infowindow.shareButtons.title+("regioni"==h?" in ":" a ")+a[u[h].label],c="http://"+location.hostname+Arg.url(z).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(z).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[u[h].label],m.infowindow.shareButtons.hasOwnProperty("twitter")&&m.infowindow.shareButtons.twitter.active&&n.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+m.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),m.infowindow.shareButtons.hasOwnProperty("facebook")&&m.infowindow.shareButtons.facebook.active&&n.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),m.infowindow.shareButtons.hasOwnProperty("gplus")&&m.infowindow.shareButtons.gplus.active&&n.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),m.infowindow.shareButtons.hasOwnProperty("linkedin")&&m.infowindow.shareButtons.linkedin.active&&n.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),m.infowindow.shareButtons.hasOwnProperty("email")&&m.infowindow.shareButtons.email.active&&n.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(m.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),m.infowindow.shareButtons.hasOwnProperty("permalink")&&m.infowindow.shareButtons.permalink.active&&n.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>')),m.debug&&console.log("shareButtons",n),m.infowindow.hasOwnProperty("downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)m.infowindow.downloads.files[k].active&&o.push('<a id="a-'+m.infowindow.downloads.files[k].name+'" class="dnl" href="#" title="'+m.infowindow.downloads.files[k].title+'"><img src="'+m.infowindow.downloads.files[k].image+'" /></a>');m.debug&&console.log("downloadButtons",o);var p="<thead><tr><th>"+(o.length?'<span id="sdnlBtn">'+o.join("&nbsp;")+"</span>&nbsp;&nbsp;":"")+(n.length?'<span id="sshrBtn">'+n.join("&nbsp;")+"</span>":"")+'</th><th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[u[h].label]+"</th></tr></thead>";m.debug&&console.log("Table header",p);var q;q=m.infowindow.hasOwnProperty("downloads")&&m.infowindow.downloads.active?'<tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">'+(m.infowindow.downloads.license||"")+"</td></tr></tfoot>":"<tfoot></tfoot>",m.debug&&console.log("Table footer",q);var r;if(m.infowindow.hasOwnProperty("view")&&m.infowindow.view.active&&m.viewTypes.hasOwnProperty(m.infowindow.view.type)?(r=m.viewTypes[m.infowindow.view.type](a.data[i.name],m.infowindow.view.options,i.formatter),r.indexOf("<tbody>")>-1||(r="<tbody>"+r+"</tbody>")):r="<tbody></tbody>",m.debug&&console.log("Table body",r),this._div.innerHTML+='<table class="zebra">'+p+r+q+"</table>",m.debug&&console.log("Table",this._div.innerHTML),m.infowindow.hasOwnProperty("shareButtons")&&m.infowindow.shareButtons.active&&m.hasOwnProperty("urlShortener")&&m.urlShortener.active&&s.shorten(btnEncUrl,m.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];m.infowindow.shareButtons.hasOwnProperty("twitter")&&m.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+m.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),m.infowindow.shareButtons.hasOwnProperty("facebook")&&m.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),m.infowindow.shareButtons.hasOwnProperty("gplus")&&m.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),m.infowindow.shareButtons.hasOwnProperty("linkedin")&&m.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),m.infowindow.shareButtons.hasOwnProperty("email")&&m.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(m.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),m.infowindow.shareButtons.hasOwnProperty("permalink")&&m.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),m.infowindow.hasOwnProperty("downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)m.infowindow.downloads.files[k].active&&!function(a){var b=m.infowindow.downloads.files[a].url.call(m.infowindow.downloads.files[a],h,j,l),c=g+"_"+m.infowindow.downloads.files[a].filebase+"-"+m.infowindow.downloads.files[a].name+(j&&l?"_"+j+"-"+l:"")+".csv";d3.select("a#a-"+m.infowindow.downloads.files[a].name).on("click",function(){m.debug&&console.log(this,a,m.infowindow.downloads.files[a].name,b,c),d3[m.infowindow.downloads.files[a].format](b,function(b,d){var f=m.infowindow.downloads.files[a].transform(d);if(f.length>0){var g=agnes.jsonToCsv(f,e),h=new Blob([g],{type:"text/csv;charset=utf-8"});saveAs(h,c)}else alert("No data!")})})}(k);d3.select(this._div).select("a#close-cross").on("click",function(){return m.debug&&console.log("clickCloseCross",arguments),cb.eachLayer(function(a){a.selected=!1,cb.resetStyle(a)}),delete z.i,R&&R.isAdded&&R.removeFrom(B),M.update(),B.scrollWheelZoom.enable(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===z.md?(B.dragging.enable(),this._div.innerHTML+=m.infowindow.content.mobile):this._div.innerHTML+=m.infowindow.content.default},"widget"===z.md||m.infowindow.hasOwnProperty("position")&&"inside"!=m.infowindow.position?M.update():M.addTo(B)),m.debug&&console.log("info",M);var N;m.controls.hasOwnProperty("fullscreen")&&m.controls.fullscreen.active&&"widget"!=z.md&&"embed"!=z.md&&(N=L.control.fullscreen({title:m.controls.fullscreen.title}).addTo(B)),m.debug&&console.log("fullscreen",N);var O;m.controls.hasOwnProperty("logo")&&m.controls.logo.active&&("widget"===z.md?O=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+z.md,!0).attr("href",m.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",m.controls.logo.image):(O=L.control({position:"topleft"}),O.onAdd=function(){var a=L.DomUtil.create("a","logo "+z.md),b=L.DomUtil.create("img","logo"+(m.controls.logo.border?" border":""),a);return a.setAttribute("href",m.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",m.controls.logo.image),a},O.addTo(B))),m.debug&&console.log("logo",O);var P;m.controls.hasOwnProperty("reset")&&m.controls.reset.active&&(P=L.control({position:"mobile"===z.md?"bottomleft":"topright"}),P.onAdd=function(a){var b=L.DomUtil.create("img","reset "+z.md);return b.setAttribute("src",m.controls.reset.image),b.setAttribute("title",m.controls.reset.title),d3.select(b).on("click",function(){i(z.ml),a.fitBounds(E)}),b},P.addTo(B)),m.debug&&console.log("reset",P);var Q,R;m.controls.hasOwnProperty("embed")&&m.controls.embed.active&&(R=L.control({position:"mobile"===z.md?"bottomleft":"topright"}),R.isAdded=!1,R.onRemove=function(){this.isAdded=!1},R.onAdd=function(){this.isAdded=!0;var a={},b=L.DomUtil.create("div","info embed-inputarea"),c="http://"+location.hostname+Arg.url(z).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),d="http://"+location.hostname+encodeURIComponent(Arg.url(z).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));m.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",b),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+c+'" readonly></input>'),m.hasOwnProperty("urlShortener")&&m.urlShortener.active&&m.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",b),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',s.shorten(d,m.urlShortener.prefix+md5(c),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),m.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",b),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+c+'&md=embed&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),m.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",b),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+c+'&md=widget&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),m.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",b),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(c).replace(/^[^?]+\?/,"").replace(/&/g," ")+' md=embed]" readonly></input>'),m.controls.embed.hasOwnProperty("svg")&&m.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",b),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+m.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,m.controls.embed.svg.filename)}));for(var e in a)a.hasOwnProperty(e)&&d3.select(a[e]).select("input").on("focus",function(){this.select()});return b},Q=L.control({position:"mobile"===z.md?"bottomleft":"topright"}),Q.onAdd=function(a){var b=L.DomUtil.create("img","embed "+z.md);return b.setAttribute("src",m.controls.embed.image),b.setAttribute("title",m.controls.embed.title),d3.select(b).on("click",function(){R.isAdded?R&&R.isAdded&&R.removeFrom(a):R.addTo(a)}),b},Q.addTo(B)),m.debug&&console.log("embed",Q);var S;m.controls.hasOwnProperty("screenshot")&&m.controls.screenshot.active&&"widget"!=z.md&&(S=L.control({position:"mobile"===z.md?"bottomleft":"topright"}),S.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+z.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",m.controls.screenshot.image),a.setAttribute("title",m.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=m.controls.screenshot.offsetX||"auto",d=m.controls.screenshot.offsetY||"auto";canvg(a,b.node().outerHTML,{ignoreMouse:m.controls.screenshot.ignoreMouse||!0,ignoreAnimation:m.controls.screenshot.ignoreAnimation||!0,ignoreDimensions:m.controls.screenshot.ignoreDimensions||!0,ignoreClear:m.controls.screenshot.ignoreClear||!0,offsetX:"number"==typeof c?c:j[0],offsetY:"number"==typeof d?d:j[1]}),a.toBlob(function(a){saveAs(a,m.controls.screenshot.filename)})}})}),a},S.addTo(B)),m.debug&&console.log("screenshot",S);var T;m.controls.hasOwnProperty("detach")&&m.controls.detach.active&&("embed"===z.md||"widget"===z.md)&&(T=L.control({position:"topright"}),T.onAdd=function(){var a=L.DomUtil.create("a","detach "+z.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(z).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",m.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",m.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(z).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},T.addTo(B)),m.debug&&console.log("detach",T);var U;m.controls.hasOwnProperty("socialButtons")&&m.controls.socialButtons.active&&(z.md||(U=L.control({position:"bottomleft"}),U.onAdd=function(){var a=L.DomUtil.create("div","share "+z.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",m.controls.socialButtons.hasOwnProperty("twitter")&&m.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+m.controls.socialButtons.twitter.via+'" data-lang="'+m.controls.socialButtons.twitter.lang+'" data-related="'+m.controls.socialButtons.twitter.related+'" data-hashtags="'+m.controls.socialButtons.twitter.hashtags+'" data-count="'+m.controls.socialButtons.twitter.count+'">'+m.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),m.controls.socialButtons.hasOwnProperty("facebook")&&m.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+m.controls.socialButtons.facebook.layout+'" data-action="'+m.controls.socialButtons.facebook.action+'" data-show-faces="'+m.controls.socialButtons.facebook["show-faces"].toString()+'" data-share="'+m.controls.socialButtons.facebook.share.toString()+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+m.controls.socialButtons.facebook.appId+"&version=v2.0")),m.controls.socialButtons.hasOwnProperty("gplus")&&m.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+m.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+m.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a},U.addTo(B))),m.debug&&console.log("share",U);var V,W=m.geoLayers.filter(function(a){return"tile"!=a.type});W.length>1&&(V=L.control({position:"topleft"}),V.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+z.md);return a.setAttribute("id","geomenu-ui"),"widget"===z.md&&a.setAttribute("style","display:none;"),a},V.addTo(B),d3.select("nav#geomenu-ui").selectAll("a").data(W.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).classed("disabled",function(a){return!u.hasOwnProperty(a.name)}).on("click",function(a,b){if(u.hasOwnProperty(a.name)){var c=a.name;w[c][0].active=!0;for(var b=0;b<w[c].length;b++)0!=b&&(w[c][b].active=!1);delete z.i,R&&R.isAdded&&R.removeFrom(B),M.update(),ab.update(),X.update(a.name),X.onChange(a.name),i(a.name)}}).text(function(a){return a.menu})),m.debug&&console.log("menuGeoLayers",W),m.debug&&console.log("geoMenu",V);var X=L.control({position:"topleft"});X.onAdd=function(a){var b=L.DomUtil.create("nav","menu-ui "+z.md);return b.setAttribute("id","datamenu-ui"),"widget"===z.md&&b.setAttribute("style","display:none;"),this._nav=b,d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},X.onChange=function(a,b){d3.select(this._nav).select("select").remove();var b=b||0,c=w[a][b];c.columns&&c.columns.length>1&&d3.select(this._nav).append("select").attr("disabled","disabled").on("change",function(){var b=d3.select(this).property("selectedIndex"),d=d3.select(this).selectAll("option")[0][b].__data__;c.column=d,c.label=c.labels[b],c.description=c.descriptions[b],c.binsNum=c.binsNums[b],i(a,c.name)}).selectAll("option").data(c.labels).enter().append("option").text(function(a){return a})},X.update=function(a){if(d3.select(this._nav).style("display",null).selectAll("a, select").remove(),a){var b=w[a];b.length>1?d3.select(this._nav).selectAll("a").data(b).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).on("click",function(a,b){var c=a.layer;w[c][b].active=!0;for(var d=0;d<w[c].length;d++)d!=b&&(w[c][d].active=!1);delete z.i,R&&R.isAdded&&R.removeFrom(B),M.update(),ab.update(),X.onChange(c,b),i(c,a.name)}).text(function(a){return a.menuLabel}):d3.select(this._nav).style("display","none")}},X.addTo(B),X.update(W[0].schema.name),X.onChange(W[0].schema.name),m.debug&&console.log("dataMenu",X);var Y;if(m.controls.hasOwnProperty("geocoder")&&m.controls.geocoder.active&&"widget"!=z.md&&"mobile"!=z.md&&(Y=new L.Control.OSMGeocoder({collapsed:m.controls.geocoder.collapsed,position:"topleft",text:m.controls.geocoder.title,bounds:E,email:m.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete z.i,R&&R.isAdded&&R.removeFrom(B),M.update(),i(m.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:m.controls.geocoder.zoom})}}}),B.addControl(Y),m.controls.geocoder.hasOwnProperty("autocomplete")&&m.controls.geocoder.autocomplete.active)){Y._completely=completely(Y._input),Y._completely.onChange=function(a){Y._completely.startFrom=a.lastIndexOf(" ")+1,Y._completely.repaint()},Y._completely.input.maxLength=50;var Z=m.controls.geocoder.autocomplete.url.call(m.controls.geocoder.autocomplete,z.t||void 0);d3[m.controls.geocoder.autocomplete.format](Z,function(a,b){t[m.controls.geocoder.layer].list=m.controls.geocoder.autocomplete.transform(b),Y._completely.options=t[m.controls.geocoder.layer].list.map(function(a){return a[u[m.controls.geocoder.layer].label]})})}m.debug&&console.log("osmGeocoder",Y);
var $;m.debug&&($=L.control({position:"bottomleft"}),$.onAdd=function(a){var b=L.DomUtil.create("div","devutil");return d3.select(b).append("p").attr("id","devutil-coord").text("Mouse position: ..."),d3.select(b).append("p").attr("id","devutil-sw").text("SouthWest bound: "+a.getBounds().getSouthWest().toString()),d3.select(b).append("p").attr("id","devutil-ne").text("NorthEast bound: "+a.getBounds().getNorthEast().toString()),d3.select(b).append("p").attr("id","devutil-center").text("Map center: "+a.getCenter().toString()),d3.select(b).append("p").attr("id","devutil-zoom").text("Zoom level: "+a.getZoom()),d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},$.addTo(B),B.on("mousemove",function(a){d3.select("#devutil-coord").text("Mouse position: "+a.latlng.toString())}).on("move",function(){d3.select("#devutil-sw").text("SouthWest bound: "+B.getBounds().getSouthWest().toString()),d3.select("#devutil-ne").text("NorthEast bound: "+B.getBounds().getNorthEast().toString()),d3.select("#devutil-center").text("Map center: "+B.getCenter().toString())}).on("zoomend",function(){d3.select("#devutil-zoom").text("Zoom level: "+B.getZoom())}));var ab;if(m.hasOwnProperty("legend")&&m.legend.active&&(ab=L.control({position:"bottomleft"}),ab.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+z.md),this._div},ab.update=function(a){if(a){var b=w[a].filter(function(a){return a.active})[0],c=b.ranges.map(function(a){return a.split(" - ").map(function(a){var c=parseFloat(a);return b.formatter(b.column,c)?d3.format(b.formatter(b.column,c))(c):d3.format(",d")(c)||d3.format(",.2f")(c)||c}).join(" - ")}),d=b.description||m.legend.description||"";this._div.innerHTML="widget"!=z.md?'<h4 title="'+d+'">'+m.legend.title+"</h4>":"";for(var e=0;e<c.length;e++){var f=colorbrewer[b.palette][c.length]?colorbrewer[b.palette][c.length][e]:colorbrewer[b.palette][3][e];this._div.innerHTML+='<i title="'+(m.legend.hasOwnProperty("label")?m.legend.label(c[e].split(" - ")[0],c[e].split(" - ")[1],b.label):c[e])+'" style="background:'+f+'"></i> '+("widget"!=z.md?c[e]:"")+"<br>"}"widget"!=z.md&&(this._div.innerHTML+="<br>"+d)}else this._div.innerHTML="widget"!=z.md?"<h4>"+m.legend.title+"</h4>":""},ab.addTo(B),ab.update()),m.debug&&console.log("legend",ab),m.pointsSet&&m.pointsSet.active&&m.pointsSet.resourceId){var bb=m.pointsSet.url.call(m.pointsSet);m.debug&&console.log("markersPath",bb),d3[m.pointsSet.format](bb,function(a,b){m.debug&&console.log("markers",arguments);var c=b?m.pointsSet.transform(b):null;if(c){for(var d=new L.MarkerClusterGroup({showCoverageOnHover:!1}),e=[],f=0;f<c.length;f++){var g=L.marker();g.setIcon(L.icon({iconUrl:m.pointsSet.icon,shadowUrl:m.pointsSet.shadow})),g.setLatLng(L.latLng(c[f][z.mr.lat],c[f][z.mr.lng])),z.mr.hasOwnProperty("iw")&&g.bindPopup(c[f][z.mr.iw]),e.push(g),d.addLayer(g)}B.addLayer(m.pointsSet.clusters?d:L.layerGroup(e))}})}var cb,db=new L.Label;cb=L.geoJson("",{style:b,onEachFeature:f}).addTo(B),m.debug&&console.log("geojson",cb),setTimeout(function(){B.spin(!1),i(z.dl)},3e3)})}(mapConfig);