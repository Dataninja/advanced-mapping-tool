/*! dataninja-advanced-mapping-tool 13-11-2014 */
var mapConfig={debug:!0,urlShortener:{active:!1,domain:"",path:"/api/dtnj/yourls-api.php",signature:"efe758b8d3",prefix:"welfarebo-",url:function(){return this.domain+this.path}},map:{bounds:{init:{southWest:{lat:44.38596,lng:11.14014},northEast:{lat:44.60514,lng:11.60912}},max:{southWest:{lat:43,lng:9},northEast:{lat:45,lng:13}}},zoom:{init:12,max:13,min:11,scrollWheel:!0},attribution:['Powered by <a href="http://www.dataninja.it/" target="_blank">Dataninja</a>','tileset from <a href="http://mapnik.org/" target="_blank">OSM Mapnik</a>','icons from <a href="http://www.flaticon.com/" target="_blank">Freepik</a> and <a href="http://www.simplesharebuttons.com/" target="_blank">Simple Share Buttons</a>','code on <a href="https://github.com/Dataninja/advanced-mapping-tool" target="_blank">GitHub</a>.']},label:{active:!0,text:"Persone assistite"},legend:{active:!0,title:"Legenda",description:"Persone assistite nell'ambito dei PAI",itemLabel:"persone assistite"},geoLayers:[{type:"tile"},{source:"file",path:"geo/",filename:"quartieri_bologna.json",format:"json",type:"vector",schema:{name:"quartieri",menu:"Quartieri",id:"NUMQUART",label:"NOMEQUART"}}],dataSets:[{source:"file",path:"data/",filename:"WelfareBO-Programma-Assistenziale-Individualizzato-PAI-1966-2014-Quartieri-dei-servizi.csv",format:"csv",transform:function(a){return a},type:"choropleth",bins:7,palette:"Greens",schema:{name:"servizi",menu:"Assistenza per servizio (PAI)",layer:"quartieri",id:"Id",label:"",legend:"",values:["Numero PAI totale","Donne","Uomini","Anziani","Disagio adulto","Famiglia e Minori","Cittadinanza italiana","Cittadinanza estera"]},parse:"parseInt"},{source:"file",path:"data/",filename:"WelfareBO-Programma-Assistenziale-Individualizzato-PAI-1966-2014-Quartieri-di-residenza.csv",format:"csv",transform:function(a){return a},type:"choropleth",bins:7,palette:"Blues",schema:{name:"residenza",menu:"Assistenza per residenza (PAI)",layer:"quartieri",id:"Id",label:"",legend:"",values:["Numero PAI totale","Donne","Uomini","Anziani","Disagio adulto","Famiglia e Minori","Cittadinanza italiana","Cittadinanza estera"]},parse:"parseInt"}],pointsSet:{active:!1,source:"dkan",clusters:!0,icon:"img/marker-icon.png",shadow:"img/marker-shadow.png"},infowindow:{active:!0,content:{"default":"<p>La mappa mostra i dati dei servizi di assistenza del Comune di Bologna per ogni quartiere della citt√†.</p>",mobile:"I servizi di assistenza del Comune di Bologna per quartiere."},downloads:{active:!1,license:'Creative Commons Attribution <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0 International</a>.',files:[{active:!0,source:"dkan",resourceId:"e5b4d63a-e1e8-40a3-acec-1d351f03ee56",name:"immobili",filebase:"confiscatibene",title:"Scarica l'elenco degli immobili",image:"img/house109-dnl.png"},{active:!0,source:"dkan",resourceId:"8b7e12f1-6484-47f0-9cf6-88b446297dbc",name:"aziende",filebase:"confiscatibene",title:"Scarica l'elenco delle aziende",image:"img/factory6-dnl.png"}]},shareButtons:{active:!0,title:"Condividi la situazione",twitter:{active:!0,via:"Twiperbole",text:"Servizi assistenziali a Bologna"},facebook:{active:!0},gplus:{active:!0},linkedin:{active:!0},email:{active:!0,subject:"Servizi di assistenza del Comune di Bologna",body:"I servizi di assistenza del Comune di Bologna"},permalink:{active:!0}},view:{active:!0,type:"table",options:{transform:function(a,b){return parseInt(b)||b}}}},controls:{fullscreen:{active:!0,title:"Fullscreen mode"},logo:{active:!0,title:"",image:"img/logobo.jpg",border:!0,link:"http://www.comune.bologna.it/"},reset:{active:!0,title:"Reset",image:"img/reset.png"},embed:{active:!1,title:"Embed this map",image:"img/embed.png",permalink:!0,shorturl:!0,iframe:!0,widget:!0,shortcode:!0,svg:{active:!0,filename:"welfarebo_map.svg",image:"img/svg.png"}},screenshot:{active:!1,title:"Take a screenshot",image:"img/screenshot.png",filename:"welfarebo_map.png"},detach:{active:!0,title:"Open in new window",image:"img/detach.png"},socialButtons:{active:!1,twitter:{active:!0,via:"Twiperbole",lang:"it",related:"dataninjait:Data journalism made in Italy",hashtags:"dataninja",count:"vertical",text:"Tweet"},facebook:{active:!1,appId:"470290923072583",layout:"box_count",action:"like","show-faces":!1,share:!1},gplus:{active:!0,size:"tall",annotation:"bubble"}},geocoder:{active:!1,layer:"comuni",collapsed:!0,title:"Cerca il tuo comune",email:"jenkin@dataninja.it",zoom:10,autocomplete:{active:!1,domain:"",path:"geo/",filename:"lista_comuni.json",prefix:"lista_comuni-",format:"json",url:function(a){return this.domain+this.path+(a?this.prefix+a+"."+this.format:this.filename)},transform:function(a){return a}}}},dataSources:{file:{domain:"",path:"",filename:"",format:"",url:function(a,b,c){return this.domain+this.path+(this.filename||a+(b&&c?"_"+b+"-"+c:"")+"."+this.format)},transform:function(a){return a}},dkan:{domain:"",path:"/api/confiscatibene/action/datastore/search.json",resourceId:"",limit:5e3,format:"json",url:function(a,b,c){return this.domain+this.path+"?resource_id="+this.resourceId+(b&&c?"&filters["+b+"]="+c:"")+(this.limit?"&limit="+this.limit:"")},transform:function(a){return a.result.records}}},dataTypes:{choropleth:{palette:"Reds",bins:3},points:{}},geoSources:{file:{domain:"",path:"",format:"json",filename:"",url:function(a,b,c){return this.domain+this.path+(this.filename||a+(b&&c?"_"+b+"-"+c:"")+"."+this.format)},transform:function(a){return a.features}},tileserver:{domain:"http://{s}.tile.openstreetmap.org",path:"/{z}/{x}/{y}.png",url:function(){return this.domain+this.path}}},geoTypes:{tile:{active:!0,source:"tileserver",options:{attribution:"",opacity:.7}},vector:{active:!0,style:{"default":{weight:.5,opacity:1,color:"white",fillOpacity:.7,fillColor:"none"},highlight:{},selected:{weight:2,color:"#666"}}}},viewTypes:{table:function(a,b){if(!a)return"";var c,d={include:[],exclude:[],bold:function(){return!1},filter:function(){return!0},transform:function(a,b){return b}},b=b||{},e="";for(c in d)d.hasOwnProperty(c)&&!b.hasOwnProperty(c)&&(b[c]=d[c]);for(c in a)if(a.hasOwnProperty(c)&&(!b.include.length||b.include.indexOf(c)>-1)&&!(b.exclude.length&&b.exclude.indexOf(c)>-1)&&b.filter(c,a[c])){var f=b.transform(c,a[c]),g=b.bold(c,a[c]);e+="<tr><td>"+(g?"<b>"+c+"</b>":c)+"</td><td>"+(g?"<b>"+f+"</b>":f)+"</td></tr>"}return e}}};!function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){for(var d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){var c=b.properties._layer,d=E.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=J[c].map(function(a){return a.active}).indexOf(!0),f=d.style.default;return f.fillColor=a(b.properties.data[J[c][e].name][J[c][e].value],J[c][e].bins,J[c][e].palette),f}function c(a){var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=E.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=J[d].map(function(a){return a.active}).indexOf(!0),g=e.style.highlight;b.selected||b.setStyle(g),E.hasOwnProperty("label")&&E.label.active&&(_.setContent(c[H[d].label]+"<br>"+E.label.text+": "+c.data[J[d][f].name][J[d][f].value]),_.setLatLng(b.getBounds().getCenter()),n.showLabel(_))}function d(a){{var b=a.target,c=b.feature.properties._layer,d=E.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||$.eachLayer(function(a){a.selected||$.resetStyle(a)}),E.hasOwnProperty("label")&&E.label.active&&_.close()}function e(a,b){E.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=E.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;$.eachLayer(function(a){a.selected=!1,$.resetStyle(a)}),b.selected=!0,b.setStyle(e),F.i=b.feature.properties[H[F.dl].id],t&&t.isAdded&&t.removeFrom(n),o.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){b.on({mouseover:c,mouseout:d,click:e})}function g(a){E.debug&&console.log("joinDataFunction",arguments);for(var b,c,d=0;d<H[a].resource.length;d++){b=H[a].resource[d].properties[H[a].id],H[a].resource[d].properties.data={};for(var e=0;e<J[a].length;e++){J[a][e].active=!e;for(var f=0;f<J[a][e].resource.length;f++){var c=J[a][e].resource[f][J[a][e].id];if(c==b){H[a].resource[d].properties.data[J[a][e].name]=J[a][e].resource[f];for(var g in H[a].resource[d].properties.data[J[a][e].name])H[a].resource[d].properties.data[J[a][e].name].hasOwnProperty(g)&&(H[a].resource[d].properties.data[J[a][e].name][g]=J[a][e].parse(H[a].resource[d].properties.data[J[a][e].name][g]));H[a].resource[d].properties._layer=a}}}d3.keys(H[a].resource[d].properties.data).length||(H[a].resource.splice(d,1),d--)}}function h(a){E.debug&&console.log("binDataFunction",arguments);var b=J[a].map(function(a){return a.active}).indexOf(!0),c=J[a][b].value,d=(E.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],E.dataSets.filter(function(b){return b.schema.layer===a})[b]),e=J[a][b].resource.map(function(a){return a[c]}),f=new geostats(e);J[a][b].bins=f.getJenks(e.length>d.bins?d.bins:e.length-1),J[a][b].ranges=f.ranges,B.update(a)}function i(a,b){E.debug&&console.log("loadDataFunction",arguments);var c,d,f,i=E.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],j=E.dataSets.filter(function(b){return b.schema.layer===a});if(d3.selectAll("nav#geomenu-ui a").classed("active",!1),d3.select("nav#geomenu-ui a#"+a).classed("active",!0),d3.selectAll("nav#datamenu-ui a").classed("active",!1),d3.select("nav#datamenu-ui a#"+(b||j[0].schema.name)).classed("active",!0),d3.select("nav#datamenu-ui select").attr("disabled",null),F.dl=a,$.clearLayers(),E.debug&&console.log("geoLayer",i),E.debug&&console.log("dataSets",j),H[a].resource)console.log(H[a].resource),h(a),$.addData(H[a].resource),delete F.i,t&&t.isAdded&&t.removeFrom(n),B.update(a),o.update();else{n.spin(!0),f=queue(),c=i.url.call(i,a,F.t?F.tl:void 0,F.t||void 0),f.defer(d3[i.format],c),E.debug&&console.log("geoPath",c);for(var l=0;l<j.length;l++)d=j[l].url.call(j[l],a,F.t?I[F.tl].id:void 0,F.t||void 0),f.defer(d3[j[l].format],d),E.debug&&console.log("dataPath",l,d);f.await(function(b,c){E.debug&&console.log("await",arguments),H[a].resource=i.transform(c);for(var d=2;d<arguments.length;d++)J[a][d-2].resource=j[d-2].transform(arguments[d]);n.spin(!1),g(a),h(a),$.addData(H[a].resource),k||(k=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),F.t&&n.fitBounds($.getBounds()),F.i&&$.eachLayer(function(b){b.feature.properties[H[a].id]==F.i&&e(null,b)})})}}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=mapConfig,F=Arg.query(),G={},H={},I={},J={},K=L.control.attribution();for(l=0;l<E.geoLayers.length;l++){D=E.geoTypes[E.geoLayers[l].type];for(m in D)if(D.hasOwnProperty(m))if(E.geoLayers[l].hasOwnProperty(m)){if("object"==typeof D[m])for(var M in D[m])D[m].hasOwnProperty(M)&&!E.geoLayers[l][m].hasOwnProperty(M)&&(E.geoLayers[l][m][M]=D[m][M])}else E.geoLayers[l][m]=D[m];C=E.geoSources[E.geoLayers[l].source];for(m in C)C.hasOwnProperty(m)&&!E.geoLayers[l].hasOwnProperty(m)&&(E.geoLayers[l][m]=C[m]);E.geoLayers[l].active||(E.geoLayers.splice(l,1),l--)}for(l=0;l<E.dataSets.length;l++){D=E.dataTypes[E.dataSets[l].type];for(m in D)D.hasOwnProperty(m)&&!E.dataSets[l].hasOwnProperty(m)&&(E.dataSets[l][m]=D[m]);C=E.dataSources[E.dataSets[l].source];for(m in C)C.hasOwnProperty(m)&&!E.dataSets[l].hasOwnProperty(m)&&(E.dataSets[l][m]=C[m]);var N=E.geoLayers.filter(function(a){return a.hasOwnProperty("schema")&&a.schema.name===E.dataSets[l].schema.layer});N.length&&N[0].active||(E.dataSets.splice(l,1),l--)}if(E.hasOwnProperty("infowindow")&&E.infowindow.active&&E.infowindow.hasOwnProperty("downloads")&&E.infowindow.downloads.active)for(l=0;l<E.infowindow.downloads.files.length;l++)if(E.infowindow.downloads.files[l].active){C=E.dataSources[E.infowindow.downloads.files[l].source];for(m in C)C.hasOwnProperty(m)&&!E.infowindow.downloads.files[l].hasOwnProperty(m)&&(E.infowindow.downloads.files[l][m]=C[m])}if(E.hasOwnProperty("pointsSet")&&E.pointsSet.active){C=E.dataSources[E.pointsSet.source];for(m in C)C.hasOwnProperty(m)&&!E.pointsSet.hasOwnProperty(m)&&(E.pointsSet[m]=C[m])}for(E.debug&&console.log("$",E),E.hasOwnProperty("urlShortener")&&E.urlShortener.active&&(j=yourls.connect(E.urlShortener.url.call(E.urlShortener),{signature:E.urlShortener.signature})),E.debug&&console.log("dtnj",j),l=0;l<E.geoLayers.length;l++)"vector"===E.geoLayers[l].type&&(G[E.geoLayers[l].schema.name]={id:E.geoLayers[l].schema.id,label:E.geoLayers[l].schema.label,resource:null,list:[]});for(E.debug&&console.log("defaultGeo",G),l=0;l<E.dataSets.length;l++)if(I[E.dataSets[l].schema.name]={id:E.dataSets[l].schema.id,label:E.dataSets[l].schema.label,value:"string"==typeof E.dataSets[l].schema.values?E.dataSets[l].schema.values:E.dataSets[l].schema.values[0],values:"string"==typeof E.dataSets[l].schema.values?[E.dataSets[l].schema.values]:E.dataSets[l].schema.values,layer:E.dataSets[l].schema.layer,name:E.dataSets[l].schema.name,resourceId:E.dataSets[l].resourceId,resource:null,bins:[],ranges:[],palette:E.dataSets[l].palette,active:!1},"string"==typeof E.dataSets[l].parse){var O=E.dataSets[l].parse;I[E.dataSets[l].schema.name].parse=function(a){return isNaN(window[O](a))?a:window[O](a)}}else I[E.dataSets[l].schema.name].parse="function"==typeof E.dataSets[l].parse?E.dataSets[l].parse:function(a){return isNaN(parseFloat(a))?a:parseFloat(a)};for(E.debug&&console.log("defaultData",I),F.ls=F.ls||d3.keys(G),F.ml=F.ls[0],F.dl=F.dl||F.ml,F.md=F.md||(head.mobile?"mobile":""),d3.select("body").classed(F.md,!0),F.t&&(F.tl=F.tl||F.ml,F.ml=F.ls[F.ls.indexOf(F.tl)+1],F.ls.indexOf(F.dl)<F.ls.indexOf(F.tl)+1&&(F.dl=F.ml)),E.hasOwnProperty("pointsSet")&&E.pointsSet.active&&F.mr&&F.mr.hasOwnProperty("rid")&&(E.pointsSet.resourceId=F.mr.rid,F.mr.lat=F.mr.lat||"lat",F.mr.lng=F.mr.lng||"lng"),E.debug&&console.log("parameters",F),l=F.ls.indexOf(F.ml);l<F.ls.length;l++)if(G.hasOwnProperty(F.ls[l])){var P=[];for(m in I)I.hasOwnProperty(m)&&I[m].layer===F.ls[l]&&P.push(I[m]);P.length&&(H[F.ls[l]]=G[F.ls[l]],J[F.ls[l]]=P)}E.debug&&console.log("geo",H),E.debug&&console.log("data",J);var Q=L.latLng(E.map.bounds.init.southWest),R=L.latLng(E.map.bounds.init.northEast),S=L.latLngBounds(Q,R),T=L.latLng(E.map.bounds.max.southWest),U=L.latLng(E.map.bounds.max.northEast),V=L.latLngBounds(T,U);n=L.map("map",{maxZoom:E.map.zoom.max||null,minZoom:E.map.zoom.min||null,zoom:E.map.zoom.init||null,center:E.map.zoom.init?S.getCenter():null,scrollWheelZoom:E.map.zoom.scrollWheel||!0,attributionControl:!E.map.attribution.length,maxBounds:V}),E.debug&&console.log("map",n),E.map.zoom.init||n.fitBounds(S);var W=E.geoLayers.filter(function(a){return"tile"===a.type});for(E.debug&&console.log("tileLayers",W),l=0;l<W.length;l++)L.tileLayer(W[l].url.call(W[l]),W[l].options).addTo(n);for(n.spin(!0),l=0;l<E.map.attribution.length;l++)K.addAttribution(E.map.attribution[l]);E.debug&&console.log("attrib",K),K.addTo(n),E.hasOwnProperty("infowindow")&&E.infowindow.active&&("widget"===F.md?(o={},o._div=d3.select("body").append("div").attr("id","infowindow").classed("info",!0).node()):(o=L.control({position:"bottomright"}),o.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+F.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),o.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===F.md&&n.dragging.disable();var b,c,d,e=agnes.rowDelimiter(),f=new Date,g=d3.time.format("%Y%m%d")(f),h=a._layer,i=J[h].map(function(a){return a.active}).indexOf(!0),k=J[h][i].id,m=a[H[h].id],p=[],q=[];if(E.infowindow.hasOwnProperty("shareButtons")&&E.infowindow.shareButtons.active&&(b=E.infowindow.shareButtons.title+("regioni"==h?" in ":" a ")+a[H[h].label],c="http://"+location.hostname+Arg.url(F).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(F).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[H[h].label],E.infowindow.shareButtons.hasOwnProperty("twitter")&&E.infowindow.shareButtons.twitter.active&&p.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+E.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+E.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),E.infowindow.shareButtons.hasOwnProperty("facebook")&&E.infowindow.shareButtons.facebook.active&&p.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),E.infowindow.shareButtons.hasOwnProperty("gplus")&&E.infowindow.shareButtons.gplus.active&&p.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),E.infowindow.shareButtons.hasOwnProperty("linkedin")&&E.infowindow.shareButtons.linkedin.active&&p.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),E.infowindow.shareButtons.hasOwnProperty("email")&&E.infowindow.shareButtons.email.active&&p.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(E.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+E.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),E.infowindow.shareButtons.hasOwnProperty("permalink")&&E.infowindow.shareButtons.permalink.active&&p.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>')),E.debug&&console.log("shareButtons",p),E.infowindow.hasOwnProperty("downloads")&&E.infowindow.downloads.active)for(l=0;l<E.infowindow.downloads.files.length;l++)E.infowindow.downloads.files[l].active&&q.push('<a id="a-'+E.infowindow.downloads.files[l].name+'" class="dnl" href="#" title="'+E.infowindow.downloads.files[l].title+'"><img src="'+E.infowindow.downloads.files[l].image+'" /></a>');E.debug&&console.log("downloadButtons",q);var r="<thead><tr><th>"+(q.length?'<span id="sdnlBtn">'+q.join("&nbsp;")+"</span>&nbsp;&nbsp;":"")+(p.length?'<span id="sshrBtn">'+p.join("&nbsp;")+"</span>":"")+'</th><th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[H[h].label]+"</th></tr></thead>";E.debug&&console.log("Table header",r);var s;s=E.infowindow.hasOwnProperty("downloads")&&E.infowindow.downloads.active?'<tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">'+(E.infowindow.downloads.license||"")+"</td></tr></tfoot>":"<tfoot></tfoot>",E.debug&&console.log("Table footer",s);var u;if(E.infowindow.hasOwnProperty("view")&&E.infowindow.view.active&&E.viewTypes.hasOwnProperty(E.infowindow.view.type)?(u=E.viewTypes[E.infowindow.view.type](a.data[J[h][i].name],E.infowindow.view.options),u.indexOf("<tbody>")>-1||(u="<tbody>"+u+"</tbody>")):u="<tbody></tbody>",E.debug&&console.log("Table body",u),this._div.innerHTML+='<table class="zebra">'+r+u+s+"</table>",E.debug&&console.log("Table",this._div.innerHTML),E.infowindow.hasOwnProperty("shareButtons")&&E.infowindow.shareButtons.active&&E.hasOwnProperty("urlShortener")&&E.urlShortener.active&&j.shorten(btnEncUrl,E.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];E.infowindow.shareButtons.hasOwnProperty("twitter")&&E.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+E.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+E.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),E.infowindow.shareButtons.hasOwnProperty("facebook")&&E.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),E.infowindow.shareButtons.hasOwnProperty("gplus")&&E.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),E.infowindow.shareButtons.hasOwnProperty("linkedin")&&E.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),E.infowindow.shareButtons.hasOwnProperty("email")&&E.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(E.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+E.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),E.infowindow.shareButtons.hasOwnProperty("permalink")&&E.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),E.infowindow.hasOwnProperty("downloads")&&E.infowindow.downloads.active)for(l=0;l<E.infowindow.downloads.files.length;l++)E.infowindow.downloads.files[l].active&&!function(a){var b=E.infowindow.downloads.files[a].url.call(E.infowindow.downloads.files[a],h,k,m),c=g+"_"+E.infowindow.downloads.files[a].filebase+"-"+E.infowindow.downloads.files[a].name+(k&&m?"_"+k+"-"+m:"")+".csv";d3.select("a#a-"+E.infowindow.downloads.files[a].name).on("click",function(){E.debug&&console.log(this,a,E.infowindow.downloads.files[a].name,b,c),d3[E.infowindow.downloads.files[a].format](b,function(b,d){var f=E.infowindow.downloads.files[a].transform(d);if(f.length>0){var g=agnes.jsonToCsv(f,e),h=new Blob([g],{type:"text/csv;charset=utf-8"});saveAs(h,c)}else alert("No data!")})})}(l);d3.select(this._div).select("a#close-cross").on("click",function(){return E.debug&&console.log("clickCloseCross",arguments),$.eachLayer(function(a){a.selected=!1,$.resetStyle(a)}),delete F.i,t&&t.isAdded&&t.removeFrom(n),o.update(),n.scrollWheelZoom.enable(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===F.md?(n.dragging.enable(),this._div.innerHTML+=E.infowindow.content.mobile):this._div.innerHTML+=E.infowindow.content.default},"widget"===F.md?o.update():o.addTo(n)),E.debug&&console.log("info",o),E.controls.hasOwnProperty("fullscreen")&&E.controls.fullscreen.active&&"widget"!=F.md&&"embed"!=F.md&&(p=L.control.fullscreen({title:E.controls.fullscreen.title}).addTo(n)),E.debug&&console.log("fullscreen",p),E.controls.hasOwnProperty("logo")&&E.controls.logo.active&&("widget"===F.md?q=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+F.md,!0).attr("href",E.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",E.controls.logo.image):(q=L.control({position:"topleft"}),q.onAdd=function(){var a=L.DomUtil.create("a","logo "+F.md),b=L.DomUtil.create("img","logo"+(E.controls.logo.border?" border":""),a);return a.setAttribute("href",E.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",E.controls.logo.image),a},q.addTo(n))),E.debug&&console.log("logo",q),E.controls.hasOwnProperty("reset")&&E.controls.reset.active&&(r=L.control({position:"mobile"===F.md?"bottomleft":"topright"}),r.onAdd=function(a){var b=L.DomUtil.create("img","reset "+F.md);return b.setAttribute("src",E.controls.reset.image),b.setAttribute("title",E.controls.reset.title),d3.select(b).on("click",function(){i(F.ml),a.fitBounds(S)}),b},r.addTo(n)),E.debug&&console.log("reset",r),E.controls.hasOwnProperty("embed")&&E.controls.embed.active&&(t=L.control({position:"mobile"===F.md?"bottomleft":"topright"}),t.isAdded=!1,t.onRemove=function(){this.isAdded=!1},t.onAdd=function(){this.isAdded=!0;var a={},b=L.DomUtil.create("div","info embed-inputarea"),c="http://"+location.hostname+Arg.url(F).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),d="http://"+location.hostname+encodeURIComponent(Arg.url(F).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));E.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",b),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+c+'" readonly></input>'),E.hasOwnProperty("urlShortener")&&E.urlShortener.active&&E.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",b),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',j.shorten(d,E.urlShortener.prefix+md5(c),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),E.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",b),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+c+'&md=embed&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),E.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",b),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+c+'&md=widget&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),E.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",b),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(c).replace(/^[^?]+\?/,"").replace(/&/g," ")+' md=embed]" readonly></input>'),E.controls.embed.hasOwnProperty("svg")&&E.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",b),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+E.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,E.controls.embed.svg.filename)}));for(var e in a)a.hasOwnProperty(e)&&d3.select(a[e]).select("input").on("focus",function(){this.select()});return b},s=L.control({position:"mobile"===F.md?"bottomleft":"topright"}),s.onAdd=function(a){var b=L.DomUtil.create("img","embed "+F.md);return b.setAttribute("src",E.controls.embed.image),b.setAttribute("title",E.controls.embed.title),d3.select(b).on("click",function(){t.isAdded?t&&t.isAdded&&t.removeFrom(a):t.addTo(a)}),b},s.addTo(n)),E.debug&&console.log("embed",s),E.controls.hasOwnProperty("screenshot")&&E.controls.screenshot.active&&"widget"!=F.md&&(u=L.control({position:"mobile"===F.md?"bottomleft":"topright"}),u.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+F.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",E.controls.screenshot.image),a.setAttribute("title",E.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=E.controls.screenshot.offsetX||"auto",d=E.controls.screenshot.offsetY||"auto";canvg(a,b.node().outerHTML,{ignoreMouse:E.controls.screenshot.ignoreMouse||!0,ignoreAnimation:E.controls.screenshot.ignoreAnimation||!0,ignoreDimensions:E.controls.screenshot.ignoreDimensions||!0,ignoreClear:E.controls.screenshot.ignoreClear||!0,offsetX:"number"==typeof c?c:k[0],offsetY:"number"==typeof d?d:k[1]}),a.toBlob(function(a){saveAs(a,E.controls.screenshot.filename)})}})}),a},u.addTo(n)),E.debug&&console.log("screenshot",u),E.controls.hasOwnProperty("detach")&&E.controls.detach.active&&("embed"===F.md||"widget"===F.md)&&(v=L.control({position:"topright"}),v.onAdd=function(){var a=L.DomUtil.create("a","detach "+F.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(F).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",E.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",E.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(F).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},v.addTo(n)),E.debug&&console.log("detach",v),E.debug&&(w=L.control({position:"topright"}),w.onAdd=function(a){var b=L.DomUtil.create("div","devutil");return d3.select(b).append("p").attr("id","devutil-coord").text("Mouse position: ..."),d3.select(b).append("p").attr("id","devutil-sw").text("SouthWest bound: "+a.getBounds().getSouthWest().toString()),d3.select(b).append("p").attr("id","devutil-ne").text("NorthEast bound: "+a.getBounds().getNorthEast().toString()),d3.select(b).append("p").attr("id","devutil-zoom").text("Zoom level: "+a.getZoom()),d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},w.addTo(n),n.on("mousemove",function(a){d3.select("#devutil-coord").text("Mouse position: "+a.latlng.toString())}).on("move",function(){d3.select("#devutil-sw").text("SouthWest bound: "+n.getBounds().getSouthWest().toString()),d3.select("#devutil-ne").text("NorthEast bound: "+n.getBounds().getNorthEast().toString())}).on("zoomend",function(){d3.select("#devutil-zoom").text("Zoom level: "+n.getZoom())})),E.controls.hasOwnProperty("socialButtons")&&E.controls.socialButtons.active&&(F.md||(x=L.control({position:"bottomleft"}),x.onAdd=function(){var a=L.DomUtil.create("div","share "+F.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",E.controls.socialButtons.hasOwnProperty("twitter")&&E.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+E.controls.socialButtons.twitter.via+'" data-lang="'+E.controls.socialButtons.twitter.lang+'" data-related="'+E.controls.socialButtons.twitter.related+'" data-hashtags="'+E.controls.socialButtons.twitter.hashtags+'" data-count="'+E.controls.socialButtons.twitter.count+'">'+E.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),E.controls.socialButtons.hasOwnProperty("facebook")&&E.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+E.controls.socialButtons.facebook.layout+'" data-action="'+E.controls.socialButtons.facebook.action+'" data-show-faces="'+E.controls.socialButtons.facebook["show-faces"].toString()+'" data-share="'+E.controls.socialButtons.facebook.share.toString()+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+E.controls.socialButtons.facebook.appId+"&version=v2.0")),E.controls.socialButtons.hasOwnProperty("gplus")&&E.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+E.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+E.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a
},x.addTo(n))),E.debug&&console.log("share",x);var X=E.geoLayers.filter(function(a){return"tile"!=a.type});if(X.length>1&&(y=L.control({position:"topleft"}),y.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+F.md);return a.setAttribute("id","geomenu-ui"),"widget"===F.md&&a.setAttribute("style","display:none;"),a},y.addTo(n),d3.select("nav#geomenu-ui").selectAll("a").data(X.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).classed("disabled",function(a){return!H.hasOwnProperty(a.name)}).on("click",function(a,b){if(H.hasOwnProperty(a.name)){var c=a.name;J[c][0].active=!0;for(var b=0;b<J[c].length;b++)0!=b&&(J[c][b].active=!1);delete F.i,t&&t.isAdded&&t.removeFrom(n),o.update(),B.update(),z.update(a.name),z.onChange(J[a.name][0].values),i(a.name)}}).text(function(a){return a.menu})),E.debug&&console.log("menuGeoLayers",X),E.debug&&console.log("geoMenu",y),z=L.control({position:"topleft"}),z.onAdd=function(a){var b=L.DomUtil.create("nav","menu-ui "+F.md);return b.setAttribute("id","datamenu-ui"),"widget"===F.md&&b.setAttribute("style","display:none;"),this._nav=b,d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},z.onChange=function(a,b){d3.select(this._nav).select("select").remove();var b=b||0,c=J[a][b].values;c&&c.length>1&&d3.select(this._nav).append("select").attr("disabled","disabled").on("change",function(){var c=d3.select(this).property("selectedIndex"),d=d3.select(this).selectAll("option")[0][c].__data__;J[a][b].value=d,i(a,J[a][b].name)}).selectAll("option").data(c).enter().append("option").text(function(a){return a})},z.update=function(a){if(d3.select(this._nav).style("display",null).selectAll("a, select").remove(),a){var b=E.dataSets.filter(function(b){return b.schema.layer===a});b.length>1?d3.select(this._nav).selectAll("a").data(b.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).on("click",function(a,b){var c=a.layer;J[c][b].active=!0;for(var d=0;d<J[c].length;d++)d!=b&&(J[c][d].active=!1);delete F.i,t&&t.isAdded&&t.removeFrom(n),o.update(),B.update(),z.onChange(c,b),i(c,a.name)}).text(function(a){return a.menu}):d3.select(this._nav).style("display","none")}},z.addTo(n),z.update(X[0].schema.name),z.onChange(X[0].schema.name),E.debug&&console.log("dataMenu",z),E.controls.hasOwnProperty("geocoder")&&E.controls.geocoder.active&&"widget"!=F.md&&"mobile"!=F.md&&(A=new L.Control.OSMGeocoder({collapsed:E.controls.geocoder.collapsed,position:"topleft",text:E.controls.geocoder.title,bounds:S,email:E.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete F.i,t&&t.isAdded&&t.removeFrom(n),o.update(),i(E.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:E.controls.geocoder.zoom})}}}),n.addControl(A),E.controls.geocoder.hasOwnProperty("autocomplete")&&E.controls.geocoder.autocomplete.active)){A._completely=completely(A._input),A._completely.onChange=function(a){A._completely.startFrom=a.lastIndexOf(" ")+1,A._completely.repaint()},A._completely.input.maxLength=50;var Y=E.controls.geocoder.autocomplete.url.call(E.controls.geocoder.autocomplete,F.t||void 0);d3[E.controls.geocoder.autocomplete.format](Y,function(a,b){G[E.controls.geocoder.layer].list=E.controls.geocoder.autocomplete.transform(b),A._completely.options=G[E.controls.geocoder.layer].list.map(function(a){return a[H[E.controls.geocoder.layer].label]})})}if(E.debug&&console.log("osmGeocoder",A),E.hasOwnProperty("legend")&&E.legend.active&&(B=L.control({position:"bottomleft"}),B.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+F.md),this._div},B.update=function(a){if(a){var b=J[a].map(function(a){return a.active}).indexOf(!0),c=E.dataSets.filter(function(b){return b.schema.layer===a})[b],d=J[a][b].ranges;this._div.innerHTML="widget"!=F.md?'<h4 title="'+E.legend.description+'">'+E.legend.title+"</h4>":"";for(var e=0;e<d.length;e++){var f=colorbrewer[c.palette][d.length]?colorbrewer[c.palette][d.length][e]:colorbrewer[c.palette][3][e];this._div.innerHTML+='<i title="Tra '+d[e].replace("-","e")+" "+E.legend.itemLabel+'" style="background:'+f+'"></i> '+("widget"!=F.md?d[e]:"")+"<br>"}"widget"!=F.md&&(this._div.innerHTML+="<br>"+E.legend.description)}else this._div.innerHTML="widget"!=F.md?"<h4>"+E.legend.title+"</h4>":""},B.addTo(n),B.update()),E.debug&&console.log("legend",B),E.pointsSet&&E.pointsSet.active&&E.pointsSet.resourceId){var Z=E.pointsSet.url.call(E.pointsSet);E.debug&&console.log("markersPath",Z),d3[E.pointsSet.format](Z,function(a,b){E.debug&&console.log("markers",arguments);var c=b?E.pointsSet.transform(b):null;if(c){for(var d=new L.MarkerClusterGroup({showCoverageOnHover:!1}),e=[],f=0;f<c.length;f++){var g=L.marker();g.setIcon(L.icon({iconUrl:E.pointsSet.icon,shadowUrl:E.pointsSet.shadow})),g.setLatLng(L.latLng(c[f][F.mr.lat],c[f][F.mr.lng])),F.mr.hasOwnProperty("iw")&&g.bindPopup(c[f][F.mr.iw]),e.push(g),d.addLayer(g)}n.addLayer(E.pointsSet.clusters?d:L.layerGroup(e))}})}var $,_=new L.Label;$=L.geoJson("",{style:b,onEachFeature:f}).addTo(n),E.debug&&console.log("geojson",$),setTimeout(function(){n.spin(!1),i(F.dl)},3e3)})}(mapConfig);