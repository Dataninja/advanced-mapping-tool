/*! dataninja-advanced-mapping-tool 09-11-2014 */
var mapConfig={debug:!0,dataSources:{dkan:{uri:"",path:"/api/confiscatibene/action/datastore/search.json",resourceId:""}},dataTypes:{choropleth:{bins:3},points:{}},geoSources:{local:{active:!0,path:""},remote:{active:!0,uri:"",path:""}},geoTypes:{tile:{active:!0,inSelectorControl:!1,uri:"",path:"",attribution:"",style:{opacity:.7}},vector:{active:!0,inSelectorControl:!0,path:"",format:"",style:{"default":{palette:"Reds",weight:.5,opacity:1,color:"white",fillOpacity:.7,fillColor:"none"},highlight:{},selected:{weight:2,color:"#666"}}}},dataSets:[{source:"dkan",resourceId:"e2f0c989-929f-4e4d-87e2-097140f8880f",type:"choropleth",bins:7,schema:{layer:"regioni",id:"IdRegioneISTAT",label:"",value:"Totale beni"}},{source:"dkan",resourceId:"c18fa1ca-971f-4cfa-92e9-869785260dec",type:"choropleth",bins:7,schema:{layer:"province",id:"IdProvinciaISTAT",label:"",value:"Totale beni"}},{source:"dkan",resourceId:"69b2565e-0332-422f-ad57-b11491e33b08",type:"choropleth",bins:7,schema:{layer:"comuni",id:"IdComuneISTAT",label:"",value:"Totale beni"}}],pointsSet:{active:!0,source:"dkan",clusters:!0,icon:"js/leaflet/marker-icon.png",shadow:"js/leaflet/marker-shadow.png"},geoLayers:[{source:"remote",type:"tile",path:"/api/geoiq/{s}/{z}/{x}/{y}.png"},{source:"local",path:"geo/",format:"json",type:"vector",schema:{name:"regioni",id:"COD_REG",label:"NOME_REG"}},{source:"local",path:"geo/",format:"json",type:"vector",schema:{name:"province",id:"COD_PRO",label:"NOME_PRO"}},{source:"local",path:"geo/",format:"json",type:"vector",schema:{name:"comuni",id:"COD_COM",label:"NOME_COM"}}],map:{bounds:{init:{southWest:{lat:35.568,lng:1.537},northEast:{lat:47.843,lng:23.203}},max:{southWest:{lat:22.472,lng:-16.523},northEast:{lat:62.083,lng:73.828}}},zoom:{max:13,min:5,scrollWheel:!0},attribution:['Powered by <a href="http://www.dataninja.it/" target="_blank">Dataninja</a>','tileset from <a href="http://www.geoiq.com/" target="_blank">GeoIQ</a>','icons from <a href="http://www.flaticon.com/" target="_blank">Freepik</a> and <a href="http://www.simplesharebuttons.com/" target="_blank">Simple Share Buttons</a>','geocoding by <a href="http://wiki.openstreetmap.org/wiki/Nominatim" target="_blank">OSM Nominatim</a>','code on <a href="https://github.com/Dataninja/confiscatibene-choropleth" target="_blank">GitHub</a>.']},urlShortener:{active:!0,uri:"",path:"/api/dtnj/yourls-api.php",signature:"efe758b8d3",prefix:"confiscatibene-"},infowindow:{active:!0,text:{"default":'<p>La mappa mostra il numero di beni confiscati per tutti i territori amministrativi italiani, secondo i dati ufficiali dell\'<a href="http://www.benisequestraticonfiscati.it" target="_blank">ANBSC</a> (sono esclusi i beni non confiscati in via autonoma). La corrispondenza tra il gradiente di colore e il numero complessivo di beni confiscati Ã¨ dato nella legenda in basso a sinistra.</p><p>Mediante il selettore in alto a sinistra si possono caricare e visualizzare ulteriori livelli (regioni, province, comuni).</p><p>Principali funzioni della mappa: <ul><li>cerca i dati relativi al tuo territorio cliccando sulla lente e inserendo il nome di un comune;</li><li>clicca sul territorio per visualizzare i dati in dettaglio, la composizione dei beni e per scaricarne la lista completa;</li><li>includi la vista corrente della mappa sul tuo sito con il codice di embed o scaricane uno screenshot (pulsanti in alto a destra).</li></ul></p><p>Tieniti aggiornato sul progetto visitando il sito ufficiale di <a href="http://www.confiscatibene.it" target="_blank">Confiscati Bene</a> o seguendo l\'account Twitter <a href="https://twitter.com/confiscatibene" target="_blank">@confiscatibene</a>, puoi anche scriverci all\'indirizzo <a href="mailto:info@confiscatibene.it" target="_blank">info@confiscatibene.it</a>.</p>',mobile:'<a href="mailto:info@confiscatibene.it" target="_blank" style="margin-right: 30px;">Info</a>'},downloads:[{source:"dkan",resourceId:"e5b4d63a-e1e8-40a3-acec-1d351f03ee56",name:"immobili",filebase:"confiscatibene",title:"Scarica l'elenco degli immobili",image:"img/house109-dnl.png"},{source:"dkan",resourceId:"8b7e12f1-6484-47f0-9cf6-88b446297dbc",name:"aziende",filebase:"confiscatibene",title:"Scarica l'elenco delle aziende",image:"img/factory6-dnl.png"}],shareButtons:{active:!0,title:"Condividi la situazione",twitter:{active:!0,via:"confiscatibene",text:"Immobili e aziende #confiscatibene"},facebook:{active:!0},gplus:{active:!0},linkedin:{active:!0},email:{active:!0,subject:"Confiscati Bene",body:"Gli immobili e le aziende #confiscatibene"},permalink:{active:!0}}},label:{active:!0,text:"Beni confiscati"},legend:{active:!0,title:"Legenda",description:"Numero totale di beni confiscati",itemLabel:"beni confiscati"},controls:{fullscreen:{active:!0,title:"Fullscreen mode"},logo:{active:!0,title:"",image:"img/logo.png",link:"http://www.confiscatibene.it/"},reset:{active:!0,title:"Reset",image:"img/reset.png"},embed:{active:!0,title:"Embed this map",image:"img/embed.png",permalink:!0,shorturl:!0,iframe:!0,widget:!0,shortcode:!0,svg:{active:!0,filename:"confiscatibene_map.svg",image:"img/svg.png"}},screenshot:{active:!0,title:"Take a screenshot",image:"img/screenshot.png",filename:"confiscatibene_map.png",ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:"auto",offsetY:"auto"},detach:{active:!0,title:"Open in new window",image:"img/detach.png"},socialButtons:{active:!0,twitter:{active:!0,via:"confiscatibene",lang:"it",related:"jenkin27:Data scientist at Dataninja",hashtags:"confiscatibene,dataninja",count:"vertical",text:"Tweet"},facebook:{active:!0,appId:"470290923072583",layout:"box_count",action:"like","show-faces":"false",share:"false"},gplus:{active:!0,size:"tall",annotation:"bubble"}},geocoder:{active:!0,layer:"comuni",collapsed:!0,title:"Cerca il tuo comune",email:"jenkin@dataninja.it",zoom:10,autocomplete:{active:!1,path:"geo/",name:"lista_comuni.json",prefix:"lista_comuni-",format:"json"}}}};!function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){D.debug&&console.log("getColorFunction",arguments);for(var c=c||"Reds",d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){D.debug&&console.log("styleFunction",arguments);var c=b.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.default;return e.fillColor=a(parseInt(b.properties.data[I[c].value]),I[c].bins,d.style.default.palette),e}function c(a){D.debug&&console.log("highlightFeatureFunction",arguments);var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=e.style.highlight;b.selected||b.setStyle(f),D.label.active&&(V.setContent(c[G[E.dl].label]+"<br>"+D.label.text+": "+c.data[I[E.dl].value]),V.setLatLng(b.getBounds().getCenter()),o.showLabel(V))}function d(a){D.debug&&console.log("resetHighlightFunction",arguments);{var b=a.target,c=b.feature.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||U.eachLayer(function(a){a.selected||U.resetStyle(a)}),D.label.active&&V.close()}function e(a,b){D.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=D.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;U.eachLayer(function(a){a.selected=!1,U.resetStyle(a)}),b.selected=!0,b.setStyle(e),E.i=b.feature.properties[G[E.dl].id],u&&u.isAdded&&u.removeFrom(o),p.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){D.debug&&console.log("onEachFeatureFunction",arguments),b.on({mouseover:c,mouseout:d,click:e})}function g(a){D.debug&&console.log("joinDataFunction",arguments);for(var b=(G[a].resource.features.length,I[a].resource.result.records.length),c=!0,d=0,e=0,f=0;f<G[a].resource.features.length;f++){for(var g=G[a].resource.features[f].properties[G[a].id],h=0;b>h;h++){var i=I[a].resource.result.records[h][I[a].id];if(i==g){d++,G[a].resource.features[f].properties.data=I[a].resource.result.records[h],G[a].resource.features[f].properties._layer=a,c=!1;break}}c?(e++,G[a].resource.features.splice(f,1),f--):c=!0}}function h(a){D.debug&&console.log("binDataFunction",arguments);var b=(D.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],D.dataSets.filter(function(b){return b.schema.layer===a})[0]),c=I[a].resource.result.records.map(function(b){return parseInt(b[I[a].value])}),d=new geostats(c);I[a].bins=d.getJenks(c.length>b.bins?b.bins:c.length-1),I[a].ranges=d.ranges,A.update(a)}function i(a){D.debug&&console.log("loadDataFunction",arguments);var b=D.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],c=D.dataSets.filter(function(b){return b.schema.layer===a})[0];if(d3.selectAll("nav#menu-ui a").classed("active",!1),d3.select("nav#menu-ui a#"+a).classed("active",!0),E.dl=a,U.clearLayers(),D.debug&&console.log("geoLayer",b),D.debug&&console.log("dataSet",c),G[a].resource&&I[a].resource)U.addData(G[a].resource),delete E.i,u&&u.isAdded&&u.removeFrom(o),p.update();else{var d=5e3,f=b.path+(E.t?a+"-"+E.tl+"-"+E.t:a)+"."+b.format,i=c.path+"?resource_id="+c.resourceId+(E.t?"&filters["+H[E.tl].id+"]="+E.t:""),j=queue();if(o.spin(!0),D.debug&&console.log("geoPath",f),D.debug&&console.log("dataPath",i),j.defer(d3.json,f),j.defer(d3.json,i+"&limit="+d),E.mr&&E.mr.hasOwnProperty("rid")){var l=D.pointsSet.path+"?resource_id="+E.mr.rid;D.debug&&console.log("markersPath",l),j.defer(d3.json,l+"&limit="+d)}j.await(function(b,c,d,f){if(D.debug&&console.log("await",arguments),G[a].resource=c,I[a].resource=d,I[a].markers=f||null,o.spin(!1),g(a),h(a),U.addData(G[a].resource),k||(k=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),E.t&&o.fitBounds(U.getBounds()),E.i&&U.eachLayer(function(b){b.feature.properties[G[a].id]==E.i&&e(null,b)}),I[a].markers){for(var i=new L.MarkerClusterGroup({showCoverageOnHover:!1}),j=[],l=I[a].markers.result.records,m=0;m<l.length;m++){var n=L.marker();n.setIcon(L.icon({iconUrl:D.pointsSet.icon,shadowUrl:D.pointsSet.shadow})),n.setLatLng(L.latLng(l[m][E.mr.lat],l[m][E.mr.lng])),E.mr.hasOwnProperty("iw")&&n.bindPopup(l[m][E.mr.iw]),j.push(n),i.addLayer(n)}o.addLayer(D.pointsSet.clusters?i:L.layerGroup(j))}})}}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=mapConfig,E=Arg.query(),F={},G={},H={},I={},J=L.control.attribution();for(m=0;m<D.dataSets.length;m++){B=D.dataSources[D.dataSets[m].source],C=D.dataTypes[D.dataSets[m].type];for(n in B)B.hasOwnProperty(n)&&!D.dataSets[m].hasOwnProperty(n)&&(D.dataSets[m][n]=B[n]);for(n in C)C.hasOwnProperty(n)&&!D.dataSets[m].hasOwnProperty(n)&&(D.dataSets[m][n]=C[n])}if(D.infowindow.active)for(m=0;m<D.infowindow.downloads.length;m++){B=D.dataSources[D.infowindow.downloads[m].source];for(n in B)B.hasOwnProperty(n)&&!D.infowindow.downloads[m].hasOwnProperty(n)&&(D.infowindow.downloads[m][n]=B[n])}if(D.pointsSet.active){B=D.dataSources[D.pointsSet.source];for(n in B)B.hasOwnProperty(n)&&!D.pointsSet.hasOwnProperty(n)&&(D.pointsSet[n]=B[n])}for(m=0;m<D.geoLayers.length;m++){B=D.geoSources[D.geoLayers[m].source],C=D.geoTypes[D.geoLayers[m].type];for(n in B)B.hasOwnProperty(n)&&!D.geoLayers[m].hasOwnProperty(n)&&(D.geoLayers[m][n]=B[n]);for(n in C)if(C.hasOwnProperty(n))if(D.geoLayers[m].hasOwnProperty(n)){if("object"==typeof C[n])for(var K in C[n])C[n].hasOwnProperty(K)&&!D.geoLayers[m][n].hasOwnProperty(K)&&(D.geoLayers[m][n][K]=C[n][K])}else D.geoLayers[m][n]=C[n]}for(D.debug&&console.log("$",D),D.urlShortener.active&&(j=yourls.connect(D.urlShortener.uri+D.urlShortener.path,{signature:D.urlShortener.signature})),D.debug&&console.log("dtnj",j),m=0;m<D.geoLayers.length;m++)"vector"===D.geoLayers[m].type&&(F[D.geoLayers[m].schema.name]={id:D.geoLayers[m].schema.id,label:D.geoLayers[m].schema.label,inSelectorControl:D.geoLayers[m].inSelectorControl,resource:null,list:[]});for(D.debug&&console.log("defaultGeo",F),m=0;m<D.dataSets.length;m++)H[D.dataSets[m].schema.layer]={id:D.dataSets[m].schema.id,label:D.dataSets[m].schema.label,value:D.dataSets[m].schema.value,resourceId:D.dataSets[m].resourceId,resource:null,markers:null,bins:[],ranges:[]};for(D.debug&&console.log("defaultData",H),E.ls=E.ls||d3.keys(F),E.ml=E.ls[0],E.dl=E.dl||E.ml,E.md=E.md||(head.mobile?"mobile":""),d3.select("body").classed(E.md,!0),E.t&&(E.tl=E.tl||E.ml,E.ml=E.ls[E.ls.indexOf(E.tl)+1],E.ls.indexOf(E.dl)<E.ls.indexOf(E.tl)+1&&(E.dl=E.ml)),E.mr&&E.mr.hasOwnProperty("rid")&&(E.mr.lat=E.mr.lat||"lat",E.mr.lng=E.mr.lng||"lng"),D.debug&&console.log("parameters",E),m=E.ls.indexOf(E.ml);m<E.ls.length;m++)F.hasOwnProperty(E.ls[m])&&H.hasOwnProperty(E.ls[m])&&(G[E.ls[m]]=F[E.ls[m]],I[E.ls[m]]=H[E.ls[m]]);D.debug&&console.log("geo",G),D.debug&&console.log("data",I);var M=L.latLng(D.map.bounds.init.southWest),N=L.latLng(D.map.bounds.init.northEast),O=L.latLngBounds(M,N),P=L.latLng(D.map.bounds.max.southWest),Q=L.latLng(D.map.bounds.max.northEast),R=L.latLngBounds(P,Q);o=L.map("map",{maxZoom:D.map.zoom.max,minZoom:D.map.zoom.min,scrollWheelZoom:D.map.zoom.scrollWheel,attributionControl:!D.map.attribution.length,maxBounds:R}),D.debug&&console.log("map",o),o.fitBounds(O);var S=D.geoLayers.filter(function(a){return"tile"===a.type});for(D.debug&&console.log("tileLayers",S),m=0;m<S.length;m++)"remote"===S[m].source&&L.tileLayer(S[m].uri+S[m].path,S[m].style).addTo(o);for(o.spin(!0),m=0;m<D.map.attribution.length;m++)J.addAttribution(D.map.attribution[m]);if(D.debug&&console.log("attrib",J),J.addTo(o),D.infowindow.active&&("widget"===E.md?(p={},p._div=d3.select("body").append("div").attr("id","infowindow").classed("info",!0).node()):(p=L.control({position:"bottomright"}),p.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+E.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),p.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===E.md&&o.dragging.disable();var b,c,d,e,f,g=agnes.rowDelimiter(),h=new Date,i=d3.time.format("%Y%m%d")(h),k=E.dl,l=I[k].id,n=a[G[k].id],q=[],r=[];for(D.infowindow.shareButtons.active&&(b=D.infowindow.shareButtons.title+("regioni"==k?" in ":" a ")+a[G[k].label],c="http://"+location.hostname+Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[G[k].label],D.infowindow.shareButtons.twitter.active&&q.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+D.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),D.infowindow.shareButtons.facebook.active&&q.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),D.infowindow.shareButtons.gplus.active&&q.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),D.infowindow.shareButtons.linkedin.active&&q.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),D.infowindow.shareButtons.email.active&&q.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(D.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),D.infowindow.shareButtons.permalink.active&&q.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>')),D.debug&&console.log("shareButtons",q),m=0;m<D.infowindow.downloads.length;m++)r.push('<a id="a-'+D.infowindow.downloads[m].name+'" class="dnl" href="#" title="'+D.infowindow.downloads[m].title+'"><img src="'+D.infowindow.downloads[m].image+'" /></a>');D.debug&&console.log("downloadButtons",r);var s='<table class="zebra"><thead><tr><th><span id="sdnlBtn">'+r.join("&nbsp;")+'</span>&nbsp;&nbsp;<span id="sshrBtn">'+q.join("&nbsp;")+'</span></th><th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[G[k].label]+'</th></tr></thead><tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">Creative Commons Attribution <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0 International</a>.</td></tr></tfoot><tbody>';for(var t in a.data)a.data.hasOwnProperty(t)&&"0"!=a.data[t]&&t.charAt(0)==t.charAt(0).toUpperCase()&&"Id"!=t.slice(0,2)&&(s+="<tr><td>"+(t.indexOf("Totale")>-1?"<b>"+t+"</b>":t)+"</td><td>"+(t.indexOf("Totale")>-1?"<b>"+parseInt(a.data[t])+"</b>":parseInt(a.data[t])||a.data[t])+"</td></tr>");for(s+="</tbody></table>",this._div.innerHTML+=s,D.infowindow.shareButtons.active&&D.urlShortener.active&&j.shorten(btnEncUrl,D.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];D.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+D.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),D.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),D.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),D.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),D.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(D.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+D.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),D.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),m=0;m<D.infowindow.downloads.length;m++)e=D.infowindow.downloads[m].path+"?resource_id="+D.infowindow.downloads[m].resourceId+"&limit=5000&filters["+l+"]="+n,f=i+"_"+D.infowindow.downloads[m].filebase+"-"+D.infowindow.downloads[m].name+"_"+l+"-"+n+".csv",d3.select("a#a-"+D.infowindow.downloads[m].name).on("click",function(){d3.json(e,function(a,b){if(b.result.records.length>0){var c=agnes.jsonToCsv(b.result.records,g),d=new Blob([c],{type:"text/csv;charset=utf-8"});saveAs(d,f)}else alert("No data!")})});d3.select(this._div).select("a#close-cross").on("click",function(){return D.debug&&console.log("clickCloseCross",arguments),U.eachLayer(function(a){a.selected=!1,U.resetStyle(a)}),delete E.i,u&&u.isAdded&&u.removeFrom(o),p.update(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===E.md?(o.dragging.enable(),this._div.innerHTML+=D.infowindow.text.mobile):this._div.innerHTML+=D.infowindow.text.default},"widget"===E.md?p.update():p.addTo(o)),D.debug&&console.log("info",p),D.controls.fullscreen.active&&"widget"!=E.md&&"embed"!=E.md&&(q=L.control.fullscreen({title:D.controls.fullscreen.title}).addTo(o)),D.debug&&console.log("fullscreen",q),D.controls.logo.active&&("widget"===E.md?r=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+E.md,!0).attr("href",D.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",D.controls.logo.image):(r=L.control({position:"topleft"}),r.onAdd=function(){var a=L.DomUtil.create("a","logo "+E.md),b=L.DomUtil.create("img","logo",a);return a.setAttribute("href",D.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",D.controls.logo.image),a},r.addTo(o))),D.debug&&console.log("logo",r),D.controls.reset.active&&(s=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),s.onAdd=function(a){var b=L.DomUtil.create("img","reset "+E.md);return b.setAttribute("src",D.controls.reset.image),b.setAttribute("title",D.controls.reset.title),d3.select(b).on("click",function(){i(E.ml),a.fitBounds(O)}),b},s.addTo(o)),D.debug&&console.log("reset",s),D.controls.embed.active&&(u=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),u.isAdded=!1,u.onRemove=function(){this.isAdded=!1},u.onAdd=function(){this.isAdded=!0;var a={},b=E.md,c=L.DomUtil.create("div","info embed-inputarea"),d="http://"+location.hostname+Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),e="http://"+location.hostname+encodeURIComponent(Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));D.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",c),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+d+'" readonly></input>'),D.urlShortener.active&&D.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",c),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',j.shorten(e,D.urlShortener.prefix+md5(d),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),E.md="embed",D.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",c),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+d+'&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),E.md="widget",D.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",c),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+d+'&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),E.md="embed",D.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",c),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(Arg.url(E).replace(/^[^?]+\?/,"").replace(/&/g," "))+']" readonly></input>'),E.md=b,D.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",c),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+D.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,D.controls.embed.svg.filename)}));for(var f in a)a.hasOwnProperty(f)&&d3.select(a[f]).select("input").on("focus",function(){this.select()});return c},t=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),t.onAdd=function(a){var b=L.DomUtil.create("img","embed "+E.md);return b.setAttribute("src",D.controls.embed.image),b.setAttribute("title",D.controls.embed.title),d3.select(b).on("click",function(){u.isAdded?u&&u.isAdded&&u.removeFrom(a):u.addTo(a)}),b},t.addTo(o)),D.debug&&console.log("embed",t),D.controls.screenshot.active&&"widget"!=E.md&&(v=L.control({position:"mobile"===E.md?"bottomleft":"topright"}),v.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+E.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",D.controls.screenshot.image),a.setAttribute("title",D.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=D.controls.screenshot.offsetX,d=D.controls.screenshot.offsetY;canvg(a,b.node().outerHTML,{ignoreMouse:D.controls.screenshot.ignoreMouse,ignoreAnimation:D.controls.screenshot.ignoreAnimation,ignoreDimensions:D.controls.screenshot.ignoreDimensions,ignoreClear:D.controls.screenshot.ignoreClear,offsetX:"number"==typeof c?c:k[0],offsetY:"number"==typeof d?d:k[1]}),a.toBlob(function(a){saveAs(a,D.controls.screenshot.filename)})}})}),a},v.addTo(o)),D.debug&&console.log("screenshot",v),D.controls.detach.active&&("embed"===E.md||"widget"===E.md)&&(w=L.control({position:"topright"}),w.onAdd=function(){var a=L.DomUtil.create("a","detach "+E.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",D.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",D.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(E).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},w.addTo(o)),D.debug&&console.log("detach",w),D.controls.socialButtons.active&&(E.md||(x=L.control({position:"bottomleft"}),x.onAdd=function(){var a=L.DomUtil.create("div","share "+E.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",D.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+D.controls.socialButtons.twitter.via+'" data-lang="'+D.controls.socialButtons.twitter.lang+'" data-related="'+D.controls.socialButtons.twitter.related+'" data-hashtags="'+D.controls.socialButtons.twitter.hashtags+'" data-count="'+D.controls.socialButtons.twitter.count+'">'+D.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),D.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+D.controls.socialButtons.facebook.layout+'" data-action="'+D.controls.socialButtons.facebook.action+'" data-show-faces="'+D.controls.socialButtons.facebook["show-faces"]+'" data-share="'+D.controls.socialButtons.facebook.share+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+D.controls.socialButtons.facebook.appId+"&version=v2.0")),D.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+D.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+D.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a},x.addTo(o))),D.debug&&console.log("share",x),l=D.geoLayers.filter(function(a){return a.inSelectorControl}),l.length&&(y=L.control({position:"topleft"}),y.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+E.md);return a.setAttribute("id","menu-ui"),"widget"===E.md&&a.setAttribute("style","display:none;"),a},y.addTo(o),d3.select("nav#menu-ui").selectAll("a").data(d3.keys(F)).enter().append("a").attr("href","#").attr("id",function(a){return a}).classed("disabled",function(a){return!(G.hasOwnProperty(a)&&G[a].inSelectorControl)}).on("click",function(a){G.hasOwnProperty(a)&&(delete E.i,u&&u.isAdded&&u.removeFrom(o),p.update(),i(a))}).text(function(a){return a})),D.debug&&console.log("menuLayers",l),D.debug&&console.log("menu",y),D.controls.geocoder.active&&"widget"!=E.md&&"mobile"!=E.md&&(z=new L.Control.OSMGeocoder({collapsed:D.controls.geocoder.collapsed,position:"topleft",text:D.controls.geocoder.title,bounds:O,email:D.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete E.i,u&&u.isAdded&&u.removeFrom(o),p.update(),i(D.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:D.controls.geocoder.zoom})}}}),o.addControl(z),D.controls.geocoder.autocomplete.active)){z._completely=completely(z._input),z._completely.onChange=function(a){z._completely.startFrom=a.lastIndexOf(" ")+1,z._completely.repaint()},z._completely.input.maxLength=50;var T;T=E.t?D.controls.geocoder.autocomplete.path+D.controls.geocoder.autocomplete.prefix+E.t+"."+D.controls.geocoder.autocomplete.format:D.controls.geocoder.autocomplete.path+D.controls.geocoder.autocomplete.filename+"."+D.controls.geocoder.autocomplete.format,d3.json(T,function(a,b){F[D.controls.geocoder.layer].list=b,z._completely.options=F[D.controls.geocoder.layer].list.map(function(a){return a[G[D.controls.geocoder.layer].label]})})}D.debug&&console.log("osmGeocoder",z),D.legend.active&&(A=L.control({position:"bottomleft"}),A.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+E.md),this._div.innerHTML="widget"!=E.md?"<h4>"+D.legend.title+"</h4>":"",this._div},A.update=function(a){var b=I[a].ranges;this._div.innerHTML="widget"!=E.md?'<h4 title="'+D.legend.description+'">'+D.legend.title+"</h4>":"";for(var c=0;c<b.length;c++){var d=colorbrewer.Reds[b.length]?colorbrewer.Reds[b.length][c]:colorbrewer.Reds[3][c];this._div.innerHTML+='<i title="Tra '+b[c].replace("-","e")+" "+D.legend.itemLabel+'" style="background:'+d+'"></i> '+("widget"!=E.md?b[c]:"")+"<br>"}"widget"!=E.md&&(this._div.innerHTML+="<br>"+D.legend.description)},A.addTo(o)),D.debug&&console.log("legend",A);var U,V=new L.Label;U=L.geoJson("",{style:b,onEachFeature:f}).addTo(o),D.debug&&console.log("geojson",U),setTimeout(function(){o.spin(!1),i(E.dl)},3e3)})}(mapConfig);