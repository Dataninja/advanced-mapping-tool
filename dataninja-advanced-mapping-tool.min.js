/*! dataninja-advanced-mapping-tool 14-11-2014 */
!function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){for(var d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){var c=b.properties._layer,d=G.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=M[c].map(function(a){return a.active}).indexOf(!0),f=d.style.default;return f.fillColor=a(b.properties.data[M[c][e].name][M[c][e].value],M[c][e].bins,M[c][e].palette),f}function c(a){var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=G.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=M[d].map(function(a){return a.active}).indexOf(!0),g=e.style.highlight;b.selected||b.setStyle(g),G.hasOwnProperty("label")&&G.label.active&&(ab.setContent(c[J[d].label]+"<br>"+G.label.text+": "+c.data[M[d][f].name][M[d][f].value]),ab.setLatLng(b.getBounds().getCenter()),n.showLabel(ab))}function d(a){{var b=a.target,c=b.feature.properties._layer,d=G.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||_.eachLayer(function(a){a.selected||_.resetStyle(a)}),G.hasOwnProperty("label")&&G.label.active&&ab.close()}function e(a,b){G.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=G.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;_.eachLayer(function(a){a.selected=!1,_.resetStyle(a)}),b.selected=!0,b.setStyle(e),H.i=b.feature.properties[J[H.dl].id],v&&v.isAdded&&v.removeFrom(n),q.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){b.on({mouseover:c,mouseout:d,click:e})}function g(a){G.debug&&console.log("joinDataFunction",arguments);for(var b,c,d=0;d<J[a].resource.length;d++){b=J[a].resource[d].properties[J[a].id],J[a].resource[d].properties.data={};for(var e=0;e<M[a].length;e++){M[a][e].active=!e;for(var f=0;f<M[a][e].resource.length;f++){var c=M[a][e].resource[f][M[a][e].id];if(c==b){J[a].resource[d].properties.data[M[a][e].name]=M[a][e].resource[f];for(var g in J[a].resource[d].properties.data[M[a][e].name])J[a].resource[d].properties.data[M[a][e].name].hasOwnProperty(g)&&(J[a].resource[d].properties.data[M[a][e].name][g]=M[a][e].parse(J[a].resource[d].properties.data[M[a][e].name][g]));J[a].resource[d].properties._layer=a}}}d3.keys(J[a].resource[d].properties.data).length||(J[a].resource.splice(d,1),d--)}}function h(a){G.debug&&console.log("binDataFunction",arguments);var b=M[a].map(function(a){return a.active}).indexOf(!0),c=M[a][b].value,d=(G.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],G.dataSets.filter(function(b){return b.schema.layer===a})[b]),e=M[a][b].resource.map(function(a){return a[c]}),f=new geostats(e);M[a][b].bins=f.getJenks(e.length>d.bins?d.bins:e.length-1),M[a][b].ranges=f.ranges,D.update(a)}function i(a,b){G.debug&&console.log("loadDataFunction",arguments);var c,d,f,i=G.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],j=G.dataSets.filter(function(b){return b.schema.layer===a});if(d3.selectAll("nav#geomenu-ui a").classed("active",!1),d3.select("nav#geomenu-ui a#"+a).classed("active",!0),d3.selectAll("nav#datamenu-ui a").classed("active",!1),d3.select("nav#datamenu-ui a#"+(b||j[0].schema.name)).classed("active",!0),d3.select("nav#datamenu-ui select").attr("disabled",null),H.dl=a,_.clearLayers(),G.debug&&console.log("geoLayer",i),G.debug&&console.log("dataSets",j),J[a].resource)h(a),_.addData(J[a].resource),delete H.i,v&&v.isAdded&&v.removeFrom(n),D.update(a),q.update();else{n.spin(!0),f=queue(),c=i.url.call(i,a,H.t?H.tl:void 0,H.t||void 0),f.defer(d3[i.format],c),G.debug&&console.log("geoPath",c);for(var l=0;l<j.length;l++)d=j[l].url.call(j[l],a,H.t?K[H.tl].id:void 0,H.t||void 0),f.defer(d3[j[l].format],d),G.debug&&console.log("dataPath",l,d);f.await(function(b,c){G.debug&&console.log("await",arguments),J[a].resource=i.transform(c);for(var d=2;d<arguments.length;d++)M[a][d-2].resource=j[d-2].transform(arguments[d]);n.spin(!1),g(a),h(a),_.addData(J[a].resource),k||(k=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),H.t&&n.fitBounds(_.getBounds()),H.i&&_.eachLayer(function(b){b.feature.properties[J[a].id]==H.i&&e(null,b)})})}}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G=mapConfig,H=Arg.query(),I={},J={},K={},M={};for(l=0;l<G.geoLayers.length;l++){F=G.geoTypes[G.geoLayers[l].type];for(m in F)if(F.hasOwnProperty(m))if(G.geoLayers[l].hasOwnProperty(m)){if("object"==typeof F[m])for(var N in F[m])F[m].hasOwnProperty(N)&&!G.geoLayers[l][m].hasOwnProperty(N)&&(G.geoLayers[l][m][N]=F[m][N])}else G.geoLayers[l][m]=F[m];E=G.geoSources[G.geoLayers[l].source];for(m in E)E.hasOwnProperty(m)&&!G.geoLayers[l].hasOwnProperty(m)&&(G.geoLayers[l][m]=E[m]);G.geoLayers[l].active||(G.geoLayers.splice(l,1),l--)}for(l=0;l<G.dataSets.length;l++){F=G.dataTypes[G.dataSets[l].type];for(m in F)F.hasOwnProperty(m)&&!G.dataSets[l].hasOwnProperty(m)&&(G.dataSets[l][m]=F[m]);E=G.dataSources[G.dataSets[l].source];for(m in E)E.hasOwnProperty(m)&&!G.dataSets[l].hasOwnProperty(m)&&(G.dataSets[l][m]=E[m]);var O=G.geoLayers.filter(function(a){return a.hasOwnProperty("schema")&&a.schema.name===G.dataSets[l].schema.layer});O.length&&O[0].active||(G.dataSets.splice(l,1),l--)}if(G.hasOwnProperty("infowindow")&&G.infowindow.active&&G.infowindow.hasOwnProperty("downloads")&&G.infowindow.downloads.active)for(l=0;l<G.infowindow.downloads.files.length;l++)if(G.infowindow.downloads.files[l].active){E=G.dataSources[G.infowindow.downloads.files[l].source];for(m in E)E.hasOwnProperty(m)&&!G.infowindow.downloads.files[l].hasOwnProperty(m)&&(G.infowindow.downloads.files[l][m]=E[m])}if(G.hasOwnProperty("pointsSet")&&G.pointsSet.active){E=G.dataSources[G.pointsSet.source];for(m in E)E.hasOwnProperty(m)&&!G.pointsSet.hasOwnProperty(m)&&(G.pointsSet[m]=E[m])}for(G.debug&&console.log("$",G),G.hasOwnProperty("urlShortener")&&G.urlShortener.active&&(j=yourls.connect(G.urlShortener.url.call(G.urlShortener),{signature:G.urlShortener.signature})),G.debug&&console.log("dtnj",j),l=0;l<G.geoLayers.length;l++)"vector"===G.geoLayers[l].type&&(I[G.geoLayers[l].schema.name]={id:G.geoLayers[l].schema.id,label:G.geoLayers[l].schema.label,resource:null,list:[]});for(G.debug&&console.log("defaultGeo",I),l=0;l<G.dataSets.length;l++)if(K[G.dataSets[l].schema.name]={id:G.dataSets[l].schema.id,label:G.dataSets[l].schema.label,value:"string"==typeof G.dataSets[l].schema.values?G.dataSets[l].schema.values:G.dataSets[l].schema.values[0],values:"string"==typeof G.dataSets[l].schema.values?[G.dataSets[l].schema.values]:G.dataSets[l].schema.values,layer:G.dataSets[l].schema.layer,name:G.dataSets[l].schema.name,resourceId:G.dataSets[l].resourceId,resource:null,bins:[],ranges:[],palette:G.dataSets[l].palette,active:!1},"string"==typeof G.dataSets[l].parse){var P=G.dataSets[l].parse;K[G.dataSets[l].schema.name].parse=function(a){return isNaN(window[P](a))?a:window[P](a)}}else K[G.dataSets[l].schema.name].parse="function"==typeof G.dataSets[l].parse?G.dataSets[l].parse:function(a){return isNaN(parseFloat(a))?a:parseFloat(a)};for(G.debug&&console.log("defaultData",K),H.ls=H.ls||d3.keys(I),H.ml=H.ls[0],H.dl=H.dl||H.ml,H.md=H.md||(head.mobile?"mobile":""),d3.select("body").classed(H.md,!0),H.t&&(H.tl=H.tl||H.ml,H.ml=H.ls[H.ls.indexOf(H.tl)+1],H.ls.indexOf(H.dl)<H.ls.indexOf(H.tl)+1&&(H.dl=H.ml)),G.hasOwnProperty("pointsSet")&&G.pointsSet.active&&H.mr&&H.mr.hasOwnProperty("rid")&&(G.pointsSet.resourceId=H.mr.rid,H.mr.lat=H.mr.lat||"lat",H.mr.lng=H.mr.lng||"lng"),G.debug&&console.log("parameters",H),l=H.ls.indexOf(H.ml);l<H.ls.length;l++)if(I.hasOwnProperty(H.ls[l])){var Q=[];for(m in K)K.hasOwnProperty(m)&&K[m].layer===H.ls[l]&&Q.push(K[m]);Q.length&&(J[H.ls[l]]=I[H.ls[l]],M[H.ls[l]]=Q)}G.debug&&console.log("geo",J),G.debug&&console.log("data",M);var R,S,T,U,V,W;G.map.hasOwnProperty("bounds")&&(G.map.bounds.hasOwnProperty("init")&&(R=L.latLng(G.map.bounds.init.southWest),S=L.latLng(G.map.bounds.init.northEast),T=L.latLngBounds(R,S)),G.map.bounds.hasOwnProperty("max")&&(U=L.latLng(G.map.bounds.max.southWest),V=L.latLng(G.map.bounds.max.northEast),W=L.latLngBounds(U,V))),n=L.map("map",{maxZoom:G.map.zoom.max||null,minZoom:G.map.zoom.min||null,zoom:G.map.zoom.init||null,center:G.map.center||(T?T.getCenter():null),scrollWheelZoom:G.map.zoom.scrollWheel||!0,attributionControl:!G.map.attribution.length,maxBounds:W||null}),!G.map.zoom.init&&T&&n.fitBounds(T),G.debug&&console.log("map",n);var X=G.geoLayers.filter(function(a){return"tile"===a.type});for(G.debug&&console.log("tileLayers",X),l=0;l<X.length;l++)L.tileLayer(X[l].url.call(X[l]),X[l].options).addTo(n);for(n.spin(!0),p=L.control.attribution(),l=0;l<G.map.attribution.length;l++)p.addAttribution(G.map.attribution[l]);G.debug&&console.log("attrib",p),p.addTo(n),G.hasOwnProperty("description")&&G.description.active&&"widget"!=H.md&&(G.description.position=G.description.position||"right",d3.select("body").classed("description "+G.description.position,!0),o="top"===G.description.position||"left"===G.description.position?d3.select("body").insert("div","#map"):d3.select("body").append("div"),o.attr("id","map-description").attr("class","description "+G.description.position).append("div").html(G.description.content||"")),G.hasOwnProperty("infowindow")&&G.infowindow.active&&("widget"===H.md?(q={},q._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info bottom").node()):G.infowindow.hasOwnProperty("position")&&"inside"!=G.infowindow.position?(q={},d3.select("body").classed("description "+G.infowindow.position,!0),"top"===G.infowindow.position||"left"===G.infowindow.position?q._div=d3.select("body").insert("div","#map").attr("id","infowindow").attr("class","info external "+G.infowindow.position).node():("right"===G.infowindow.position||"bottom"===G.infowindow.position)&&(q._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info external "+G.infowindow.position).node())):(q=L.control({position:"bottomright"}),q.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+H.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),q.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===H.md&&n.dragging.disable();var b,c,d,e=agnes.rowDelimiter(),f=new Date,g=d3.time.format("%Y%m%d")(f),h=a._layer,i=M[h].map(function(a){return a.active}).indexOf(!0),k=M[h][i].id,m=a[J[h].id],o=[],p=[];if(G.infowindow.hasOwnProperty("shareButtons")&&G.infowindow.shareButtons.active&&(b=G.infowindow.shareButtons.title+("regioni"==h?" in ":" a ")+a[J[h].label],c="http://"+location.hostname+Arg.url(H).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(H).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[J[h].label],G.infowindow.shareButtons.hasOwnProperty("twitter")&&G.infowindow.shareButtons.twitter.active&&o.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+G.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+G.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),G.infowindow.shareButtons.hasOwnProperty("facebook")&&G.infowindow.shareButtons.facebook.active&&o.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),G.infowindow.shareButtons.hasOwnProperty("gplus")&&G.infowindow.shareButtons.gplus.active&&o.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),G.infowindow.shareButtons.hasOwnProperty("linkedin")&&G.infowindow.shareButtons.linkedin.active&&o.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),G.infowindow.shareButtons.hasOwnProperty("email")&&G.infowindow.shareButtons.email.active&&o.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(G.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+G.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),G.infowindow.shareButtons.hasOwnProperty("permalink")&&G.infowindow.shareButtons.permalink.active&&o.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>')),G.debug&&console.log("shareButtons",o),G.infowindow.hasOwnProperty("downloads")&&G.infowindow.downloads.active)for(l=0;l<G.infowindow.downloads.files.length;l++)G.infowindow.downloads.files[l].active&&p.push('<a id="a-'+G.infowindow.downloads.files[l].name+'" class="dnl" href="#" title="'+G.infowindow.downloads.files[l].title+'"><img src="'+G.infowindow.downloads.files[l].image+'" /></a>');G.debug&&console.log("downloadButtons",p);var r="<thead><tr><th>"+(p.length?'<span id="sdnlBtn">'+p.join("&nbsp;")+"</span>&nbsp;&nbsp;":"")+(o.length?'<span id="sshrBtn">'+o.join("&nbsp;")+"</span>":"")+'</th><th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[J[h].label]+"</th></tr></thead>";G.debug&&console.log("Table header",r);var s;s=G.infowindow.hasOwnProperty("downloads")&&G.infowindow.downloads.active?'<tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">'+(G.infowindow.downloads.license||"")+"</td></tr></tfoot>":"<tfoot></tfoot>",G.debug&&console.log("Table footer",s);var t;if(G.infowindow.hasOwnProperty("view")&&G.infowindow.view.active&&G.viewTypes.hasOwnProperty(G.infowindow.view.type)?(t=G.viewTypes[G.infowindow.view.type](a.data[M[h][i].name],G.infowindow.view.options),t.indexOf("<tbody>")>-1||(t="<tbody>"+t+"</tbody>")):t="<tbody></tbody>",G.debug&&console.log("Table body",t),this._div.innerHTML+='<table class="zebra">'+r+t+s+"</table>",G.debug&&console.log("Table",this._div.innerHTML),G.infowindow.hasOwnProperty("shareButtons")&&G.infowindow.shareButtons.active&&G.hasOwnProperty("urlShortener")&&G.urlShortener.active&&j.shorten(btnEncUrl,G.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];G.infowindow.shareButtons.hasOwnProperty("twitter")&&G.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+G.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+G.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),G.infowindow.shareButtons.hasOwnProperty("facebook")&&G.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),G.infowindow.shareButtons.hasOwnProperty("gplus")&&G.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),G.infowindow.shareButtons.hasOwnProperty("linkedin")&&G.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),G.infowindow.shareButtons.hasOwnProperty("email")&&G.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(G.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+G.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),G.infowindow.shareButtons.hasOwnProperty("permalink")&&G.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),G.infowindow.hasOwnProperty("downloads")&&G.infowindow.downloads.active)for(l=0;l<G.infowindow.downloads.files.length;l++)G.infowindow.downloads.files[l].active&&!function(a){var b=G.infowindow.downloads.files[a].url.call(G.infowindow.downloads.files[a],h,k,m),c=g+"_"+G.infowindow.downloads.files[a].filebase+"-"+G.infowindow.downloads.files[a].name+(k&&m?"_"+k+"-"+m:"")+".csv";d3.select("a#a-"+G.infowindow.downloads.files[a].name).on("click",function(){G.debug&&console.log(this,a,G.infowindow.downloads.files[a].name,b,c),d3[G.infowindow.downloads.files[a].format](b,function(b,d){var f=G.infowindow.downloads.files[a].transform(d);if(f.length>0){var g=agnes.jsonToCsv(f,e),h=new Blob([g],{type:"text/csv;charset=utf-8"});saveAs(h,c)}else alert("No data!")})})}(l);d3.select(this._div).select("a#close-cross").on("click",function(){return G.debug&&console.log("clickCloseCross",arguments),_.eachLayer(function(a){a.selected=!1,_.resetStyle(a)}),delete H.i,v&&v.isAdded&&v.removeFrom(n),q.update(),n.scrollWheelZoom.enable(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===H.md?(n.dragging.enable(),this._div.innerHTML+=G.infowindow.content.mobile):this._div.innerHTML+=G.infowindow.content.default},"widget"===H.md||G.infowindow.hasOwnProperty("position")&&"inside"!=G.infowindow.position?q.update():q.addTo(n)),G.debug&&console.log("info",q),G.controls.hasOwnProperty("fullscreen")&&G.controls.fullscreen.active&&"widget"!=H.md&&"embed"!=H.md&&(r=L.control.fullscreen({title:G.controls.fullscreen.title}).addTo(n)),G.debug&&console.log("fullscreen",r),G.controls.hasOwnProperty("logo")&&G.controls.logo.active&&("widget"===H.md?s=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+H.md,!0).attr("href",G.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",G.controls.logo.image):(s=L.control({position:"topleft"}),s.onAdd=function(){var a=L.DomUtil.create("a","logo "+H.md),b=L.DomUtil.create("img","logo"+(G.controls.logo.border?" border":""),a);return a.setAttribute("href",G.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",G.controls.logo.image),a},s.addTo(n))),G.debug&&console.log("logo",s),G.controls.hasOwnProperty("reset")&&G.controls.reset.active&&(t=L.control({position:"mobile"===H.md?"bottomleft":"topright"}),t.onAdd=function(a){var b=L.DomUtil.create("img","reset "+H.md);return b.setAttribute("src",G.controls.reset.image),b.setAttribute("title",G.controls.reset.title),d3.select(b).on("click",function(){i(H.ml),a.fitBounds(T)}),b},t.addTo(n)),G.debug&&console.log("reset",t),G.controls.hasOwnProperty("embed")&&G.controls.embed.active&&(v=L.control({position:"mobile"===H.md?"bottomleft":"topright"}),v.isAdded=!1,v.onRemove=function(){this.isAdded=!1},v.onAdd=function(){this.isAdded=!0;var a={},b=L.DomUtil.create("div","info embed-inputarea"),c="http://"+location.hostname+Arg.url(H).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),d="http://"+location.hostname+encodeURIComponent(Arg.url(H).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));G.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",b),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+c+'" readonly></input>'),G.hasOwnProperty("urlShortener")&&G.urlShortener.active&&G.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",b),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',j.shorten(d,G.urlShortener.prefix+md5(c),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),G.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",b),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+c+'&md=embed&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),G.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",b),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+c+'&md=widget&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),G.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",b),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(c).replace(/^[^?]+\?/,"").replace(/&/g," ")+' md=embed]" readonly></input>'),G.controls.embed.hasOwnProperty("svg")&&G.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",b),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+G.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,G.controls.embed.svg.filename)}));for(var e in a)a.hasOwnProperty(e)&&d3.select(a[e]).select("input").on("focus",function(){this.select()});return b},u=L.control({position:"mobile"===H.md?"bottomleft":"topright"}),u.onAdd=function(a){var b=L.DomUtil.create("img","embed "+H.md);return b.setAttribute("src",G.controls.embed.image),b.setAttribute("title",G.controls.embed.title),d3.select(b).on("click",function(){v.isAdded?v&&v.isAdded&&v.removeFrom(a):v.addTo(a)}),b},u.addTo(n)),G.debug&&console.log("embed",u),G.controls.hasOwnProperty("screenshot")&&G.controls.screenshot.active&&"widget"!=H.md&&(w=L.control({position:"mobile"===H.md?"bottomleft":"topright"}),w.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+H.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",G.controls.screenshot.image),a.setAttribute("title",G.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=G.controls.screenshot.offsetX||"auto",d=G.controls.screenshot.offsetY||"auto";canvg(a,b.node().outerHTML,{ignoreMouse:G.controls.screenshot.ignoreMouse||!0,ignoreAnimation:G.controls.screenshot.ignoreAnimation||!0,ignoreDimensions:G.controls.screenshot.ignoreDimensions||!0,ignoreClear:G.controls.screenshot.ignoreClear||!0,offsetX:"number"==typeof c?c:k[0],offsetY:"number"==typeof d?d:k[1]}),a.toBlob(function(a){saveAs(a,G.controls.screenshot.filename)})}})}),a},w.addTo(n)),G.debug&&console.log("screenshot",w),G.controls.hasOwnProperty("detach")&&G.controls.detach.active&&("embed"===H.md||"widget"===H.md)&&(x=L.control({position:"topright"}),x.onAdd=function(){var a=L.DomUtil.create("a","detach "+H.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(H).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",G.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",G.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(H).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},x.addTo(n)),G.debug&&console.log("detach",x),G.controls.hasOwnProperty("socialButtons")&&G.controls.socialButtons.active&&(H.md||(z=L.control({position:"bottomleft"}),z.onAdd=function(){var a=L.DomUtil.create("div","share "+H.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",G.controls.socialButtons.hasOwnProperty("twitter")&&G.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+G.controls.socialButtons.twitter.via+'" data-lang="'+G.controls.socialButtons.twitter.lang+'" data-related="'+G.controls.socialButtons.twitter.related+'" data-hashtags="'+G.controls.socialButtons.twitter.hashtags+'" data-count="'+G.controls.socialButtons.twitter.count+'">'+G.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),G.controls.socialButtons.hasOwnProperty("facebook")&&G.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+G.controls.socialButtons.facebook.layout+'" data-action="'+G.controls.socialButtons.facebook.action+'" data-show-faces="'+G.controls.socialButtons.facebook["show-faces"].toString()+'" data-share="'+G.controls.socialButtons.facebook.share.toString()+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+G.controls.socialButtons.facebook.appId+"&version=v2.0")),G.controls.socialButtons.hasOwnProperty("gplus")&&G.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+G.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+G.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a},z.addTo(n))),G.debug&&console.log("share",z);var Y=G.geoLayers.filter(function(a){return"tile"!=a.type});if(Y.length>1&&(A=L.control({position:"topleft"}),A.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+H.md);return a.setAttribute("id","geomenu-ui"),"widget"===H.md&&a.setAttribute("style","display:none;"),a},A.addTo(n),d3.select("nav#geomenu-ui").selectAll("a").data(Y.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).classed("disabled",function(a){return!J.hasOwnProperty(a.name)}).on("click",function(a,b){if(J.hasOwnProperty(a.name)){var c=a.name;M[c][0].active=!0;for(var b=0;b<M[c].length;b++)0!=b&&(M[c][b].active=!1);delete H.i,v&&v.isAdded&&v.removeFrom(n),q.update(),D.update(),B.update(a.name),B.onChange(a.name),i(a.name)}}).text(function(a){return a.menu})),G.debug&&console.log("menuGeoLayers",Y),G.debug&&console.log("geoMenu",A),B=L.control({position:"topleft"}),B.onAdd=function(a){var b=L.DomUtil.create("nav","menu-ui "+H.md);return b.setAttribute("id","datamenu-ui"),"widget"===H.md&&b.setAttribute("style","display:none;"),this._nav=b,d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},B.onChange=function(a,b){d3.select(this._nav).select("select").remove();var b=b||0,c=M[a][b].values;c&&c.length>1&&d3.select(this._nav).append("select").attr("disabled","disabled").on("change",function(){var c=d3.select(this).property("selectedIndex"),d=d3.select(this).selectAll("option")[0][c].__data__;M[a][b].value=d,i(a,M[a][b].name)}).selectAll("option").data(c).enter().append("option").text(function(a){return a})},B.update=function(a){if(d3.select(this._nav).style("display",null).selectAll("a, select").remove(),a){var b=G.dataSets.filter(function(b){return b.schema.layer===a});b.length>1?d3.select(this._nav).selectAll("a").data(b.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).on("click",function(a,b){var c=a.layer;M[c][b].active=!0;for(var d=0;d<M[c].length;d++)d!=b&&(M[c][d].active=!1);delete H.i,v&&v.isAdded&&v.removeFrom(n),q.update(),D.update(),B.onChange(c,b),i(c,a.name)}).text(function(a){return a.menu}):d3.select(this._nav).style("display","none")}},B.addTo(n),B.update(Y[0].schema.name),B.onChange(Y[0].schema.name),G.debug&&console.log("dataMenu",B),G.controls.hasOwnProperty("geocoder")&&G.controls.geocoder.active&&"widget"!=H.md&&"mobile"!=H.md&&(C=new L.Control.OSMGeocoder({collapsed:G.controls.geocoder.collapsed,position:"topleft",text:G.controls.geocoder.title,bounds:T,email:G.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete H.i,v&&v.isAdded&&v.removeFrom(n),q.update(),i(G.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:G.controls.geocoder.zoom})}}}),n.addControl(C),G.controls.geocoder.hasOwnProperty("autocomplete")&&G.controls.geocoder.autocomplete.active)){C._completely=completely(C._input),C._completely.onChange=function(a){C._completely.startFrom=a.lastIndexOf(" ")+1,C._completely.repaint()},C._completely.input.maxLength=50;var Z=G.controls.geocoder.autocomplete.url.call(G.controls.geocoder.autocomplete,H.t||void 0);d3[G.controls.geocoder.autocomplete.format](Z,function(a,b){I[G.controls.geocoder.layer].list=G.controls.geocoder.autocomplete.transform(b),C._completely.options=I[G.controls.geocoder.layer].list.map(function(a){return a[J[G.controls.geocoder.layer].label]})})}if(G.debug&&console.log("osmGeocoder",C),G.debug&&(y=L.control({position:"bottomleft"}),y.onAdd=function(a){var b=L.DomUtil.create("div","devutil");return d3.select(b).append("p").attr("id","devutil-coord").text("Mouse position: ..."),d3.select(b).append("p").attr("id","devutil-sw").text("SouthWest bound: "+a.getBounds().getSouthWest().toString()),d3.select(b).append("p").attr("id","devutil-ne").text("NorthEast bound: "+a.getBounds().getNorthEast().toString()),d3.select(b).append("p").attr("id","devutil-center").text("Map center: "+a.getCenter().toString()),d3.select(b).append("p").attr("id","devutil-zoom").text("Zoom level: "+a.getZoom()),d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},y.addTo(n),n.on("mousemove",function(a){d3.select("#devutil-coord").text("Mouse position: "+a.latlng.toString())}).on("move",function(){d3.select("#devutil-sw").text("SouthWest bound: "+n.getBounds().getSouthWest().toString()),d3.select("#devutil-ne").text("NorthEast bound: "+n.getBounds().getNorthEast().toString()),d3.select("#devutil-center").text("Map center: "+n.getCenter().toString())}).on("zoomend",function(){d3.select("#devutil-zoom").text("Zoom level: "+n.getZoom())})),G.hasOwnProperty("legend")&&G.legend.active&&(D=L.control({position:"bottomleft"}),D.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+H.md),this._div},D.update=function(a){if(a){var b=M[a].map(function(a){return a.active}).indexOf(!0),c=G.dataSets.filter(function(b){return b.schema.layer===a})[b],d=M[a][b].ranges;this._div.innerHTML="widget"!=H.md?'<h4 title="'+G.legend.description+'">'+G.legend.title+"</h4>":"";for(var e=0;e<d.length;e++){var f=colorbrewer[c.palette][d.length]?colorbrewer[c.palette][d.length][e]:colorbrewer[c.palette][3][e];
this._div.innerHTML+='<i title="Tra '+d[e].replace("-","e")+" "+G.legend.itemLabel+'" style="background:'+f+'"></i> '+("widget"!=H.md?d[e]:"")+"<br>"}"widget"!=H.md&&(this._div.innerHTML+="<br>"+G.legend.description)}else this._div.innerHTML="widget"!=H.md?"<h4>"+G.legend.title+"</h4>":""},D.addTo(n),D.update()),G.debug&&console.log("legend",D),G.pointsSet&&G.pointsSet.active&&G.pointsSet.resourceId){var $=G.pointsSet.url.call(G.pointsSet);G.debug&&console.log("markersPath",$),d3[G.pointsSet.format]($,function(a,b){G.debug&&console.log("markers",arguments);var c=b?G.pointsSet.transform(b):null;if(c){for(var d=new L.MarkerClusterGroup({showCoverageOnHover:!1}),e=[],f=0;f<c.length;f++){var g=L.marker();g.setIcon(L.icon({iconUrl:G.pointsSet.icon,shadowUrl:G.pointsSet.shadow})),g.setLatLng(L.latLng(c[f][H.mr.lat],c[f][H.mr.lng])),H.mr.hasOwnProperty("iw")&&g.bindPopup(c[f][H.mr.iw]),e.push(g),d.addLayer(g)}n.addLayer(G.pointsSet.clusters?d:L.layerGroup(e))}})}var _,ab=new L.Label;_=L.geoJson("",{style:b,onEachFeature:f}).addTo(n),G.debug&&console.log("geojson",_),setTimeout(function(){n.spin(!1),i(H.dl)},3e3)})}(mapConfig);