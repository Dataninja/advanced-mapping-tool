/*! dataninja-advanced-mapping-tool 15-11-2014 */
!function(a){if(console.log("mapConfig",mapConfig),!a)throw"ERRORE: configurazione errata o mancante...";head.ready(function(){function a(a,b,c){for(var d=colorbrewer[c][b.length-1]?b.length-1:3,e=1;e<b.length;e++)if(a<=b[e])return colorbrewer[c][d][e-1]}function b(b){var c=b.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=w[c].filter(function(a){return a.active})[0],f=d.style.default;return f.fillColor=a(b.properties.data[e.name][e.value],e.bins,e.palette),f}function c(a){var b=a.target,c=b.feature.properties,d=b.feature.properties._layer,e=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===d})[0],f=w[d].filter(function(a){return a.active})[0],g=e.style.highlight,h=c.data[f.name][f.value];b.selected||b.setStyle(g),m.hasOwnProperty("label")&&m.label.active&&(bb.setContent(c[u[d].label]+"<br>"+f.label+": "+(f.formatter(f.value,h)?d3.format(f.formatter(f.value,h))(h):d3.format(",d")(h)||d3.format(",.2f")(h)||h)),bb.setLatLng(b.getBounds().getCenter()),A.showLabel(bb))}function d(a){{var b=a.target,c=b.feature.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0];d.style.default}b.selected||ab.eachLayer(function(a){a.selected||ab.resetStyle(a)}),m.hasOwnProperty("label")&&m.label.active&&bb.close()}function e(a,b){m.debug&&console.log("openInfoWindowFunction",arguments);var b=b||a.target,c=b.feature.properties._layer,d=m.geoLayers.filter(function(a){return"vector"===a.type&&a.schema.name===c})[0],e=d.style.selected;ab.eachLayer(function(a){a.selected=!1,ab.resetStyle(a)}),b.selected=!0,b.setStyle(e),y.i=b.feature.properties[u[y.dl].id],Q&&Q.isAdded&&Q.removeFrom(A),K.update(b.feature.properties),L.Browser.ie||L.Browser.opera||b.bringToFront()}function f(a,b){b.on({mouseover:c,mouseout:d,click:e})}function g(a){m.debug&&console.log("joinDataFunction",arguments);for(var b,c,d=0;d<u[a].resource.length;d++){b=u[a].resource[d].properties[u[a].id],u[a].resource[d].properties.data={};for(var e=0;e<w[a].length;e++){w[a][e].active=!e;for(var f=0;f<w[a][e].resource.length;f++){var c=w[a][e].resource[f][w[a][e].id];if(c==b){u[a].resource[d].properties.data[w[a][e].name]=w[a][e].resource[f];for(var g in u[a].resource[d].properties.data[w[a][e].name])u[a].resource[d].properties.data[w[a][e].name].hasOwnProperty(g)&&(u[a].resource[d].properties.data[w[a][e].name][g]=w[a][e].parse(u[a].resource[d].properties.data[w[a][e].name][g]));u[a].resource[d].properties._layer=a}}}d3.keys(u[a].resource[d].properties.data).length||(u[a].resource.splice(d,1),d--)}}function h(a){m.debug&&console.log("binDataFunction",arguments);var b=w[a].map(function(a){return a.active}).indexOf(!0),c=w[a][b].value,d=(m.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],m.dataSets.filter(function(b){return b.schema.layer===a})[b]),e=w[a][b].resource.map(function(a){return a[c]}),f=new geostats(e);w[a][b].bins=f.getJenks(e.length>d.bins?d.bins:e.length-1),w[a][b].ranges=f.ranges,$.update(a)}function i(a,b){m.debug&&console.log("loadDataFunction",arguments);var c,d,f,i=m.geoLayers.filter(function(b){return"vector"===b.type&&b.schema.name===a})[0],k=m.dataSets.filter(function(b){return b.schema.layer===a});if(d3.selectAll("nav#geomenu-ui a").classed("active",!1),d3.select("nav#geomenu-ui a#"+a).classed("active",!0),d3.selectAll("nav#datamenu-ui a").classed("active",!1),d3.select("nav#datamenu-ui a#"+(b||k[0].schema.name)).classed("active",!0),d3.select("nav#datamenu-ui select").attr("disabled",null),y.dl=a,ab.clearLayers(),m.debug&&console.log("geoLayer",i),m.debug&&console.log("dataSets",k),u[a].resource)h(a),ab.addData(u[a].resource),delete y.i,Q&&Q.isAdded&&Q.removeFrom(A),$.update(a),K.update();else{A.spin(!0),f=queue(),c=i.url.call(i,a,y.t?y.tl:void 0,y.t||void 0),f.defer(d3[i.format],c),m.debug&&console.log("geoPath",c);for(var l=0;l<k.length;l++)d=k[l].url.call(k[l],a,y.t?v[y.tl].id:void 0,y.t||void 0),f.defer(d3[k[l].format],d),m.debug&&console.log("dataPath",l,d);f.await(function(b,c){m.debug&&console.log("await",arguments),u[a].resource=i.transform(c);for(var d=2;d<arguments.length;d++)w[a][d-2].resource=k[d-2].transform(arguments[d]);A.spin(!1),g(a),h(a),ab.addData(u[a].resource),j||(j=d3.select(".leaflet-overlay-pane svg").attr("viewBox").split(" ")),y.t&&A.fitBounds(ab.getBounds()),y.i&&ab.eachLayer(function(b){b.feature.properties[u[a].id]==y.i&&e(null,b)})})}}var j,k,l,m=mapConfig;if(m.hasOwnProperty("language")){var n;switch(m.language){case"it":n=d3.locale({decimal:",",thousands:".",grouping:[3],currency:["€ ",""],dateTime:"%a %b %e %X %Y",date:"%d/%m/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"],shortDays:["Dom","Lun","Mar","Mer","Gio","Ven","Sab"],months:["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],shortMonths:["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"]});break;default:n=d3.locale()}d3.format=n.numberFormat,d3.time.format=n.timeFormat}var o,p;for(k=0;k<m.geoLayers.length;k++){p=m.geoTypes[m.geoLayers[k].type];for(l in p)if(p.hasOwnProperty(l))if(m.geoLayers[k].hasOwnProperty(l)){if("object"==typeof p[l])for(var q in p[l])p[l].hasOwnProperty(q)&&!m.geoLayers[k][l].hasOwnProperty(q)&&(m.geoLayers[k][l][q]=p[l][q])}else m.geoLayers[k][l]=p[l];o=m.geoSources[m.geoLayers[k].source];for(l in o)o.hasOwnProperty(l)&&!m.geoLayers[k].hasOwnProperty(l)&&(m.geoLayers[k][l]=o[l]);m.geoLayers[k].active||(m.geoLayers.splice(k,1),k--)}for(k=0;k<m.dataSets.length;k++){p=m.dataTypes[m.dataSets[k].type];for(l in p)p.hasOwnProperty(l)&&!m.dataSets[k].hasOwnProperty(l)&&(m.dataSets[k][l]=p[l]);o=m.dataSources[m.dataSets[k].source];for(l in o)o.hasOwnProperty(l)&&!m.dataSets[k].hasOwnProperty(l)&&(m.dataSets[k][l]=o[l]);var r=m.geoLayers.filter(function(a){return a.hasOwnProperty("schema")&&a.schema.name===m.dataSets[k].schema.layer});r.length&&r[0].active||(m.dataSets.splice(k,1),k--)}if(m.hasOwnProperty("infowindow")&&m.infowindow.active&&m.infowindow.hasOwnProperty("downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)if(m.infowindow.downloads.files[k].active){o=m.dataSources[m.infowindow.downloads.files[k].source];for(l in o)o.hasOwnProperty(l)&&!m.infowindow.downloads.files[k].hasOwnProperty(l)&&(m.infowindow.downloads.files[k][l]=o[l])}if(m.hasOwnProperty("pointsSet")&&m.pointsSet.active){o=m.dataSources[m.pointsSet.source];for(l in o)o.hasOwnProperty(l)&&!m.pointsSet.hasOwnProperty(l)&&(m.pointsSet[l]=o[l])}m.debug&&console.log("$",m);var s;m.hasOwnProperty("urlShortener")&&m.urlShortener.active&&(s=yourls.connect(m.urlShortener.url.call(m.urlShortener),{signature:m.urlShortener.signature})),m.debug&&console.log("dtnj",s);var t={},u={};for(k=0;k<m.geoLayers.length;k++)"vector"===m.geoLayers[k].type&&(t[m.geoLayers[k].schema.name]={id:m.geoLayers[k].schema.id,label:m.geoLayers[k].schema.label,resource:null,list:[]});m.debug&&console.log("defaultGeo",t);var v={},w={};for(k=0;k<m.dataSets.length;k++)if(v[m.dataSets[k].schema.name]={name:m.dataSets[k].schema.name,menu:m.dataSets[k].schema.menu,layer:m.dataSets[k].schema.layer,id:m.dataSets[k].schema.id,values:"string"==typeof m.dataSets[k].schema.values?[m.dataSets[k].schema.values]:m.dataSets[k].schema.values,value:"string"==typeof m.dataSets[k].schema.values?m.dataSets[k].schema.values:m.dataSets[k].schema.values[0],resourceId:m.dataSets[k].resourceId,palette:m.dataSets[k].palette,transform:m.dataSets[k].transform||function(a,b){return b},formatter:m.dataSets[k].formatter||function(){return""},resource:null,bins:[],ranges:[],active:!1},m.dataSets[k].schema.hasOwnProperty("descriptions")&&m.dataSets[k].schema.descriptions.length?(v[m.dataSets[k].schema.name].descriptions="string"==typeof m.dataSets[k].schema.descriptions?[m.dataSets[k].schema.descriptions]:m.dataSets[k].schema.descriptions,v[m.dataSets[k].schema.name].description="string"==typeof m.dataSets[k].schema.descriptions?m.dataSets[k].schema.descriptions:m.dataSets[k].schema.descriptions[0]):(v[m.dataSets[k].schema.name].descriptions=v[m.dataSets[k].schema.name].values,v[m.dataSets[k].schema.name].description=v[m.dataSets[k].schema.name].value),m.dataSets[k].schema.hasOwnProperty("labels")&&m.dataSets[k].schema.labels.length?(v[m.dataSets[k].schema.name].labels="string"==typeof m.dataSets[k].schema.labels?[m.dataSets[k].schema.labels]:m.dataSets[k].schema.labels,v[m.dataSets[k].schema.name].label="string"==typeof m.dataSets[k].schema.labels?m.dataSets[k].schema.labels:m.dataSets[k].schema.labels[0]):(v[m.dataSets[k].schema.name].labels=v[m.dataSets[k].schema.name].values,v[m.dataSets[k].schema.name].label=v[m.dataSets[k].schema.name].value),"string"==typeof m.dataSets[k].parse){var x=window[m.dataSets[k].parse];v[m.dataSets[k].schema.name].parse=function(a){return x(a)||a}}else v[m.dataSets[k].schema.name].parse="function"==typeof m.dataSets[k].parse?m.dataSets[k].parse:function(a){return parseInt(a)||parseFloat(a)||a};m.debug&&console.log("defaultData",v);var y=Arg.query();for(y.ls=y.ls||d3.keys(t),y.ml=y.ls[0],y.dl=y.dl||y.ml,y.md=y.md||(head.mobile?"mobile":""),d3.select("body").classed(y.md,!0),y.t&&(y.tl=y.tl||y.ml,y.ml=y.ls[y.ls.indexOf(y.tl)+1],y.ls.indexOf(y.dl)<y.ls.indexOf(y.tl)+1&&(y.dl=y.ml)),m.hasOwnProperty("pointsSet")&&m.pointsSet.active&&y.mr&&y.mr.hasOwnProperty("rid")&&(m.pointsSet.resourceId=y.mr.rid,y.mr.lat=y.mr.lat||"lat",y.mr.lng=y.mr.lng||"lng"),m.debug&&console.log("parameters",y),k=y.ls.indexOf(y.ml);k<y.ls.length;k++)if(t.hasOwnProperty(y.ls[k])){var z=[];for(l in v)v.hasOwnProperty(l)&&v[l].layer===y.ls[k]&&z.push(v[l]);z.length&&(u[y.ls[k]]=t[y.ls[k]],w[y.ls[k]]=z)}m.debug&&console.log("geo",u),m.debug&&console.log("data",w);var A,B,C,D,E,F,G;m.map.hasOwnProperty("bounds")&&(m.map.bounds.hasOwnProperty("init")&&(B=L.latLng(m.map.bounds.init.southWest),C=L.latLng(m.map.bounds.init.northEast),D=L.latLngBounds(B,C)),m.map.bounds.hasOwnProperty("max")&&(E=L.latLng(m.map.bounds.max.southWest),F=L.latLng(m.map.bounds.max.northEast),G=L.latLngBounds(E,F))),A=L.map("map",{maxZoom:m.map.zoom.max||null,minZoom:m.map.zoom.min||null,zoom:m.map.zoom.init||null,center:m.map.center||(D?D.getCenter():null),scrollWheelZoom:m.map.zoom.scrollWheel||!0,attributionControl:!m.map.attribution.length,maxBounds:G||null}),!m.map.zoom.init&&D&&A.fitBounds(D),m.debug&&console.log("map",A);var H=m.geoLayers.filter(function(a){return"tile"===a.type});for(m.debug&&console.log("tileLayers",H),k=0;k<H.length;k++)L.tileLayer(H[k].url.call(H[k]),H[k].options).addTo(A);A.spin(!0);var I=L.control.attribution();for(k=0;k<m.map.attribution.length;k++)I.addAttribution(m.map.attribution[k]);m.debug&&console.log("attrib",I),I.addTo(A);var J;m.hasOwnProperty("description")&&m.description.active&&"widget"!=y.md&&(m.description.position=m.description.position||"right",d3.select("body").classed("description "+m.description.position,!0),J="top"===m.description.position||"left"===m.description.position?d3.select("body").insert("div","#map"):d3.select("body").append("div"),J.attr("id","map-description").attr("class","description "+m.description.position).append("div").html(m.description.content||""));var K;m.hasOwnProperty("infowindow")&&m.infowindow.active&&("widget"===y.md?(K={},K._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info bottom").node()):m.infowindow.hasOwnProperty("position")&&"inside"!=m.infowindow.position?(K={},d3.select("body").classed("description "+m.infowindow.position,!0),"top"===m.infowindow.position||"left"===m.infowindow.position?K._div=d3.select("body").insert("div","#map").attr("id","infowindow").attr("class","info external "+m.infowindow.position).node():("right"===m.infowindow.position||"bottom"===m.infowindow.position)&&(K._div=d3.select("body").append("div").attr("id","infowindow").attr("class","info external "+m.infowindow.position).node())):(K=L.control({position:"bottomright"}),K.onAdd=function(a){return this._div=L.DomUtil.create("div","info "+y.md),this._div.setAttribute("id","infowindow"),this._div.setAttribute("style","max-height:"+(head.screen.innerHeight-100)+"px;"),d3.select(this._div).on("mouseenter",function(){a.scrollWheelZoom.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable()}),this.update(),this._div}),K.update=function(a){if(this._div.innerHTML="",a){d3.select(this._div).classed("closed",!1),"mobile"===y.md&&A.dragging.disable();var b,c,d,e=agnes.rowDelimiter(),f=new Date,g=d3.time.format("%Y%m%d")(f),h=a._layer,i=w[h].filter(function(a){return a.active})[0],j=i.id,l=a[u[h].id],n=[],o=[];if(m.infowindow.hasOwnProperty("shareButtons")&&m.infowindow.shareButtons.active&&(b=m.infowindow.shareButtons.title+("regioni"==h?" in ":" a ")+a[u[h].label],c="http://"+location.hostname+Arg.url(y).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),btnEncUrl="http://"+location.hostname+encodeURIComponent(Arg.url(y).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),d=a[u[h].label],m.infowindow.shareButtons.hasOwnProperty("twitter")&&m.infowindow.shareButtons.twitter.active&&n.push('<a class="ssb" href="http://twitter.com/share?url='+btnEncUrl+"&via="+m.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),m.infowindow.shareButtons.hasOwnProperty("facebook")&&m.infowindow.shareButtons.facebook.active&&n.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+btnEncUrl+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),m.infowindow.shareButtons.hasOwnProperty("gplus")&&m.infowindow.shareButtons.gplus.active&&n.push('<a class="ssb" href="https://plus.google.com/share?url='+btnEncUrl+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),m.infowindow.shareButtons.hasOwnProperty("linkedin")&&m.infowindow.shareButtons.linkedin.active&&n.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+btnEncUrl+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),m.infowindow.shareButtons.hasOwnProperty("email")&&m.infowindow.shareButtons.email.active&&n.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(m.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.email.body+": ")+btnEncUrl+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),m.infowindow.shareButtons.hasOwnProperty("permalink")&&m.infowindow.shareButtons.permalink.active&&n.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>')),m.debug&&console.log("shareButtons",n),m.infowindow.hasOwnProperty("downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)m.infowindow.downloads.files[k].active&&o.push('<a id="a-'+m.infowindow.downloads.files[k].name+'" class="dnl" href="#" title="'+m.infowindow.downloads.files[k].title+'"><img src="'+m.infowindow.downloads.files[k].image+'" /></a>');m.debug&&console.log("downloadButtons",o);var p="<thead><tr><th>"+(o.length?'<span id="sdnlBtn">'+o.join("&nbsp;")+"</span>&nbsp;&nbsp;":"")+(n.length?'<span id="sshrBtn">'+n.join("&nbsp;")+"</span>":"")+'</th><th style="text-align:right;"><a id="close-cross" href="#" title="Chiudi"><img src="img/close.png" /></a></th></tr><tr><th colspan="2" class="rossobc">'+a[u[h].label]+"</th></tr></thead>";m.debug&&console.log("Table header",p);var q;q=m.infowindow.hasOwnProperty("downloads")&&m.infowindow.downloads.active?'<tfoot><tr><td colspan="2" style="text-align:right;font-size: smaller;">'+(m.infowindow.downloads.license||"")+"</td></tr></tfoot>":"<tfoot></tfoot>",m.debug&&console.log("Table footer",q);var r;if(m.infowindow.hasOwnProperty("view")&&m.infowindow.view.active&&m.viewTypes.hasOwnProperty(m.infowindow.view.type)?(r=m.viewTypes[m.infowindow.view.type](a.data[i.name],m.infowindow.view.options,i.formatter),r.indexOf("<tbody>")>-1||(r="<tbody>"+r+"</tbody>")):r="<tbody></tbody>",m.debug&&console.log("Table body",r),this._div.innerHTML+='<table class="zebra">'+p+r+q+"</table>",m.debug&&console.log("Table",this._div.innerHTML),m.infowindow.hasOwnProperty("shareButtons")&&m.infowindow.shareButtons.active&&m.hasOwnProperty("urlShortener")&&m.urlShortener.active&&s.shorten(btnEncUrl,m.urlShortener.prefix+md5(c),function(a){var e=a.shorturl,f=[];m.infowindow.shareButtons.hasOwnProperty("twitter")&&m.infowindow.shareButtons.twitter.active&&f.push('<a class="ssb" href="http://twitter.com/share?url='+e+"&via="+m.infowindow.shareButtons.twitter.via+"&text="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.twitter.text+" ")+'" target="_blank" title="'+b+' su Twitter"><img src="img/twitter.png" id="ssb-twitter"></a>'),m.infowindow.shareButtons.hasOwnProperty("facebook")&&m.infowindow.shareButtons.facebook.active&&f.push('<a class="ssb" href="http://www.facebook.com/sharer.php?u='+e+'" target="_blank" title="'+b+' su Facebook"><img src="img/facebook.png" id="ssb-facebook"></a>'),m.infowindow.shareButtons.hasOwnProperty("gplus")&&m.infowindow.shareButtons.gplus.active&&f.push('<a class="ssb" href="https://plus.google.com/share?url='+e+'" target="_blank" title="'+b+' su Google Plus"><img src="img/gplus.png" id="ssb-gplus"></a>'),m.infowindow.shareButtons.hasOwnProperty("linkedin")&&m.infowindow.shareButtons.linkedin.active&&f.push('<a class="ssb" href="http://www.linkedin.com/shareArticle?mini=true&url='+e+'" target="_blank" title="'+b+' su LinkedIn"><img src="img/linkedin.png" id="ssb-linkedin"></a>'),m.infowindow.shareButtons.hasOwnProperty("email")&&m.infowindow.shareButtons.email.active&&f.push('<a class="ssb" href="mailto:?Subject='+encodeURIComponent(m.infowindow.shareButtons.email.subject+" | "+d)+"&Body="+encodeURIComponent(d+" - "+m.infowindow.shareButtons.email.body+": ")+e+'" target="_blank" title="'+b+' per email"><img src="img/email.png" id="ssb-email"></a>'),m.infowindow.shareButtons.hasOwnProperty("permalink")&&m.infowindow.shareButtons.permalink.active&&f.push('<a class="ssb" href="'+c+'" target="_blank" title="Permalink"><img src="img/link.png" id="ssb-link"></a>'),d3.select("#sshrBtn").node().innerHTML=f.join("&nbsp;")}),m.infowindow.hasOwnProperty("downloads")&&m.infowindow.downloads.active)for(k=0;k<m.infowindow.downloads.files.length;k++)m.infowindow.downloads.files[k].active&&!function(a){var b=m.infowindow.downloads.files[a].url.call(m.infowindow.downloads.files[a],h,j,l),c=g+"_"+m.infowindow.downloads.files[a].filebase+"-"+m.infowindow.downloads.files[a].name+(j&&l?"_"+j+"-"+l:"")+".csv";d3.select("a#a-"+m.infowindow.downloads.files[a].name).on("click",function(){m.debug&&console.log(this,a,m.infowindow.downloads.files[a].name,b,c),d3[m.infowindow.downloads.files[a].format](b,function(b,d){var f=m.infowindow.downloads.files[a].transform(d);if(f.length>0){var g=agnes.jsonToCsv(f,e),h=new Blob([g],{type:"text/csv;charset=utf-8"});saveAs(h,c)}else alert("No data!")})})}(k);d3.select(this._div).select("a#close-cross").on("click",function(){return m.debug&&console.log("clickCloseCross",arguments),ab.eachLayer(function(a){a.selected=!1,ab.resetStyle(a)}),delete y.i,Q&&Q.isAdded&&Q.removeFrom(A),K.update(),A.scrollWheelZoom.enable(),!1})}else d3.select(this._div).classed("closed",!0),"mobile"===y.md?(A.dragging.enable(),this._div.innerHTML+=m.infowindow.content.mobile):this._div.innerHTML+=m.infowindow.content.default},"widget"===y.md||m.infowindow.hasOwnProperty("position")&&"inside"!=m.infowindow.position?K.update():K.addTo(A)),m.debug&&console.log("info",K);var M;m.controls.hasOwnProperty("fullscreen")&&m.controls.fullscreen.active&&"widget"!=y.md&&"embed"!=y.md&&(M=L.control.fullscreen({title:m.controls.fullscreen.title}).addTo(A)),m.debug&&console.log("fullscreen",M);var N;m.controls.hasOwnProperty("logo")&&m.controls.logo.active&&("widget"===y.md?N=d3.select("body").insert("div","#map").attr("id","logo-widget").append("a").classed("logo "+y.md,!0).attr("href",m.controls.logo.link||"#").attr("target","_blank").append("img").attr("id","logo").attr("src",m.controls.logo.image):(N=L.control({position:"topleft"}),N.onAdd=function(){var a=L.DomUtil.create("a","logo "+y.md),b=L.DomUtil.create("img","logo"+(m.controls.logo.border?" border":""),a);return a.setAttribute("href",m.controls.logo.link||"#"),a.setAttribute("target","_blank"),b.setAttribute("id","logo"),b.setAttribute("src",m.controls.logo.image),a},N.addTo(A))),m.debug&&console.log("logo",N);var O;m.controls.hasOwnProperty("reset")&&m.controls.reset.active&&(O=L.control({position:"mobile"===y.md?"bottomleft":"topright"}),O.onAdd=function(a){var b=L.DomUtil.create("img","reset "+y.md);return b.setAttribute("src",m.controls.reset.image),b.setAttribute("title",m.controls.reset.title),d3.select(b).on("click",function(){i(y.ml),a.fitBounds(D)}),b},O.addTo(A)),m.debug&&console.log("reset",O);var P,Q;m.controls.hasOwnProperty("embed")&&m.controls.embed.active&&(Q=L.control({position:"mobile"===y.md?"bottomleft":"topright"}),Q.isAdded=!1,Q.onRemove=function(){this.isAdded=!1},Q.onAdd=function(){this.isAdded=!0;var a={},b=L.DomUtil.create("div","info embed-inputarea"),c="http://"+location.hostname+Arg.url(y).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"),d="http://"+location.hostname+encodeURIComponent(Arg.url(y).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"));m.controls.embed.permalink&&(a.permalink=L.DomUtil.create("p","permalink",b),a.permalink.innerHTML='<label for="embed-permalink" title="Clicca per selezionare">Permalink:</label>&nbsp;<input type="text" id="embed-permalink" value="'+c+'" readonly></input>'),m.hasOwnProperty("urlShortener")&&m.urlShortener.active&&m.controls.embed.shorturl&&(a.shorturl=L.DomUtil.create("p","shorturl",b),a.shorturl.innerHTML='<label for="embed-shorturl" title="Clicca per selezionare">Short URL:</label>&nbsp;<input type="text" id="embed-shorturl" value="Not available..." disabled readonly></input>',s.shorten(d,m.urlShortener.prefix+md5(c),function(a){d3.select("input#embed-shorturl").attr("value",a.shorturl).attr("disabled",null)})),m.controls.embed.iframe&&(a.iframe=L.DomUtil.create("p","iframe",b),a.iframe.innerHTML='<label for="embed-iframe" title="Clicca per selezionare">Embed in post/page:</label>&nbsp;<input type="text" id="embed-iframe" value="<iframe src=&quot;'+c+'&md=embed&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;700&quot;></iframe>" readonly></input>'),m.controls.embed.widget&&(a.widget=L.DomUtil.create("p","widget",b),a.widget.innerHTML='<label for="embed-widget" title="Clicca per selezionare">Embed in sidebar:</label>&nbsp;<input type="text" id="embed-widget" value="<iframe src=&quot;'+c+'&md=widget&quot; frameborder=&quot;0&quot; allowtransparency=&quot;true&quot; allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen width=&quot;100%&quot; height=&quot;755&quot;></iframe>" readonly></input>'),m.controls.embed.shortcode&&(a.shortcode=L.DomUtil.create("p","shortcode",b),a.shortcode.innerHTML='<label for="embed-shortcode" title="Clicca per selezionare">WP Shortcode (<a href="https://github.com/Dataninja/wp-cbmap-shortcode" target="_blank">?</a>):</label>&nbsp;<input type="text" id="embed-shortcode" value="[cbmap '+decodeURIComponent(c).replace(/^[^?]+\?/,"").replace(/&/g," ")+' md=embed]" readonly></input>'),m.controls.embed.hasOwnProperty("svg")&&m.controls.embed.svg.active&&(a.svg=L.DomUtil.create("p","svg",b),a.svg.innerHTML='<label for="embed-svg" title="Copia/incolla il codice o scaricalo cliccando sull\'immagine">Scalable Vector Graphics:</label>&nbsp;<textarea id="embed-svg" readonly>'+d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")+'</textarea>&nbsp;<img src="'+m.controls.embed.svg.image+'" title="Scarica l\'immagine in SVG">',d3.select(a.svg).select("img").on("click",function(){var a=new Blob([d3.select(".leaflet-overlay-pane")[0][0].innerHTML.replace(/\>/g,">\n")],{type:"image/svg+xml;charset=utf-8"});saveAs(a,m.controls.embed.svg.filename)}));for(var e in a)a.hasOwnProperty(e)&&d3.select(a[e]).select("input").on("focus",function(){this.select()});return b},P=L.control({position:"mobile"===y.md?"bottomleft":"topright"}),P.onAdd=function(a){var b=L.DomUtil.create("img","embed "+y.md);return b.setAttribute("src",m.controls.embed.image),b.setAttribute("title",m.controls.embed.title),d3.select(b).on("click",function(){Q.isAdded?Q&&Q.isAdded&&Q.removeFrom(a):Q.addTo(a)}),b},P.addTo(A)),m.debug&&console.log("embed",P);var R;m.controls.hasOwnProperty("screenshot")&&m.controls.screenshot.active&&"widget"!=y.md&&(R=L.control({position:"mobile"===y.md?"bottomleft":"topright"}),R.onAdd=function(){var a=L.DomUtil.create("img","screenshot "+y.md);return a.setAttribute("id","screenshot"),a.setAttribute("src",m.controls.screenshot.image),a.setAttribute("title",m.controls.screenshot.title),d3.select(a).on("click",function(){html2canvas(document.body,{onrendered:function(a){var b=d3.select(".leaflet-overlay-pane svg"),c=m.controls.screenshot.offsetX||"auto",d=m.controls.screenshot.offsetY||"auto";canvg(a,b.node().outerHTML,{ignoreMouse:m.controls.screenshot.ignoreMouse||!0,ignoreAnimation:m.controls.screenshot.ignoreAnimation||!0,ignoreDimensions:m.controls.screenshot.ignoreDimensions||!0,ignoreClear:m.controls.screenshot.ignoreClear||!0,offsetX:"number"==typeof c?c:j[0],offsetY:"number"==typeof d?d:j[1]}),a.toBlob(function(a){saveAs(a,m.controls.screenshot.filename)})}})}),a},R.addTo(A)),m.debug&&console.log("screenshot",R);var S;m.controls.hasOwnProperty("detach")&&m.controls.detach.active&&("embed"===y.md||"widget"===y.md)&&(S=L.control({position:"topright"}),S.onAdd=function(){var a=L.DomUtil.create("a","detach "+y.md),b=L.DomUtil.create("img","detach",a);return a.setAttribute("href",Arg.url(y).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&")),a.setAttribute("target","_blank"),a.setAttribute("title",m.controls.detach.title),b.setAttribute("id","detach"),b.setAttribute("src",m.controls.detach.image),d3.select(a).on("click",function(){this.setAttribute("href",Arg.url(y).replace(/&*md=[^&]*/,"").replace(/&{2,}/g,"&"))}),a},S.addTo(A)),m.debug&&console.log("detach",S);var T;m.controls.hasOwnProperty("socialButtons")&&m.controls.socialButtons.active&&(y.md||(T=L.control({position:"bottomleft"}),T.onAdd=function(){var a=L.DomUtil.create("div","share "+y.md),b="",c="",d="";return a.setAttribute("id","buttons"),a.innerHTML="",m.controls.socialButtons.hasOwnProperty("twitter")&&m.controls.socialButtons.twitter.active&&(b='<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://'+location.hostname+location.pathname+'" data-via="'+m.controls.socialButtons.twitter.via+'" data-lang="'+m.controls.socialButtons.twitter.lang+'" data-related="'+m.controls.socialButtons.twitter.related+'" data-hashtags="'+m.controls.socialButtons.twitter.hashtags+'" data-count="'+m.controls.socialButtons.twitter.count+'">'+m.controls.socialButtons.twitter.text+"</a>",a.innerHTML+=b,head.load("https://platform.twitter.com/widgets.js")),m.controls.socialButtons.hasOwnProperty("facebook")&&m.controls.socialButtons.facebook.active&&(c='<div class="fb-like" style="overflow:hidden;" data-href="http://'+location.hostname+location.pathname+'" data-layout="'+m.controls.socialButtons.facebook.layout+'" data-action="'+m.controls.socialButtons.facebook.action+'" data-show-faces="'+m.controls.socialButtons.facebook["show-faces"].toString()+'" data-share="'+m.controls.socialButtons.facebook.share.toString()+'"></div>',a.innerHTML+=c,head.load("http://connect.facebook.net/it_IT/sdk.js#xfbml=1&appId="+m.controls.socialButtons.facebook.appId+"&version=v2.0")),m.controls.socialButtons.hasOwnProperty("gplus")&&m.controls.socialButtons.gplus.active&&(d='<div class="g-plusone" data-size="'+m.controls.socialButtons.gplus.size+'" data-href="http://'+location.hostname+location.pathname+'" data-annotation="'+m.controls.socialButtons.gplus.annotation+'"></div>',a.innerHTML+=d,head.load("https://apis.google.com/js/plusone.js")),a},T.addTo(A))),m.debug&&console.log("share",T);var U,V=m.geoLayers.filter(function(a){return"tile"!=a.type});V.length>1&&(U=L.control({position:"topleft"}),U.onAdd=function(){var a=L.DomUtil.create("nav","menu-ui "+y.md);return a.setAttribute("id","geomenu-ui"),"widget"===y.md&&a.setAttribute("style","display:none;"),a},U.addTo(A),d3.select("nav#geomenu-ui").selectAll("a").data(V.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).classed("disabled",function(a){return!u.hasOwnProperty(a.name)}).on("click",function(a,b){if(u.hasOwnProperty(a.name)){var c=a.name;w[c][0].active=!0;for(var b=0;b<w[c].length;b++)0!=b&&(w[c][b].active=!1);delete y.i,Q&&Q.isAdded&&Q.removeFrom(A),K.update(),$.update(),W.update(a.name),W.onChange(a.name),i(a.name)}}).text(function(a){return a.menu})),m.debug&&console.log("menuGeoLayers",V),m.debug&&console.log("geoMenu",U);var W=L.control({position:"topleft"});W.onAdd=function(a){var b=L.DomUtil.create("nav","menu-ui "+y.md);return b.setAttribute("id","datamenu-ui"),"widget"===y.md&&b.setAttribute("style","display:none;"),this._nav=b,d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},W.onChange=function(a,b){d3.select(this._nav).select("select").remove();var b=b||0,c=w[a][b].values;c&&c.length>1&&d3.select(this._nav).append("select").attr("disabled","disabled").on("change",function(){var c=d3.select(this).property("selectedIndex"),d=d3.select(this).selectAll("option")[0][c].__data__;w[a][b].value=d,w[a][b].label=w[a][b].labels[c],w[a][b].description=w[a][b].descriptions[c],i(a,w[a][b].name)}).selectAll("option").data(c).enter().append("option").text(function(a){return a})},W.update=function(a){if(d3.select(this._nav).style("display",null).selectAll("a, select").remove(),a){var b=m.dataSets.filter(function(b){return b.schema.layer===a});b.length>1?d3.select(this._nav).selectAll("a").data(b.map(function(a){return a.schema})).enter().append("a").attr("href","#").attr("id",function(a){return a.name}).on("click",function(a,b){var c=a.layer;w[c][b].active=!0;for(var d=0;d<w[c].length;d++)d!=b&&(w[c][d].active=!1);delete y.i,Q&&Q.isAdded&&Q.removeFrom(A),K.update(),$.update(),W.onChange(c,b),i(c,a.name)}).text(function(a){return a.menu}):d3.select(this._nav).style("display","none")}},W.addTo(A),W.update(V[0].schema.name),W.onChange(V[0].schema.name),m.debug&&console.log("dataMenu",W);var X;if(m.controls.hasOwnProperty("geocoder")&&m.controls.geocoder.active&&"widget"!=y.md&&"mobile"!=y.md&&(X=new L.Control.OSMGeocoder({collapsed:m.controls.geocoder.collapsed,position:"topleft",text:m.controls.geocoder.title,bounds:D,email:m.controls.geocoder.email,callback:function(a){if(a.length){var b=a[0].boundingbox,c=new L.LatLng(b[0],b[2]),d=new L.LatLng(b[1],b[3]),e=new L.LatLngBounds([c,d]);delete y.i,Q&&Q.isAdded&&Q.removeFrom(A),K.update(),i(m.controls.geocoder.layer),this._map.fitBounds(e,{maxZoom:m.controls.geocoder.zoom})}}}),A.addControl(X),m.controls.geocoder.hasOwnProperty("autocomplete")&&m.controls.geocoder.autocomplete.active)){X._completely=completely(X._input),X._completely.onChange=function(a){X._completely.startFrom=a.lastIndexOf(" ")+1,X._completely.repaint()},X._completely.input.maxLength=50;var Y=m.controls.geocoder.autocomplete.url.call(m.controls.geocoder.autocomplete,y.t||void 0);d3[m.controls.geocoder.autocomplete.format](Y,function(a,b){t[m.controls.geocoder.layer].list=m.controls.geocoder.autocomplete.transform(b),X._completely.options=t[m.controls.geocoder.layer].list.map(function(a){return a[u[m.controls.geocoder.layer].label]
})})}m.debug&&console.log("osmGeocoder",X);var Z;m.debug&&(Z=L.control({position:"bottomleft"}),Z.onAdd=function(a){var b=L.DomUtil.create("div","devutil");return d3.select(b).append("p").attr("id","devutil-coord").text("Mouse position: ..."),d3.select(b).append("p").attr("id","devutil-sw").text("SouthWest bound: "+a.getBounds().getSouthWest().toString()),d3.select(b).append("p").attr("id","devutil-ne").text("NorthEast bound: "+a.getBounds().getNorthEast().toString()),d3.select(b).append("p").attr("id","devutil-center").text("Map center: "+a.getCenter().toString()),d3.select(b).append("p").attr("id","devutil-zoom").text("Zoom level: "+a.getZoom()),d3.select(b).on("mouseenter",function(){a.scrollWheelZoom.disable(),a.doubleClickZoom.disable(),a.dragging.disable()}).on("mouseleave",function(){a.scrollWheelZoom.enable(),a.doubleClickZoom.enable(),a.dragging.enable()}),b},Z.addTo(A),A.on("mousemove",function(a){d3.select("#devutil-coord").text("Mouse position: "+a.latlng.toString())}).on("move",function(){d3.select("#devutil-sw").text("SouthWest bound: "+A.getBounds().getSouthWest().toString()),d3.select("#devutil-ne").text("NorthEast bound: "+A.getBounds().getNorthEast().toString()),d3.select("#devutil-center").text("Map center: "+A.getCenter().toString())}).on("zoomend",function(){d3.select("#devutil-zoom").text("Zoom level: "+A.getZoom())}));var $;if(m.hasOwnProperty("legend")&&m.legend.active&&($=L.control({position:"bottomleft"}),$.onAdd=function(){return this._div=L.DomUtil.create("div","info legend "+y.md),this._div},$.update=function(a){if(a){var b=w[a].filter(function(a){return a.active})[0],c=b.ranges.map(function(a){return a.split(" - ").map(function(a){var c=parseFloat(a);return b.formatter(b.value,c)?d3.format(b.formatter(b.value,c))(c):d3.format(",d")(c)||d3.format(",.2f")(c)||c}).join(" - ")}),d=b.description||m.legend.description||"";this._div.innerHTML="widget"!=y.md?'<h4 title="'+d+'">'+m.legend.title+"</h4>":"";for(var e=0;e<c.length;e++){var f=colorbrewer[b.palette][c.length]?colorbrewer[b.palette][c.length][e]:colorbrewer[b.palette][3][e];this._div.innerHTML+='<i title="'+(m.legend.hasOwnProperty("label")?m.legend.label(c[e].split(" - ")[0],c[e].split(" - ")[1],b.label):c[e])+'" style="background:'+f+'"></i> '+("widget"!=y.md?c[e]:"")+"<br>"}"widget"!=y.md&&(this._div.innerHTML+="<br>"+d)}else this._div.innerHTML="widget"!=y.md?"<h4>"+m.legend.title+"</h4>":""},$.addTo(A),$.update()),m.debug&&console.log("legend",$),m.pointsSet&&m.pointsSet.active&&m.pointsSet.resourceId){var _=m.pointsSet.url.call(m.pointsSet);m.debug&&console.log("markersPath",_),d3[m.pointsSet.format](_,function(a,b){m.debug&&console.log("markers",arguments);var c=b?m.pointsSet.transform(b):null;if(c){for(var d=new L.MarkerClusterGroup({showCoverageOnHover:!1}),e=[],f=0;f<c.length;f++){var g=L.marker();g.setIcon(L.icon({iconUrl:m.pointsSet.icon,shadowUrl:m.pointsSet.shadow})),g.setLatLng(L.latLng(c[f][y.mr.lat],c[f][y.mr.lng])),y.mr.hasOwnProperty("iw")&&g.bindPopup(c[f][y.mr.iw]),e.push(g),d.addLayer(g)}A.addLayer(m.pointsSet.clusters?d:L.layerGroup(e))}})}var ab,bb=new L.Label;ab=L.geoJson("",{style:b,onEachFeature:f}).addTo(A),m.debug&&console.log("geojson",ab),setTimeout(function(){A.spin(!1),i(y.dl)},3e3)})}(mapConfig);